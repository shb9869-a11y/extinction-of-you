<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera + Stream Composite</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  html,body{
    margin:0;
    height:100%;
    background:#000;
    overflow:hidden;
  }
  #camCanvas{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    background:#000;
  }
</style>
</head>
<body>
<canvas id="camCanvas"></canvas>

<script>
(async ()=>{
  // ✅ Cloudflare HLS Manifest URL
  const STREAM_URL = "https://customer-e1rhmg8edq32stcl.cloudflarestream.com/0561f69cdb850354620ce2f93cbb05ce/manifest/video.m3u8";

  const camCanvas = document.getElementById('camCanvas');
  const ctx = camCanvas.getContext('2d');

  const hiddenCam = document.createElement('video'); // 관객 카메라
  hiddenCam.autoplay = true;
  hiddenCam.playsinline = true;
  hiddenCam.muted = true;

  const streamEl = document.createElement('video'); // Cloudflare 스트림
  streamEl.autoplay = true;
  streamEl.playsinline = true;
  streamEl.muted = true;

  // 캔버스 리사이즈
  function resizeCanvas(){
    camCanvas.width = window.innerWidth;
    camCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // 관객 카메라 시작
  try {
    const camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }, audio:false
    });
    hiddenCam.srcObject = camStream;
  } catch(e){ console.error("카메라 실패:", e); }

  // 스트림 붙이기
  if (streamEl.canPlayType('application/vnd.apple.mpegurl')) {
    streamEl.src = STREAM_URL; // iOS Safari
    streamEl.play().catch(()=>{});
  } else if (window.Hls && Hls.isSupported()) {
    const hls = new Hls({lowLatencyMode:true});
    hls.loadSource(STREAM_URL);
    hls.attachMedia(streamEl);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=> streamEl.play().catch(()=>{}));
  } else {
    streamEl.src = STREAM_URL;
    streamEl.play().catch(()=>{});
  }

  // 드로잉 루프: 카메라(흑백+잔상) + 스트림 합성
  function drawLoop(){
    requestAnimationFrame(drawLoop);

    // 잔상 효과
    ctx.fillStyle = "rgba(0,0,0,0.05)";
    ctx.fillRect(0,0,camCanvas.width,camCanvas.height);

    // 카메라 (흑백 처리)
    if(hiddenCam.readyState >= 2){
      ctx.save();
      ctx.filter = "grayscale(100%)";
      ctx.drawImage(hiddenCam, 0,0,camCanvas.width,camCanvas.height);
      ctx.restore();
    }

    // 스트림 (투명도 합성)
    if(streamEl.readyState >= 2){
      ctx.globalAlpha = 0.7; // 스트림 투명도 (0~1 조절)
      ctx.drawImage(streamEl, 0,0,camCanvas.width,camCanvas.height);
      ctx.globalAlpha = 1;
    }
  }
  drawLoop();

})();
</script>
</body>
</html>
