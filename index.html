<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --frame: clamp(16px, 4vmin, 40px);
    --ui-gap: 8px;

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);

    --pad-btn-y: clamp(6px, 1.1vmin, 10px);
    --pad-btn-x: clamp(10px, 1.8vmin, 20px);

    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  body{font-family:Impact,"Anton","Arial Black",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;}
  .fade{opacity:0; transition:opacity 2s ease}
  .fade.show{opacity:1}

  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  .frameBox{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    right:calc(var(--frame) + var(--safe-r));
    bottom:calc(var(--frame) + var(--safe-b));
    border:2px solid rgba(255,255,255,.22); pointer-events:none; z-index:50;
  }

  .uiBtn{background:#000;color:#fff;border:1px solid #444;font-size:var(--fs-strong);
    padding:var(--pad-btn-y) var(--pad-btn-x);font-family:"Courier New",ui-monospace,monospace;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}
  .uiBtn.flat{border:none;background:transparent;text-decoration:none}
  .uiBtn[disabled]{opacity:.35;pointer-events:none;filter:grayscale(1)}
  .hide{display:none !important;}

  .controls{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-family:"Courier New",ui-monospace,monospace;font-size:var(--fs-small);color:#ddd}
  .btn-capture{
    position:fixed;
    left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:150}

  #mapLauncher{
    position:fixed; right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}
  #docLauncher{
    position:fixed; left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}

  body.boot #docLauncher,
  body.boot #mapLauncher,
  body.boot .controls,
  body.boot #captureBtn{ display:none !important; }

  /* 8분 타이머 */
  #runTimer{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r) + 62px);
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t) + 2px);
    z-index:181;
    font-family:"Courier New",ui-monospace,monospace;
    font-size:var(--fs-strong);
    color:#fff; opacity:.95;
    pointer-events:none; user-select:none; display:none;
  }

  .credits{ font-family:"Courier New",ui-monospace,monospace; letter-spacing:.08em; }

  /* 권한 게이트 */
  #overlay{
    position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;
    padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
    color:#fff;background:rgba(0,0,0,.85)
  }
  #overlayContent{max-width:min(92vw, 72ch);font-family:"Courier New",ui-monospace,monospace;line-height:1.7;text-align:center}

  /* 이름 입력 */
  #nameOverlay{position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.85); color:#fff;}
  #nameCard{ width:min(92vw,600px); text-align:center; font-family:"Courier New",ui-monospace,monospace; }
  #nameCard h2{ margin:0 0 12px 0; letter-spacing:.08em; font-size:clamp(16px,3.2vmin,24px); }
  #nick{ width:100%; padding:12px 14px; background:#000; border:1px solid #555; color:#fff; font-size:clamp(16px,3.2vmin,22px); outline:none; }
  #nameRow{ display:flex; gap:10px; margin-top:12px; justify-content:center; }
  #nameRow .uiBtn{ padding:10px 14px; }

  /* 프리셋 (screensaver) */
  #preset{position:fixed;inset:0;z-index:250;background:#000;display:none;cursor:pointer}
  #presetCanvas{position:absolute;left:0;top:0;width:100%;height:100%}

  /* WELCOME */
  #overlayWelcome{
    position:fixed;inset:0;z-index:220;display:none;align-items:center;justify-content:center;color:#fff;background:rgba(0,0,0,.55);
    padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;}
  #welcomeCard{ text-align:center; max-width:min(92vw, 900px); }
  #welcomeCard .title{ font-size:clamp(32px, 12vmin, 120px); font-weight:900; letter-spacing:.04em; line-height:1.02; margin-bottom:16px; text-transform:uppercase; }

  /* INTRO — 카메라 위에 반투명 */
  #introOverlay{
    position:fixed; inset:0; z-index:230; display:none;
    align-items:flex-start; justify-content:center;
    color:#fff; background:rgba(0,0,0,.35);
    padding:calc(24px + var(--safe-t)) calc(16px + var(--safe-r)) calc(20px + var(--safe-b)) calc(16px + var(--safe-l));
    font-family:"Courier New",ui-monospace,monospace;
    overflow-y:auto; -webkit-overflow-scrolling:touch;
  }
  #introBox{ width:min(92vw, 860px); margin:0 auto; }
  #introBox h2{margin:.2em 0 .6em 0; font-size:clamp(18px, 3.6vmin, 26px); letter-spacing:.1em; text-align:center;}
  #introBox p{font-size:var(--fs-body); line-height:1.85; text-align:center; text-shadow:0 1px 2px rgba(0,0,0,.6);}
  #introBox ol{padding-left:1.2em; margin:.4em 0 1.2em 0; text-align:left;}
  #introBox li{font-size:var(--fs-body); line-height:1.85; text-shadow:0 1px 2px rgba(0,0,0,.6);}
  #introCount{ text-align:center; font-size:var(--fs-strong); margin-top:12px; }

  /* 타이틀 / GOOD NIGHT */
  #titleScreen{
    position:fixed; inset:0; z-index:240; display:none; align-items:center; justify-content:center;
    background:#000; color:#fff; text-align:center;
  }
  #titleText{font-weight:900; letter-spacing:.06em; line-height:1.05; font-size:clamp(24px, 10vmin, 96px); text-transform:uppercase;}

  /* FIRST SLEEP: 카메라 위 오버레이 (UI에 영향 없음) */
  #firstSleep{ position:fixed; inset:0; z-index:235; display:none; align-items:center; justify-content:center; pointer-events:none; }
  #firstSleepText{ color:#fff; font-weight:900; letter-spacing:.06em; font-size:clamp(28px, 11vmin, 110px); text-transform:uppercase; }
</style>
</head>
<body class="boot">
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <div class="controls">
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>
  <button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>

  <button id="docLauncher" class="uiBtn small">DOCUMENT</button>
  <button id="mapLauncher" class="uiBtn small">MAP</button>
  <div id="runTimer" aria-live="polite">08:00</div>

  <!-- 권한 게이트 -->
  <div id="overlay" class="fade show">
    <div id="overlayContent">
      <div class="credits" style="margin-bottom:10px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="uiBtn" type="button">화면을 탭하여 카메라·동작(센서)을 허용해주세요</button>
      <div class="tip" style="opacity:.7;margin-top:6px">허용 후 이름 입력 화면으로 이동합니다.</div>
    </div>
  </div>

  <!-- 이름 입력 -->
  <div id="nameOverlay" class="fade">
    <div id="nameCard">
      <h2>TELL ME YOUR NAME</h2>
      <input id="nick" type="text" maxlength="24" placeholder="닉네임을 입력하세요" autocomplete="off" />
      <div id="nameRow">
        <button id="nameSubmit" class="uiBtn" type="button">GO</button>
      </div>
    </div>
  </div>

  <!-- 프리셋 -->
  <div id="preset" class="fade" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <!-- WELCOME -->
  <div id="overlayWelcome" class="fade">
    <div id="welcomeCard">
      <div class="credits" style="margin-bottom:12px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div class="title">Welcome to SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</div>
      <button id="goIntro" class="uiBtn flat" type="button">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- INTRO -->
  <div id="introOverlay" class="fade"><div id="introBox">
    <h2>INTRODUCTION</h2>
    <p>지금 이 화면을 보고 있는 당신,</p>
    <p>주변의 소리에 천천히 귀를 기울이며 공간을 거닐기 시작합니다.</p>
    <p>지금부터 당신은 약 30분 간, 짧은 단잠에 들게 됩니다.</p>
    <ol>
      <li>당신이 거닐고 있는 이곳의 세계관 설명입니다.</li>
      <li>우리는 언제나 타자와 함께 존재해왔습니다. 친구, 엄마, 누나, 아버지, 지나가는 저 사람과 같이 말이죠.</li>
      <li>그러나 어느 순간, ‘너’로 존재했던 그들은 ‘너’가 아닌 ‘그것’으로 전락하기 시작했습니다.</li>
      <li>이제는 그 어느곳에서도 ‘너’를 찾아볼 수는 없습니다.</li>
      <li>‘그것’으로 전락한 ‘너’들은 서서히 우리의 내면 속에서 희미해져 가고 있기 때문이죠.</li>
      <li>마치 꿈 속에서 분명 누군가를 만난 것 같은데, 그게 누구인지 떠오르지 않는 것처럼.</li>
      <li>네, 그렇습니다. 이곳은 바로, 그 ‘너’가 사라져버린, ‘너’를 제거해버린, 누군가의 내면 세계입니다.</li>
    </ol>
    <p>당신의 의식이 서서히 희미해져가는 지금, 두 번의 심호흡을 크게 한 후,</p>
    <p>이 내면의 미로를 거닐며, 천천히 눈을 감고,</p>
    <p>이 세상에서 사라져버린 ‘너’의 이야기에 귀를 기울입니다.</p>
    <div id="introCount" aria-live="polite"></div>
    <div style="height:12vh"></div>
  </div></div>

  <!-- 타이틀/전환 -->
  <div id="titleScreen"><div id="titleText"></div></div>
  <div id="firstSleep"><div id="firstSleepText">THE FIRST SLEEP</div></div>

  <!-- DOC -->
  <div id="docOverlay" style="display:none">
    <div id="docUI">
      <div id="docHeader">
        <div class="readout">DOCUMENTS</div>
        <div><button id="btnExitDoc" class="uiBtn small" type="button">EXIT</button></div>
      </div>
      <div id="docGrid"></div>
      <div id="docPane" class="docPane" style="display:none">
        <div class="docTitle" id="docTitle" style="font-size:var(--fs-strong);margin-bottom:8px;">Document</div>
        <div id="docBody">준비중입니다.</div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="mapOverlay" style="display:none">
    <div id="mapUI">
      <h3>MAP</h3>
      <p style="opacity:.85">지금은 준비 중입니다. (게임 모듈 비활성화)</p>
      <button id="btnExitMap" class="uiBtn small" type="button" style="margin-top:10px">EXIT</button>
    </div>
  </div>

<script>
(() => {
  // Manifest
  (function injectManifest(){
    const manifest = {"name":"SLEEEEEP","short_name":"SLEEEEEP","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  // helpers
  function fadeShow(el, dur=2000, display='flex'){ el.style.display=display; el.style.opacity='0'; el.style.transition=`opacity ${dur}ms ease`; requestAnimationFrame(()=>el.style.opacity='1'); }
  function fadeHide(el, dur=2000){ el.style.transition=`opacity ${dur}ms ease`; el.style.opacity='0'; setTimeout(()=>{ el.style.display='none'; }, dur); }
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  // App height
  function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppH(); addEventListener('resize', setAppH, {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppH,50)); }

  const qs = s => document.querySelector(s);

  // Refs
  const overlay = qs('#overlay');
  const permBtn = qs('#permGateBtn');

  const nameOverlay = qs('#nameOverlay');
  const nickInput = qs('#nick');
  const nameSubmit = qs('#nameSubmit');

  const preset = qs('#preset');
  const presetCanvas = qs('#presetCanvas');

  const welcome = qs('#overlayWelcome');
  const goIntroBtn = qs('#goIntro');

  const intro = qs('#introOverlay');
  const introBox = qs('#introBox');
  const introCount = qs('#introCount');

  const titleScreen = qs('#titleScreen');
  const titleText = qs('#titleText');
  const firstSleep = qs('#firstSleep');

  const docBtn = qs('#docLauncher');
  const mapBtn = qs('#mapLauncher');
  const zoomIn = qs('#zoomIn');
  const zoomOut = qs('#zoomOut');
  const zoomVal = qs('#zoomVal');
  const captureBtn = qs('#captureBtn');

  const docOverlay = qs('#docOverlay');
  const btnExitDoc = qs('#btnExitDoc');
  const docGrid = qs('#docGrid');
  const docPane = qs('#docPane');
  const docTitle = qs('#docTitle');
  const docBody = qs('#docBody');

  const mapOverlay = qs('#mapOverlay');
  const btnExitMap = qs('#btnExitMap');

  const frameBox = qs('.frameBox');
  const view = qs('#view');
  const runTimer = qs('#runTimer');

  // State
  let camPermGranted = false;
  let camStream = null, camVideo = null, vctx = null, proc = null, pctx = null, ZOOM = 1.0;
  let animStarted = false;

  // === 오디오 ===
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

  function beep(freq=880, dur=0.07, gain=0.05, type='square'){
    try{
      ensureAudio();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur*0.9);
      o.stop(audioCtx.currentTime + dur);
    }catch(e){}
  }
  function playClick(){ beep(880, .07, .04, 'square'); }
  function wireButtonClicks(){ document.querySelectorAll('.uiBtn').forEach(btn=>btn.addEventListener('click', playClick, {passive:true})); }

  // 프리셋 드론
  function startScreensaverHum(){
    try{
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(110, audioCtx.currentTime);
      g.gain.value=0.015;
      const lfo = audioCtx.createOscillator(); const lfoG = audioCtx.createGain();
      lfo.type='sine'; lfo.frequency.value=0.2; lfoG.gain.value=25;
      lfo.connect(lfoG); lfoG.connect(o.frequency);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); lfo.start();
      setTimeout(()=>{ g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1); o.stop(audioCtx.currentTime+1.1); lfo.stop(audioCtx.currentTime+1.1); }, 20000);
    }catch(e){}
  }
  // 번개/스팅 + 스웰
  async function thunder(){
    try{
      ensureAudio();
      beep(600,.04,.12,'square'); await sleep(40);
      beep(1200,.03,.09,'square'); await sleep(30);
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.value=50; g.gain.value=0.08;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.2);
      o.stop(audioCtx.currentTime + 1.25);
    }catch(e){}
  }
  function swell(){
    try{
      ensureAudio();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.value=220; g.gain.value=0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.06, audioCtx.currentTime + 0.5);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 2.0);
      setTimeout(()=>o.stop(), 2100);
    }catch(e){}
  }

  // 타자 사운드
  let typeTickCount = 0;
  function typeTick(){ typeTickCount++; if(typeTickCount%3) return; beep(2100, .05, .018, 'square'); }

  function updateZoomLabel(){ zoomVal.textContent = ZOOM.toFixed(1)+'×'; }
  updateZoomLabel();
  zoomIn.addEventListener('click', ()=>{ ZOOM=Math.min(3.0, ZOOM+0.05); updateZoomLabel(); }, {passive:true});
  zoomOut.addEventListener('click', ()=>{ ZOOM=Math.max(0.35, ZOOM-0.05); updateZoomLabel(); }, {passive:true});

  // 권한
  async function requestMotionPermissions(){
    const needsIOS = typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function';
    try{ if(needsIOS){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); } }catch{}
  }
  async function gate(){
    try{
      await requestMotionPermissions();
      const tmp = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}, audio:false });
      tmp.getTracks().forEach(t=>t.stop());
      camPermGranted = true;
    }catch(e){ console.warn('permission error:', e); }
    fadeHide(overlay, 2000);
    fadeShow(nameOverlay, 2000);
    setTimeout(()=>nickInput.focus(), 60);
  }
  permBtn.addEventListener('click', gate, {passive:true});
  ['pointerdown','touchstart','click','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{ if(overlay.style.display!=='none') gate(); }, {once:true, capture:true, passive:true});
  });

  // 이름
  let displayName = 'YOU';
  function acceptName(){
    const v = (nickInput.value||'').trim();
    if(v.length>0){ displayName = v; }
    fadeHide(nameOverlay, 2000);
    showPreset();
  }
  nameSubmit.addEventListener('click', acceptName, {passive:true});
  nickInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ acceptName(); }});

  // ===== 프리셋: 개별 글자 20개 =====
  let saverObjs = []; let saverMode = 'scatter'; let saverT0 = 0;
  function showPreset(){
    preset.style.display='block'; preset.classList.add('show');
    fadeShow(preset, 2000);
    initSaver();
    startScreensaverHum();
  }
  function initSaver(){
    const w = preset.clientWidth, h = preset.clientHeight;
    saverObjs = [];
    const letters = ['S','L','E','E','P'];
    for(let i=0;i<20;i++){
      saverObjs.push({
        ch: letters[i%5],
        x: Math.random()*w, y: Math.random()*h,
        vx: (Math.random()*1.2+0.3) * (Math.random()<.5?-1:1),
        vy: (Math.random()*1.2+0.3) * (Math.random()<.5?-1:1),
        phase: Math.random()*Math.PI*2,
        size: Math.floor(Math.random()*60)+90
      });
    }
    saverT0 = performance.now();
    requestAnimationFrame(saverLoop);
  }
  function saverTargetsForWord(){
    const w = preset.clientWidth, h = preset.clientHeight;
    const base = Math.min(w,h)*0.55;
    const cx = w/2, cy = h/2;
    const spacing = base/5;
    const left = cx - (spacing*2);
    return [
      {x:left+spacing*0, y:cy},
      {x:left+spacing*1, y:cy},
      {x:left+spacing*2, y:cy},
      {x:left+spacing*3, y:cy},
      {x:left+spacing*4, y:cy},
    ];
  }
  function saverLoop(){
    if(preset.style.display==='none') return;
    const now = performance.now();
    const w = preset.clientWidth, h = preset.clientHeight, dpr = devicePixelRatio||1;
    presetCanvas.width = w*dpr; presetCanvas.height = h*dpr;
    const ctx = presetCanvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h); ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const t = now/1000;

    // 모드 전환(6~8초 주기)
    const dt = (now - saverT0)/1000;
    if(dt>Math.random()*2+6){
      saverMode = (saverMode==='scatter' ? 'assemble' : 'scatter');
      saverT0 = now;
    }

    const targets = saverMode==='assemble' ? saverTargetsForWord() : null;

    for(let i=0;i<saverObjs.length;i++){
      const o = saverObjs[i];
      if(saverMode==='assemble'){
        // 자기 글자에 맞는 목표로 천천히 끌림
        const idx = ['S','L','E','E','P'].indexOf(o.ch);
        const goal = targets[idx];
        o.vx += (goal.x - o.x)*0.0006;
        o.vy += (goal.y - o.y)*0.0006;
      }
      o.x += o.vx; o.y += o.vy;
      if(o.x<0||o.x>w) o.vx*=-1;
      if(o.y<0||o.y>h) o.vy*=-1;

      const wob = Math.sin(t*2 + o.phase)*0.12 + 1;
      ctx.save();
      ctx.translate(o.x, o.y); ctx.scale(wob, 1/wob);
      ctx.font = `900 ${o.size}px Impact, Anton, "Arial Black", system-ui, sans-serif`;
      ctx.fillStyle='#fff';
      ctx.fillText(o.ch, 0, 0);
      ctx.restore();
    }
    requestAnimationFrame(saverLoop);
  }
  preset.addEventListener('click', async ()=>{
    fadeHide(preset, 2000);
    await startCameraFresh();
    fadeShow(welcome, 2000);
  }, {passive:true});

  // WELCOME → INTRO
  goIntroBtn.addEventListener('click', ()=>{
    ensureAudio(); playClick();
    fadeHide(welcome, 2000);
    showIntro();
  }, {passive:true});

  // 인트로 타자
  function captureIntroTexts(){
    const els = Array.from(document.querySelectorAll('#introBox h2, #introBox p, #introBox li'));
    els.forEach(el=>{ el.dataset.text = (el.textContent||'').trim(); el.textContent=''; });
    return els;
  }
  async function typeElement(el, text, speed=35){
    el.textContent='';
    for(let i=0;i<text.length;i++){
      el.textContent += text[i];
      if(/\S/.test(text[i])) typeTick();
      intro.scrollTop = intro.scrollHeight;
      await sleep(speed);
    }
  }
  async function typeAllIntro(){
    const els = captureIntroTexts();
    for(const el of els){
      await typeElement(el, el.dataset.text||'', 35);
      await sleep(180);
    }
  }

  function showIntro(){
    fadeShow(intro, 2000, 'flex');
    typeTickCount = 0;
    typeAllIntro();

    // 30초 동안, 마지막 10초만 카운트다운 노출
    const total = 30;
    let left = total;
    introCount.textContent='';
    const iv = setInterval(()=>{
      left--;
      if(left<=10) introCount.textContent = `Coming in ${left}s`;
      if(left<=0){ clearInterval(iv); startTransition(); }
    },1000);
  }

  // 전환: 2s GOOD NIGHT → 2s 크로스/번개 → THE FIRST SLEEP 5s 페이드아웃
  async function startTransition(){
    fadeHide(intro, 2000);

    // GOOD NIGHT 정지 2s
    titleText.textContent='GOOD NIGHT';
    titleScreen.style.display='flex';
    titleScreen.style.background='#000'; titleText.style.color='#fff';
    swell();
    await sleep(2000);

    // 2s 크로스(200ms 간격 교차 + 번개)
    const until = performance.now()+2000;
    let flag=false;
    while(performance.now()<until){
      flag=!flag;
      titleText.textContent = flag ? 'GOOD NIGHT' : 'THE FIRST SLEEP';
      // 번개 스파크
      titleScreen.style.background='rgba(255,255,255,0.96)'; titleText.style.color='#000';
      thunder();
      await sleep(80);
      titleScreen.style.background='#000'; titleText.style.color='#fff';
      await sleep(120);
    }
    titleScreen.style.display='none';

    // THE FIRST SLEEP — 카메라 위에 노출 후 5초 페이드아웃
    firstSleep.style.display='flex';
    firstSleep.style.opacity='1';
    swell();
    await sleep(500); // 살짝 머물렀다가
    firstSleep.style.transition='opacity 5s ease';
    firstSleep.style.opacity='0';
    await sleep(5200);
    firstSleep.style.display='none';
    firstSleep.style.transition='';

    // 메인 진입
    beginCharacterMoveAfterUI();
  }

  // 카메라 루프
  async function startCameraFresh(){
    try{
      if(!camPermGranted){
        await navigator.mediaDevices.getUserMedia({video:true, audio:false}).then(s=>{ s.getTracks().forEach(t=>t.stop()); camPermGranted=true; });
      }
      camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}}, audio:false });
      if(!camVideo){
        camVideo = document.createElement('video');
        camVideo.setAttribute('playsinline',''); camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;
      }
      camVideo.srcObject = camStream;
      await camVideo.play().catch(()=>{});

      if(!vctx){
        vctx = view.getContext('2d',{alpha:false});
        proc = document.createElement('canvas');
        pctx = proc.getContext('2d',{willReadFrequently:true});
        resizeCam();
      }
      if(!animStarted){ animStarted = true; loopCam(); }
      wireButtonClicks();
    }catch(e){ console.warn('startCameraFresh error:', e); }
  }

  function resizeCam(){
    const dpr = window.devicePixelRatio||1;
    const w = window.innerWidth, h = window.innerHeight;
    view.width=w*dpr; view.height=h*dpr; if(vctx) vctx.setTransform(dpr,0,0,dpr,0,0);
    const scale = matchMedia('(orientation: landscape)').matches? 0.86 : 0.9;
    if(proc){ proc.width=Math.floor(w*scale); proc.height=Math.floor(h*scale); }
  }
  addEventListener('resize', ()=>setTimeout(resizeCam,50), {passive:true});

  document.addEventListener('visibilitychange', async ()=>{
    if(document.visibilityState==='visible' && camVideo){
      try{
        if(camVideo.paused){ await camVideo.play(); }
        if(!camStream || camStream.getVideoTracks().every(t=>t.readyState!=='live')){
          await startCameraFresh();
        }
      }catch{}
    }
  });

  function loopCam(){
    requestAnimationFrame(loopCam);
    if(!vctx || !pctx) return;
    const W=view.width/(window.devicePixelRatio||1), H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;
    pctx.fillStyle='rgba(0,0,0,.14)'; pctx.fillRect(0,0,PW,PH);
    if(camVideo && camVideo.readyState>=2){
      const vw=camVideo.videoWidth||0, vh=camVideo.videoHeight||0;
      if(vw&&vh){
        const cover=Math.max(PW/vw, PH/vh)*ZOOM;
        const dw=vw*cover, dh=vh*cover, dx=(PW-dw)/2, dy=(PH-dh)/2;
        pctx.globalAlpha=.7; pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1;
        const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;
        for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.imageSmoothingEnabled = false;
    vctx.drawImage(proc,0,0,W,H);
    if(charActive){ drawCharacter(W,H); }
  }

  // ===== 캐릭터 (8분) =====
  let charActive = false;
  let charStartTime = 0;
  const CHAR_DURATION = 480000; // 8분
  let pathSegments = null;
  let timerInterval = null;

  // 스프라이트(작고 선명)
  const PIXEL_SPRITE = [
    "..XXXXXX....",".XXXXXXXX...",".XX.XX.XX...",".XXXXXXXX...",
    "..XXXXXX....",".XXXXXXXX...",".XXXXXXXX...",".XX.XX.XX...",
    ".XXXXXXXX...", "..XXXXXX....",".XX....XX...",".XX....XX...",
    ".XX....XX...", ".XX....XX...", "..XX..XX....","..XX..XX...."
  ];
  const COLOR_FILL = '#ff8a3c';
  const COLOR_STROKE = '#000000';

  function drawPixelHuman(ctx, cx, baselineY, name, W){
    const cell = Math.max(2, Math.min(4, Math.floor(W * 0.0018))); // 보이도록 최소값 ↑
    const cols = PIXEL_SPRITE[0].length;
    const rows = PIXEL_SPRITE.length;
    const width = cols * cell;
    const height = rows * cell;

    const x0 = Math.round(cx - width/2);
    const y0 = Math.round(baselineY - height);

    // 외곽선
    ctx.fillStyle = COLOR_STROKE;
    for(let y=0; y<rows; y++){
      const row = PIXEL_SPRITE[y];
      for(let x=0; x<cols; x++){
        if(row[x]==='X'){
          ctx.fillRect(x0 + x*cell - 1, y0 + y*cell, cell, cell);
          ctx.fillRect(x0 + x*cell + 1, y0 + y*cell, cell, cell);
          ctx.fillRect(x0 + x*cell, y0 + y*cell - 1, cell, cell);
          ctx.fillRect(x0 + x*cell, y0 + y*cell + 1, cell, cell);
        }
      }
    }
    // 본체
    ctx.fillStyle = COLOR_FILL;
    for(let y=0; y<rows; y++){
      const row = PIXEL_SPRITE[y];
      for(let x=0; x<cols; x++){
        if(row[x]==='X'){
          ctx.fillRect(x0 + x*cell, y0 + y*cell, cell, cell);
        }
      }
    }

    // 이름
    ctx.font = `700 ${Math.max(10, Math.min(18, Math.floor(W*0.014)))}px "Courier New", ui-monospace, monospace`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'top';
    const ny = Math.round(baselineY + Math.max(2, cell));
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillText(displayName, cx, ny-1); ctx.fillText(displayName, cx, ny+1);
    ctx.fillText(displayName, cx-1, ny); ctx.fillText(displayName, cx+1, ny);
    ctx.fillStyle = '#fff'; ctx.fillText(displayName, cx, ny);
  }

  // DOCUMENT 아래 → 줌 컨트롤 위
  function buildPathFromUI(){
    const fr = frameBox.getBoundingClientRect();
    const docR = docBtn.getBoundingClientRect();
    const ctrlR = document.querySelector('.controls').getBoundingClientRect();

    const start = { x: docR.left + docR.width/2, y: docR.bottom + 18 };
    const end   = { x: ctrlR.left + ctrlR.width/2, y: ctrlR.top - 24 };

    const mid1 = { x: fr.left + fr.width*0.66, y: fr.top + fr.height*0.28 };
    const mid2 = { x: fr.left + fr.width*0.78, y: fr.top + fr.height*0.62 };

    const pts = [start, mid1, mid2, end];
    const segs=[]; let total=0;
    for(let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1]; const len=Math.hypot(b.x-a.x, b.y-a.y);
      segs.push({a,b,len}); total+=len;
    }
    let acc=0; for(const s of segs){ s.t0=acc/total; acc+=s.len; s.t1=acc/total; }
    return segs;
  }

  function beginCharacterMoveAfterUI(){
    // UI 보인 뒤 1프레임 후 경로 계산 → 시작 즉시 보이도록
    showTopUI();
    requestAnimationFrame(()=>{
      pathSegments = buildPathFromUI();
      charActive = true;
      charStartTime = performance.now(); // t=0에서 바로 렌더
      startRunTimer();
    });
  }

  function getCharPos(now){
    const t = Math.min(1, (now - charStartTime)/CHAR_DURATION);
    const sgs = pathSegments||[]; if(!sgs.length) return null;
    let seg = sgs[sgs.length-1], lt=1;
    for(const s of sgs){ if(t>=s.t0 && t<=s.t1){ seg=s; lt=(t - s.t0)/(s.t1 - s.t0); break; } }
    return { x: seg.a.x + (seg.b.x - seg.a.x)*lt, y: seg.a.y + (seg.b.y - seg.a.y)*lt, t };
  }

  function drawPathDots(ctx, segments, t){
    if(!segments || !segments.length) return;
    ctx.save();
    ctx.globalAlpha = 0.7; ctx.fillStyle = '#cfcfcf';
    const step = 22, size = 3;
    for(const s of segments){
      const localT = Math.max(0, Math.min(1, (t - s.t0) / (s.t1 - s.t0)));
      if(localT <= 0) continue;
      const dotCount = Math.floor((s.len * localT) / step);
      for(let i=0; i<=dotCount; i++){
        const r = (i * step) / s.len;
        const x = s.a.x + (s.b.x - s.a.x) * r;
        const y = s.a.y + (s.b.y - s.a.y) * r;
        ctx.fillRect(Math.round(x - size/2), Math.round(y - size/2), size, size);
      }
    }
    ctx.restore();
  }

  function drawCharacter(W,H){
    const now = performance.now();
    const p = getCharPos(now);
    if(!p) return;
    drawPathDots(vctx, pathSegments, p.t);
    drawPixelHuman(vctx, Math.round(p.x), Math.round(p.y), displayName, W);
    if(now - charStartTime >= CHAR_DURATION){ charActive=false; stopRunTimer(); }
  }

  // 8분 타이머
  function fmt(mmss){ const m=Math.floor(mmss/60), s=mmss%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  function startRunTimer(){
    const start = performance.now();
    runTimer.style.display = 'block';
    runTimer.textContent = "08:00";
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      const elapsed = performance.now() - start;
      const remain = Math.max(0, Math.round((CHAR_DURATION - elapsed)/1000));
      runTimer.textContent = fmt(remain);
      if(remain<=0){ clearInterval(timerInterval); }
    }, 1000);
  }
  function stopRunTimer(){ if(timerInterval) clearInterval(timerInterval); runTimer.textContent = "00:00"; }

  // 캡처
  captureBtn.addEventListener('click', ()=>{
    try{ const a=document.createElement('a'); a.download=`sleep_capture_${Date.now()}.png`; a.href=view.toDataURL('image/png'); a.click(); }catch(e){}
  }, {passive:true});

  // DOC/MAP
  function openDoc(){ docOverlay.style.display='block'; }
  function closeDoc(){ docOverlay.style.display='none'; }
  docBtn.addEventListener('click', openDoc, {passive:true});
  btnExitDoc.addEventListener('click', closeDoc, {passive:true});
  (function buildDocGrid(){
    docGrid.innerHTML='';
    for(let i=1;i<=8;i++){
      const b=document.createElement('button'); b.className='docBtn uiBtn small'; b.textContent=`Document ${i}`;
      b.onclick=()=>{ playClick(); docTitle.textContent=`Document ${i}`; docBody.innerHTML='준비중입니다.'; docPane.style.display='block'; };
      docGrid.appendChild(b);
    }
  })();
  function openMap(){ mapOverlay.style.display='block'; }
  function closeMap(){ mapOverlay.style.display='none'; }
  mapBtn.addEventListener('click', openMap, {passive:true});
  btnExitMap.addEventListener('click', closeMap, {passive:true});

  // 카메라 루프
  async function startCameraFresh(){
    try{
      if(!camPermGranted){
        await navigator.mediaDevices.getUserMedia({video:true, audio:false}).then(s=>{ s.getTracks().forEach(t=>t.stop()); camPermGranted=true; });
      }
      camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}}, audio:false });
      if(!camVideo){
        camVideo = document.createElement('video');
        camVideo.setAttribute('playsinline',''); camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;
      }
      camVideo.srcObject = camStream;
      await camVideo.play().catch(()=>{});

      if(!vctx){
        vctx = view.getContext('2d',{alpha:false});
        proc = document.createElement('canvas');
        pctx = proc.getContext('2d',{willReadFrequently:true});
        resizeCam();
      }
      if(!animStarted){ animStarted = true; loopCam(); }
      wireButtonClicks();
    }catch(e){ console.warn('startCameraFresh error:', e); }
  }

  // 시작 플로우: 권한→이름→프리셋→웰컴→인트로→전환→메인(캐릭터 즉시 표시)
})();
</script>
</body>
</html>