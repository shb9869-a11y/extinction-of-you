<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --frame: clamp(16px, 4vmin, 40px);
    --ui-gap: 8px;

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);
    --fs-name: clamp(16px,3.2vmin,22px);
  }

  /* ===== 선택/콜아웃/탭 하이라이트 억제 (입력창은 예외) ===== */
  html, body, #view, #overlay, #nameOverlay, #preset, #overlayWelcome, #introBig, #dialogueWrap, #firstSleep, #noticePopup {
    -webkit-user-select: none; user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  button, a, canvas, [role="button"]{
    -webkit-user-select: none; user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
  ::selection { background: transparent; }
  ::-moz-selection { background: transparent; }
  input, textarea{
    -webkit-user-select: text; user-select: text;
    -webkit-touch-callout: default;
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  body{
    font-family:Impact,"Anton","Arial Black",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
  }
  *{ box-sizing:border-box }

  .fade{opacity:0; transition:opacity 900ms ease}
  .fade.show{opacity:1}

  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  .frameBox{
    position:fixed;
    left:calc(var(--frame)); top:calc(var(--frame));
    right:calc(var(--frame)); bottom:calc(var(--frame));
    border:2px solid rgba(255,255,255,.22); pointer-events:none; z-index:5;
  }

  .uiBtn{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.28);
    font-size:var(--fs-strong); padding:.6em 1em; font-family:"Courier New",ui-monospace,monospace;
    white-space:nowrap; cursor:pointer; user-select:none}
  .uiBtn.flat{border:none}
  .uiBtn.small{font-size:var(--fs-small); padding:.4em .8em}
  .hide{display:none !important;}

  /* 타이머 */
  #runTimer{
    position:fixed; right:calc(var(--frame)); top:calc(var(--frame));
    z-index:20; font-family:"Courier New",ui-monospace,monospace; font-size:var(--fs-strong);
    color:#fff; opacity:.95; pointer-events:none; display:none;
  }

  /* Gate */
  #overlay{position:fixed;inset:0;z-index:30;display:flex;align-items:center;justify-content:center;
    padding:20px;color:#fff;background:rgba(0,0,0,.85);}
  #overlayContent{max-width:min(92vw, 72ch);font-family:"Courier New",ui-monospace,monospace;line-height:1.7;text-align:center}
  .gateLine{display:inline-block;font-family:"Courier New",ui-monospace,monospace;font-size:var(--fs-strong);
    border:none;background:transparent;color:#fff;cursor:pointer;padding:6px 10px;width:100%}
  .gateHint{opacity:.7;margin-top:6px}

  /* Name */
  #nameOverlay{position:fixed; inset:0; z-index:26; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.85); color:#fff;}
  #nameCard{ width:min(92vw,600px); text-align:center; font-family:"Courier New",ui-monospace,monospace; }
  #nameCard h2{ margin:0 0 12px 0; letter-spacing:.08em; font-size:var(--fs-name); font-weight:400; }
  #nick{ width:100%; padding:12px 14px; background:#000; border:1px solid #555; color:#fff; font-size:var(--fs-name); outline:none; }
  #nameRow{ display:flex; gap:10px; margin-top:12px; justify-content:center; }
  #nameRow .uiBtn.flat{ font-size:var(--fs-name); font-weight:400; }

  /* Preset → Welcome */
  #preset{position:fixed;inset:0;z-index:24;background:#000;display:none;cursor:pointer}
  #presetCanvas{position:absolute;left:0;top:0;width:100%;height:100%}
  #overlayWelcome{position:fixed; inset:0; z-index:22; display:none; place-items:center; color:#fff;background:rgba(0,0,0,.55);}
  #welcomeCard{display:flex; flex-direction:column; align-items:center; justify-content:center;
    width:100%; max-width:min(92vw, 900px); margin:0 auto; text-align:center; padding:20px;}
  #welcomeCard .title{ font-size:clamp(32px, 12vmin, 120px); font-weight:900; letter-spacing:.04em; line-height:1.02; margin:0 0 6px 0; text-transform:uppercase; }

  /* INTRODUCTION 타이틀 */
  #introBig{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; pointer-events:none; z-index:18;}
  #introBigText{ color:#fff; font-weight:900; letter-spacing:.06em; font-size:clamp(48px, 22vmin, 260px); text-transform:uppercase; text-align:center; white-space:nowrap; text-shadow:0 0 8px rgba(0,0,0,.85), 0 2px 4px rgba(0,0,0,.7); padding:0 .02em; }

  /* 인트로 대화 패널 */
  #dialogueWrap{
    position:fixed; left:calc(var(--frame)); right:calc(var(--frame)); bottom:0; z-index:19;
    display:none; pointer-events:auto;
  }
  #dialogueBox{
    width:100%; max-width:1200px; margin:0 auto;
    background:#000; color:#fff; border:1px solid rgba(255,255,255,.25); border-bottom:none;
    padding:14px 16px;
    font-family:"Courier New",ui-monospace,monospace; line-height:1.7;
    box-shadow:0 -10px 30px rgba(0,0,0,.35) inset;
  }
  #dialogueHeader{ opacity:.9; font-size:clamp(12px, 2.2vmin, 15px); letter-spacing:.08em; margin-bottom:6px; }
  #dialogueText{ font-size:clamp(14px, 2.6vmin, 19px); min-height:3lh; }
  #dialogueControls{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  #nextBtn{ border:1px solid rgba(255,255,255,.35); }

  /* THE FIRST SLEEP */
  #firstSleep{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:25; pointer-events:none; }
  #firstSleepText{
    color:#fff; font-weight:900; letter-spacing:.06em; font-size:clamp(48px, 22vmin, 260px);
    text-transform:uppercase; text-align:center; white-space:nowrap; text-shadow:0 0 8px rgba(0,0,0,.85), 0 2px 4px rgba(0,0,0,.7);
    padding:0 .02em;
  }

  /* NOTICE */
  #noticePopup{ position:fixed; inset:0; z-index:40; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); }
  #noticeCard{ width:min(92vw,640px); background:#0b0b0b; color:#fff; border:1px solid #333; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.6); font-family:"Courier New",ui-monospace,monospace; line-height:1.7;}
  #noticeCard h3{ margin:0 0 6px 0; letter-spacing:.06em; font-weight:700; font-size:clamp(15px,3vmin,20px); }
  #noticeCard p{ margin:4px 0; font-size:clamp(12px,2.4vmin,16px); }
  #noticeActions{ margin-top:10px; text-align:right; }
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <div id="runTimer" aria-live="polite">08:00</div>

  <!-- Gate -->
  <div id="overlay" class="fade show">
    <div id="overlayContent">
      <div class="credits" style="margin-bottom:10px;font-family:'Courier New',monospace;letter-spacing:.08em;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="gateLine" type="button">
        Tap anywhere to allow Camera, Microphone & Motion sensors
      </button>
      <div class="gateHint">After allowing, you'll move to the name screen (Android: full screen immediately).</div>
    </div>
  </div>

  <!-- Name -->
  <div id="nameOverlay" class="fade">
    <div id="nameCard">
      <h2>TELL ME YOUR NAME</h2>
      <input id="nick" type="text" maxlength="24" placeholder="Type your nickname" autocomplete="off" />
      <div id="nameRow">
        <button id="nameSubmit" class="uiBtn flat" type="button">GO</button>
      </div>
    </div>
  </div>

  <!-- Preset -->
  <div id="preset" class="fade" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <!-- Welcome -->
  <div id="overlayWelcome" class="fade">
    <div id="welcomeCard">
      <div class="credits" style="margin-bottom:12px;font-family:'Courier New',monospace;letter-spacing:.08em;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div class="title">SLEEEEEEEEEEEEEEEEEEEEEEEEEP,</div>
      <div class="title">SLEEEEEEEEEEEEEEEEEEEEEEEEEP</div>
      <button id="goIntro" class="uiBtn flat" type="button">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- INTRODUCTION -->
  <div id="introBig" class="fade"><div id="introBigText">INTRODUCTION</div></div>

  <!-- 인트로 대화 패널 (NEXT 버튼으로 진행) -->
  <div id="dialogueWrap">
    <div id="dialogueBox">
      <div id="dialogueHeader">VOICE:</div>
      <div id="dialogueText" aria-live="polite"></div>
      <div id="dialogueControls">
        <button id="nextBtn" class="uiBtn small">NEXT</button>
      </div>
    </div>
  </div>

  <!-- THE FIRST SLEEP -->
  <div id="firstSleep"><div id="firstSleepText">THE FIRST SLEEP</div></div>

  <!-- NOTICE Popup -->
  <div id="noticePopup" class="fade" role="dialog" aria-modal="true" aria-labelledby="noticeTitle">
    <div id="noticeCard">
      <h3 id="noticeTitle">NOTICE</h3>
      <p>※ “THE FIRST SLEEP”은 눈으로 타자를 인식해 나가는 챕터입니다.</p>
      <p>※ 앞으로 당신의 태블릿 위로 타자와 몇가지 흔적들이 텍스트로 제시될 것입니다.</p>
      <p>※ 당신은 내면 세계의 탐험가로써 그 흔적들을 화면 아래 ‘CAPTURE’와 ‘+’, ‘-’버튼을 눌러 포착하세요.</p>
      <p>※ 확인하셨다면, 아래 ‘OK’버튼을 눌러주세요</p>
      <div id="noticeActions">
        <button id="noticeOk" class="uiBtn flat" type="button">OK</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /* Manifest inline */
  (function injectManifest(){
    const manifest = {"name":"SLEEEEEP","short_name":"SLEEEEEP","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  /* Helpers */
  const FADE = 900;
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const qs = s => document.querySelector(s);
  function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppH(); addEventListener('resize', setAppH, {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppH,50)); }

  /* 선택/복사 UI 차단 (입력창 제외) */
  document.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});
  document.addEventListener('selectstart', e=>{
    const ae = document.activeElement;
    const ok = ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.isContentEditable);
    if(!ok) e.preventDefault();
  }, {passive:false});
  document.addEventListener('selectionchange', ()=>{
    const ae = document.activeElement;
    const ok = ae && (ae.tagName==='INPUT' || ae.tagName==='TEXTAREA' || ae.isContentEditable);
    if(ok) return;
    const sel = window.getSelection && window.getSelection();
    if(sel && sel.rangeCount) sel.removeAllRanges();
  });

  /* Fullscreen(안드로이드 우선) */
  async function goFullscreen(){
    const el = document.documentElement;
    const anyDoc = document;
    try{
      if(!anyDoc.fullscreenElement && el.requestFullscreen){ await el.requestFullscreen(); }
      else if(el.webkitRequestFullscreen){ el.webkitRequestFullscreen(); }
    }catch(e){}
  }

  /* Audio */
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  async function ensureResumed(){ try{ ensureAudio(); if(audioCtx.state==='suspended') await audioCtx.resume(); }catch{} }

  /* Ambient module (3초 페이드아웃 가능) */
  const Ambient = (() => {
    let ctx, master, delay, fb, hp, lp, mix, busGain, running=false, stops=[];
    function midi(n){ return 440 * Math.pow(2, (n-69)/12); }
    function makeBus(){
      ctx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      master = ctx.createGain(); master.gain.value = 0.0001;
      delay = ctx.createDelay(2.5); delay.delayTime.value = 0.35;
      fb = ctx.createGain(); fb.gain.value = 0.35; delay.connect(fb).connect(delay);
      hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=150;
      lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=4500;
      mix = ctx.createGain(); mix.gain.value = 0.6; mix.connect(hp).connect(lp).connect(master);
      busGain = ctx.createGain(); busGain.gain.value=0.9; busGain.connect(master);
      master.connect(ctx.destination);
    }
    function connectDryWet(node){ node.connect(busGain); node.connect(delay); delay.connect(mix); }
    function slowPad(root){
      const out = ctx.createGain(); out.gain.value=0.35;
      const filt = ctx.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value=600; filt.Q.value=0.6;
      [0,7,12].forEach((i,k)=>{ const o=ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=midi(root+i); o.detune.value=(k-1)*6;
        const g=ctx.createGain(); g.gain.value=0.08; o.connect(g).connect(filt); o.start(); stops.push(()=>{try{o.stop();}catch{}}); });
      filt.connect(out); connectDryWet(out); stops.push(()=>{try{out.disconnect();}catch{}});
    }
    function airyNoise(){
      const b=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate), d=b.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.15;
      const s=ctx.createBufferSource(); s.buffer=b; s.loop=true;
      const g=ctx.createGain(); g.gain.value=0.02; const f=ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=800; f.Q.value=0.7;
      s.connect(f).connect(g); connectDryWet(g); s.start(); stops.push(()=>{try{s.stop();}catch{}}); 
    }
    let seqTimer=null, started=false;
    async function start(fadeIn=0.8, target=1.0){
      await ensureResumed(); if(started) return; makeBus(); started=true; running=true; airyNoise();
      const seq=[57,52,48,43]; let i=0;
      seqTimer = setInterval(()=>{ if(!running) return; slowPad(seq[i%seq.length]); i++; }, 8000);
      const t=(ctx||audioCtx).currentTime;
      master.gain.setValueAtTime(master.gain.value, t);
      master.gain.exponentialRampToValueAtTime(target, t+fadeIn);
    }
    function stop(fade=3.0){  // 기본 3초 페이드아웃
      if(!started||!master) return;
      const t=(ctx||audioCtx).currentTime;
      master.gain.cancelScheduledValues(t);
      master.gain.linearRampToValueAtTime(0.0001, t+fade);
      setTimeout(()=>{
        try{ clearInterval(seqTimer); }catch{}
        stops.forEach(fn=>{try{fn();}catch{}}); stops=[]; running=false; started=false;
      }, fade*1000+120);
    }
    return { start, stop, isRunning:()=>running };
  })();

  /* Small SFX */
  async function clickWoong(){
    try{
      await ensureResumed();
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      const f = audioCtx.createBiquadFilter();
      o.type='sine';
      o.frequency.setValueAtTime(180, now);
      o.frequency.exponentialRampToValueAtTime(70, now+0.32);
      f.type='lowpass'; f.frequency.setValueAtTime(1400, now); f.Q.value=0.7;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.8, now+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.55);
      o.connect(f).connect(g).connect(audioCtx.destination);
      o.start(); o.stop(now+0.58);
    }catch(e){}
  }

  /* Elements */
  const view = qs('#view');
  const overlay = qs('#overlay');
  const permBtn = qs('#permGateBtn');
  const nameOverlay = qs('#nameOverlay');
  const nickInput = qs('#nick');
  const nameSubmit = qs('#nameSubmit');
  const preset = qs('#preset');
  const presetCanvas = qs('#presetCanvas');
  const welcome = qs('#overlayWelcome');
  const goIntroBtn = qs('#goIntro');
  const introBig = qs('#introBig');
  const introBigText = qs('#introBigText');
  const dialogueWrap = qs('#dialogueWrap');
  const dialogueText = qs('#dialogueText');
  const nextBtn = qs('#nextBtn');
  const firstSleep = qs('#firstSleep');
  const firstSleepText = qs('#firstSleepText');
  const runTimer = qs('#runTimer');
  const noticePopup = qs('#noticePopup');
  const noticeOk = qs('#noticeOk');

  /* Camera warm view (회색조 백그라운드) */
  let camPermGranted=false, camVideo=null, camStream=null, vctx=null, proc=null, pctx=null, metaReady=false;
  function drawBestCover(ctx, video, PW, PH){
    const vw=video.videoWidth||0, vh=video.videoHeight||0; if(!vw||!vh) return;
    const s = Math.max(PW/vw, PH/vh);
    const dw = vw*s, dh = vh*s;
    const dx = (PW-dw)/2, dy=(PH-dh)/2;
    ctx.save(); ctx.globalAlpha=.7;
    ctx.drawImage(video, dx, dy, dw, dh);
    ctx.restore();
  }
  function resizeAll(){
    const dpr = devicePixelRatio||1, w=innerWidth, h=innerHeight;
    view.width=w*dpr; view.height=h*dpr;
    if(vctx) vctx.setTransform(dpr,0,0,dpr,0,0);
    if(proc){ proc.width=w; proc.height=h; }
  }
  addEventListener('resize', resizeAll, {passive:true});

  async function startCamera(){
    try{
      if(!camVideo){
        camVideo = document.createElement('video');
        camVideo.setAttribute('playsinline',''); camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;
      }
      if(!camStream){
        camStream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{min:1280, ideal:1920}, height:{min:720, ideal:1080}, aspectRatio:{ideal:16/9} },
          audio:false
        });
        camVideo.srcObject = camStream;
      }
      await camVideo.play().catch(()=>{});
      if(camVideo.readyState < 1){
        await new Promise(res => camVideo.addEventListener('loadedmetadata', res, {once:true}));
      }
      metaReady = true;
      if(!vctx){ vctx = view.getContext('2d', {alpha:false}); proc=document.createElement('canvas'); pctx=proc.getContext('2d'); }
      resizeAll();
      loop();
    }catch(e){ console.warn('camera start err', e); }
  }
  function loop(){
    requestAnimationFrame(loop);
    if(!vctx || !pctx || !metaReady) return;
    const W = view.width/(devicePixelRatio||1), H = view.height/(devicePixelRatio||1);
    pctx.clearRect(0,0,W,H);
    pctx.fillStyle='rgba(0,0,0,.14)'; pctx.fillRect(0,0,W,H);
    if(camVideo && camVideo.readyState>=2){
      drawBestCover(pctx, camVideo, W, H);
      const frame=pctx.getImageData(0,0,W,H),d=frame.data;
      for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
      pctx.putImageData(frame,0,0);
    }
    vctx.imageSmoothingEnabled = false;
    vctx.drawImage(proc,0,0,W,H);
  }

  /* Intro lines (풀 제거, 캐릭터 멘트 몇 개 추가 반영 가능) */
  let displayName='____';
  function introLines(){
    return [
      "안녕하세요?","작게 대답해주세요.","안녕하세요?","대답을 해주셔야 프로그램이 진행될 수 있습니다.","안녕하세요?","감사합니다.",
      `지금 이 화면을 보고 있는 당신은 ${displayName}의 내면 세계를 탐험하는 탐험가입니다.`,
      "지금부터 우리는 주변의 소리에 귀를 기울이며 30분 간의 짧은 낮잠에 빠져볼 것입니다.",
      "자, 천천히 공간을 거닐어보세요.","무릎을 들고, 발을 앞으로 뻗어보세요.","참 잘했어요.",
      "맞아요. 그래요. 우리는 늘 타자와 함께 존재해 왔습니다.",
      "그러나 어느 순간 ‘너’였던 그들은 ‘그것’으로 전락했습니다.",
      "이유는 아무도 몰라요. 그저 우리가 ‘너’들을 ‘그것’이라 부르기 시작했죠.",
      "마치 꿈 속에서 누군가를 만났는데, 막상 깨어나면 이름이 떠오르지 않는 것처럼.",
      "지금 우리는 ‘너’가 사라진 세계에 서 있습니다.",
      `${displayName}의 내면 세계로 들어가며, 두 번 호흡합니다. 후— 하. 후— 하.`,
      "눈을 가만히 감고, 수면 아래로 천천히 가라앉습니다.",
      "이제, 첫 번째 수면으로."
    ];
  }

  /* Gate: 권한 + 전체화면 + 앰비언스 즉시 시작 */
  async function requestAllPermissions(){
    try{
      // iOS 모션 권한 시도(무시 가능)
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().catch(()=>{});
      }
    }catch(_){}

    ensureAudio(); await ensureResumed();

    let micPreStream=null;
    try{
      // 카메라+마이크(동시에 요청) → 허용되면 즉시 전체화면 & 앰비언스 시작
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{min:640}, height:{min:360} },
        audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:false }
      });
      camPermGranted = true;
      // 마이크 스트림은 오디오 그래프 연결 없이 즉시 정리(권한 목적)
      micPreStream = stream;
      // 앰비언스 즉시 시작
      await Ambient.start(0.6, 1.0);
      // 전체화면 즉시 시도(안드로이드)
      await goFullscreen();
      // 카메라 스트림은 다시 별도로 켜서 view용으로 사용
      try{ stream.getTracks().forEach(t=>t.stop()); }catch{}
    }catch(err){
      console.warn('permission error:', err);
    }finally{
      fadeHide(overlay, FADE);
      fadeShow(nameOverlay, FADE);
      setTimeout(()=>nickInput && nickInput.focus && nickInput.focus(), 60);
      // 백그라운드 카메라도 준비
      startCamera();
    }
  }
  function fadeShow(el, dur=FADE, display='flex'){
    el.style.display=display; el.style.opacity='0'; el.style.transition=`opacity ${dur}ms ease`;
    requestAnimationFrame(()=> el.style.opacity='1');
  }
  function fadeHide(el, dur=FADE){
    el.style.transition=`opacity ${dur}ms ease`; el.style.opacity='0';
    setTimeout(()=>{ el.style.display='none'; }, dur);
  }

  permBtn.addEventListener('click', async ()=>{
    await clickWoong();
    await requestAllPermissions();
  }, {passive:true});
  overlay.addEventListener('click', async ()=>{
    await clickWoong();
    await requestAllPermissions();
  }, {passive:true});

  /* Name → Preset */
  async function acceptName(){
    const v = (nickInput.value||'').trim();
    if(v.length>0){ displayName = v; }
    await clickWoong();
    fadeHide(nameOverlay, FADE);
    // 간단한 프리셋(로고 스크린세이버)
    showPreset();
  }
  nameSubmit.addEventListener('click', acceptName, {passive:true});
  nickInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ acceptName(); }});

  function showPreset(){
    preset.style.display='block'; preset.classList.add('show');
    initSaver(); requestAnimationFrame(saverLoop);
  }
  let saverObjs=[], saverT0=0;
  function initSaver(){
    const w = preset.clientWidth, h = preset.clientHeight;
    saverObjs = [];
    const letters = ['S','L','E','E','P'];
    for(let i=0;i<20;i++){
      saverObjs.push({
        ch: letters[i%5],
        x: Math.random()*w, y: Math.random()*h,
        vx: (Math.random()*1.2+0.3) * (Math.random()<.5?-1:1),
        vy: (Math.random()*1.2+0.3) * (Math.random()<.5?-1:1),
        phase: Math.random()*Math.PI*2,
        size: Math.floor(Math.random()*60)+90
      });
    }
    saverT0 = performance.now();
  }
  function saverLoop(){
    if(preset.style.display==='none') return;
    const now = performance.now();
    const w = preset.clientWidth, h = preset.clientHeight, dpr = devicePixelRatio||1;
    const ctx = presetCanvas.getContext('2d');
    presetCanvas.width = w*dpr; presetCanvas.height = h*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h); ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.textAlign='center'; ctx.textBaseline='middle';

    for(const o of saverObjs){
      o.x += o.vx; o.y += o.vy;
      if(o.x<0||o.x>w) o.vx*=-1;
      if(o.y<0||o.y>h) o.vy*=-1;
      const wob = Math.sin(now/500 + o.phase)*0.12 + 1;
      ctx.save();
      ctx.translate(o.x, o.y); ctx.scale(wob, 1/wob);
      ctx.font = `900 ${o.size}px Impact, Anton, "Arial Black", system-ui, sans-serif`;
      ctx.fillStyle='#fff';
      ctx.fillText(o.ch, 0, 0);
      ctx.restore();
    }
    requestAnimationFrame(saverLoop);
  }
  preset.addEventListener('click', async ()=>{
    await clickWoong();
    fadeHide(preset, FADE);
    fadeShow(welcome, FADE);
  }, {passive:true});

  /* Intro flow with NEXT */
  function fitTitleLine(el){
    if(!el) return;
    const fr = document.querySelector('.frameBox').getBoundingClientRect();
    const maxW = Math.min(window.innerWidth*0.96, fr.width*0.90);
    const cs = getComputedStyle(el);
    let size = parseFloat(cs.fontSize)||48;
    el.style.whiteSpace='nowrap';
    while(el.scrollWidth > maxW && size > 24){
      size *= 0.94; el.style.fontSize = size+'px';
    }
  }

  let lines=[], idx=0, introRunning=false, timer8=null, left8=8*60;
  function formatMMSS(s){ const m=Math.floor(s/60), ss=(s%60).toString().padStart(2,'0'); return `${m.toString().padStart(2,'0')}:${ss}`; }
  function startEightTimer(){
    left8=8*60; runTimer.textContent=formatMMSS(left8); runTimer.style.display='block';
    if(timer8) clearInterval(timer8);
    timer8 = setInterval(()=>{ left8=Math.max(0,left8-1); runTimer.textContent=formatMMSS(left8); if(left8<=0) clearInterval(timer8); },1000);
  }

  async function showIntro(){
    // INTRODUCTION 타이틀
    introBig.style.display='flex';
    introBig.style.opacity='0';
    await new Promise(r=>requestAnimationFrame(r));
    fitTitleLine(introBigText);
    introBig.style.transition='opacity 800ms ease';
    introBig.style.opacity='1';
    await sleep(1200);
    introBig.style.opacity='0';
    await sleep(700);
    introBig.style.display='none';

    // 대화 패널
    lines = introLines(); idx = 0; introRunning=true;
    dialogueWrap.style.display='flex';
    dialogueWrap.style.opacity='0';
    dialogueWrap.style.transition='opacity 800ms ease';
    requestAnimationFrame(()=> dialogueWrap.style.opacity='1');
    dialogueText.textContent = lines[idx] || '';
  }

  nextBtn.addEventListener('click', async ()=>{
    await clickWoong();
    if(!introRunning) return;
    idx++;
    if(idx < lines.length){
      dialogueText.textContent = lines[idx];
      // 마지막 문장 직전엔 버튼 라벨 바꾸기
      if(idx === lines.length-1){ nextBtn.textContent='ENTER FIRST SLEEP'; }
    }else{
      // 인트로 종료 → FIRST SLEEP 진입
      introRunning=false;
      dialogueWrap.style.transition='opacity 600ms ease';
      dialogueWrap.style.opacity='0';
      await sleep(650);
      dialogueWrap.style.display='none';
      await startFirstSleep();
    }
  });

  document.getElementById('goIntro').addEventListener('click', async ()=>{
    await clickWoong();
    fadeHide(welcome, FADE);
    showIntro();
  }, {passive:true});

  async function startFirstSleep(){
    // 화면 타이틀 표시
    firstSleep.style.display='flex';
    firstSleep.style.opacity='1';
    await new Promise(r=>requestAnimationFrame(r));
    fitTitleLine(firstSleepText);

    // 8분 타이머 시작
    startEightTimer();

    // ★ 요청사항: FIRST SLEEP 들어가면서 앰비언스 3초 페이드 아웃
    Ambient.stop(3.0);

    // 타이틀 자체는 천천히 페이드아웃
    await sleep(900);
    const fadeDur = 3000; // 텍스트도 3초에 맞춰 서서히 사라짐
    firstSleep.style.transition=`opacity ${fadeDur}ms ease`;
    firstSleep.style.opacity='0';
    await sleep(fadeDur+200);
    firstSleep.style.display='none';
    firstSleep.style.transition='';

    // 공지 팝업
    showNotice();
  }

  /* Notice */
  function showNotice(){
    function bgTrap(e){ if(!e.target.closest('#noticeCard')){ e.stopPropagation(); e.preventDefault(); } }
    ['touchstart','touchmove','pointerdown','click','wheel','keydown'].forEach(ev=>{
      noticePopup.addEventListener(ev, bgTrap, {passive:false});
    });
    fadeShow(noticePopup, 280, 'flex');
    setTimeout(()=>{ noticeOk && noticeOk.focus && noticeOk.focus(); }, 50);
    noticeOk.onclick = async (e)=>{ e.stopPropagation(); await clickWoong(); fadeHide(noticePopup, 250); };
  }

  /* Fade helpers */
  function fadeHide(el, dur=FADE){
    el.style.transition=`opacity ${dur}ms ease`; el.style.opacity='0';
    setTimeout(()=>{ el.style.display='none'; }, dur);
  }
  function fadeShow(el, dur=FADE, display='flex'){
    el.style.display=display; el.style.opacity='0'; el.style.transition=`opacity ${dur}ms ease`;
    requestAnimationFrame(()=> el.style.opacity='1');
  }

  /* Boot */
  window.addEventListener('load', ()=>{ /* noop */ });

})();
</script>
</body>
</html>
