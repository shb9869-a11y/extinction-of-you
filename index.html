<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Live Stream</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;}
  #wrap{position:fixed;inset:0;background:#000;}
  #v{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;}
  #wait{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
        color:#fff;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        opacity:.8;text-align:center}
  #unmute{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
          background:#12a150;color:#fff;border:0;border-radius:999px;padding:10px 16px;
          font-weight:700;display:none}
</style>
</head>
<body>
<div id="wrap">
  <video id="v" autoplay playsinline muted></video>
  <div id="wait">스트림 신호 대기 중…</div>
  <button id="unmute">소리 켜기</button>
</div>

<script>
(async ()=>{
  // Cloudflare Stream의 HLS Manifest URL로 교체
  const STREAM_URL = "https://customer-XXXX.cloudflarestream.com/XXXXXXXX/manifest/video.m3u8";

  const video = document.getElementById('v');
  const wait  = document.getElementById('wait');
  const unmuteBtn = document.getElementById('unmute');

  // iOS 자동재생 정책 대응: 처음엔 muted 상태로 재생, 버튼으로만 소리 켤 수 있음
  function showWaiting(msg="스트림 신호 대기 중…"){ wait.textContent = msg; wait.style.display='block'; }
  function hideWaiting(){ wait.style.display='none'; }

  async function attach(){
    try{
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = STREAM_URL;               // iOS Safari 네이티브 HLS
      } else if (window.Hls && Hls.isSupported()) {
        const hls = new Hls({ lowLatencyMode:true });
        hls.loadSource(STREAM_URL);
        hls.attachMedia(video);
      } else {
        video.src = STREAM_URL;               // 구형 브라우저 fallback
      }
      await video.play().catch(()=>{});
      pollReady();
    }catch(e){
      showWaiting("재생 준비 중…");
    }
  }

  // 신호가 들어오면 canplay/playing 상태가 되고, 없으면 계속 재시도
  function pollReady(){
    let tries = 0;
    const timer = setInterval(()=>{
      const ready = video.readyState >= 2; // HAVE_CURRENT_DATA
      if (ready && video.videoWidth>0){
        hideWaiting();
        clearInterval(timer);
      } else {
        showWaiting("스트림 신호 대기 중…");
        if (++tries % 10 === 0) {
          // 주기적으로 play 재시도
          video.play().catch(()=>{});
        }
      }
    }, 1500);
  }

  // 소리 켜기 버튼 (관객이 눌러야만 가능)
  unmuteBtn.addEventListener('click', ()=>{
    video.muted = false;
    video.play().catch(()=>{});
    unmuteBtn.style.display = 'none';
  });

  // 처음엔 음소거 자동재생 → 화면 탭하면 소리 버튼 노출
  document.addEventListener('click', ()=>{
    if (video.muted) unmuteBtn.style.display = 'inline-block';
  }, { once:true });

  await attach();
})();
</script>
</body>
</html>
