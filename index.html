<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Camera + Firebase Upload (BW, optimized)</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; font-family:system-ui,sans-serif; }
    /* ë¯¸ë¦¬ë³´ê¸° í•­ìƒ í‘ë°± */
    #camera-view { position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; filter:grayscale(100%); }
    #ui { position:fixed; right:20px; bottom:24px; z-index:10; display:flex; gap:10px; }
    button { padding:10px 16px; font-weight:700; border:0; border-radius:10px; cursor:pointer; }
    #capture-btn { background:#fff; color:#000; }
    #status { position:fixed; left:12px; bottom:12px; z-index:10; color:#fff; font-size:14px; opacity:.95; }
  </style>
</head>
<body>
  <video id="camera-view" autoplay playsinline muted></video>
  <div id="ui">
    <button id="capture-btn">ğŸ“¸ Capture & Upload</button>
  </div>
  <div id="status">ready</div>
  <canvas id="canvas" style="display:none;"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // ğŸ”§ Firebase ì„¤ì • (ë„¤ í”„ë¡œì íŠ¸ ê°’)
    const firebaseConfig = {
      apiKey: "AIzaSyC_WKhRUa4TslEKKLS46qGChSQ8A3Tanks",
      authDomain: "we-are-moim.firebaseapp.com",
      projectId: "we-are-moim",
      storageBucket: "we-are-moim.appspot.com",
      messagingSenderId: "709309645608",
      appId: "1:709309645608:web:2e04e871acb46c4adb861d"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app); // ë²„í‚· ìë™ ì¸ì‹

    const video = document.getElementById('camera-view');
    const captureBtn = document.getElementById('capture-btn');
    const canvas = document.getElementById('canvas');
    const statusEl = document.getElementById('status');

    // iOS ì²« íƒ­ ìë™ì¬ìƒ
    document.body.addEventListener('click', () => video.play(), { once: true });

    // ì¹´ë©”ë¼ ì‹œì‘
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
      .then(s => { video.srcObject = s; statusEl.textContent = "ğŸ“· camera on"; })
      .catch(e => { alert("ì¹´ë©”ë¼ ì ‘ê·¼ ë¶ˆê°€: " + e.message); statusEl.textContent = "âŒ camera error"; });

    // ì—…ë¡œë“œ(Resumable) + ì§„í–‰ë¥  + 60ì´ˆ íƒ€ì„ì•„ì›ƒ
    function uploadWithProgress(path, blob) {
      return new Promise((resolve, reject) => {
        const fileRef = ref(storage, path);
        const metadata = { contentType: 'image/jpeg' };
        const task = uploadBytesResumable(fileRef, blob, metadata);
        const timer = setTimeout(() => { try { task.cancel(); } catch(e){} reject(new Error("timeout: upload took too long")); }, 60000);

        task.on('state_changed',
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            statusEl.textContent = `â³ uploadingâ€¦ ${pct}%`;
          },
          (err) => { clearTimeout(timer); reject(err); },
          async () => { clearTimeout(timer); const url = await getDownloadURL(fileRef); resolve(url); }
        );
      });
    }

    // ìº¡ì²˜ â†’ í‘ë°± â†’ ë¦¬ì‚¬ì´ì¦ˆ â†’ JPEG â†’ ì—…ë¡œë“œ
    captureBtn.addEventListener('click', async () => {
      try {
        const w = video.videoWidth, h = video.videoHeight;
        if (!w || !h) return alert("ì¹´ë©”ë¼ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

        // ğŸ”½ ë¦¬ì‚¬ì´ì¦ˆ ëª©í‘œ (ë„ˆë¹„ 1000px, ë¹„ìœ¨ ìœ ì§€) â€” í•„ìš”í•˜ë©´ 800/1200 ë“±ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥
        const targetW = 1000;
        const scale = Math.min(1, targetW / w); // ì´ë¯¸ ì‘ìœ¼ë©´ í‚¤ìš°ì§€ ì•ŠìŒ
        const outW = Math.round(w * scale);
        const outH = Math.round(h * scale);

        canvas.width = outW; 
        canvas.height = outH;
        const ctx = canvas.getContext('2d');

        // ìº”ë²„ìŠ¤ í‘ë°± í•„í„° (ì§€ì› ë¸Œë¼ìš°ì € ìš°ì„ )
        if ('filter' in ctx) {
          ctx.filter = 'grayscale(100%)';
          ctx.drawImage(video, 0, 0, outW, outH);
        } else {
          // í•„í„° ë¯¸ì§€ì› ë¸Œë¼ìš°ì €: ë¨¼ì € ê·¸ë¦° ë’¤ í”½ì…€ ë³€í™˜
          ctx.drawImage(video, 0, 0, outW, outH);
          const img = ctx.getImageData(0, 0, outW, outH);
          const d = img.data;
          for (let i = 0; i < d.length; i += 4) {
            const y = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
            d[i] = d[i+1] = d[i+2] = y;
          }
          ctx.putImageData(img, 0, 0);
        }

        statusEl.textContent = "â³ encodingâ€¦";
        // PNG ëŒ€ì‹  JPEG(í’ˆì§ˆ 0.8)ë¡œ ìš©ëŸ‰ ëŒ€í­ ì¶•ì†Œ
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
        if (!blob) throw new Error("blob-null");

        const path = `uploads/capture_${Date.now()}_bw.jpg`;
        const url = await uploadWithProgress(path, blob);
        statusEl.textContent = "âœ… uploaded: " + path;
        alert("ì—…ë¡œë“œ ì™„ë£Œ!\n" + url);
        console.log("Download URL:", url);
      } catch (e) {
        statusEl.textContent = "âŒ upload failed";
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (e.code || e.message));
        console.error(e);
      }
    });
  </script>
</body>
</html>
