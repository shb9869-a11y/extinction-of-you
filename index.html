<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion Trails (TRUE BW + Capture Upload)</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    /* í™”ë©´ ë³´ê¸°ëŠ” CSSë¡œ ë¬´ì¡°ê±´ í‘ë°± ë³´ì¥ */
    #view { position:fixed; inset:0; width:100vw; height:100vh; display:block; filter:grayscale(100%); }
    #ui { position:fixed; right:20px; bottom:24px; z-index:10; }
    button { padding:10px 16px; font-weight:700; border:0; border-radius:10px; cursor:pointer; }
    #capture-btn { background:#fff; color:#000; }
    #status { position:fixed; left:12px; bottom:12px; z-index:10; color:#fff; font:14px/1.3 system-ui, sans-serif; opacity:.9 }
  </style>
</head>
<body>
  <!-- ë¹„ë””ì˜¤ëŠ” ìˆ¨ê¸°ê³  ìº”ë²„ìŠ¤ë§Œ í‘œì‹œ -->
  <video id="video" autoplay playsinline muted style="display:none"></video>
  <canvas id="view"></canvas>

  <div id="ui"><button id="capture-btn">ğŸ“¸ Capture & Upload</button></div>
  <div id="status">ready</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // ğŸ”§ Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyC_WKhRUa4TslEKKLS46qGChSQ8A3Tanks",
      authDomain: "we-are-moim.firebaseapp.com",
      projectId: "we-are-moim",
      storageBucket: "we-are-moim.appspot.com",
      messagingSenderId: "709309645608",
      appId: "1:709309645608:web:2e04e871acb46c4adb861d"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    const video = document.getElementById('video');
    const canvas = document.getElementById('view');
    const ctx = canvas.getContext('2d', { alpha:false });
    const captureBtn = document.getElementById('capture-btn');
    const statusEl = document.getElementById('status');

    // ----- ì”ìƒ íš¨ê³¼ ì„¤ì • -----
    const TRAIL_COUNT = 6;
    const ALPHAS = [0.35,0.25,0.18,0.12,0.08,0.05];
    const SCALE = 0.6;
    const JITTER = 1.2;

    const trailPool = [];
    let w=0,h=0,sw=0,sh=0;

    // iOS ìë™ì¬ìƒ ë³´ì¡°
    document.body.addEventListener('click', () => video.play(), { once:true });

    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false })
      .then(stream => { video.srcObject = stream; })
      .catch(err => alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message));

    video.addEventListener('loadedmetadata', () => {
      resize();
      requestAnimationFrame(loop);
    });
    window.addEventListener('resize', resize);

    function resize(){
      if(!video.videoWidth || !video.videoHeight) return;
      w = canvas.width  = window.innerWidth;
      h = canvas.height = window.innerHeight;

      const vw = video.videoWidth, vh = video.videoHeight;
      const s = Math.max(w/vw, h/vh);
      sw = Math.round(vw * s);
      sh = Math.round(vh * s);

      const tw = Math.max(1, Math.round(sw * SCALE));
      const th = Math.max(1, Math.round(sh * SCALE));
      while (trailPool.length < TRAIL_COUNT) {
        const c = document.createElement('canvas');
        c.width = tw; c.height = th;
        trailPool.push(c);
      }
      trailPool.forEach(c => { c.width = tw; c.height = th; });
    }

    // â›³ í”½ì…€ í‘ë°± ë³€í™˜(ì €ì¥ìš© ê°•ì œ) â€” ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘
    function forceGrayscaleOnCanvas() {
      const img = ctx.getImageData(0, 0, w, h);
      const d = img.data;
      for (let i = 0; i < d.length; i += 4) {
        const y = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        d[i] = d[i+1] = d[i+2] = y; // R=G=B=y
      }
      ctx.putImageData(img, 0, 0);
    }

    function loop(){
      if (sw && sh) {
        const x = (w - sw) >> 1;
        const y = (h - sh) >> 1;

        // í˜„ì¬ í”„ë ˆì„ì„ ë¨¼ì € ê·¸ë¦¼ (ìƒ‰ìƒ ê·¸ëŒ€ë¡œ)
        ctx.drawImage(video, x, y, sw, sh);

        // trail ì €ì¥ (ì¶•ì†Œ ìº”ë²„ìŠ¤)
        const last = trailPool[trailPool.length-1];
        if (last) {
          const tctx = last.getContext('2d');
          tctx.drawImage(video, 0, 0, last.width, last.height);
          trailPool.unshift(trailPool.pop());
        }

        // trail ë§ì”Œìš°ê¸° (ì˜¤í”„ì…‹ + ì•ŒíŒŒ)
        for (let i=0; i<trailPool.length; i++){
          const src = trailPool[i];
          if (!src) continue;
          ctx.globalAlpha = (ALPHAS[i] ?? 0.08);
          const off = (i+1) * JITTER;
          ctx.drawImage(src, x+off, y+off, sw, sh);
        }
        ctx.globalAlpha = 1;

        // ğŸ”’ ì €ì¥ìš© ë³´ì¥ í‘ë°±í™” (í™”ë©´ë„ í‘ë°±ì´ì§€ë§Œ, í”½ì…€ ë ˆë²¨ë¡œ í•œ ë²ˆ ë”)
        forceGrayscaleOnCanvas();
      }
      requestAnimationFrame(loop);
    }

    // ----- ì—…ë¡œë“œ í•¨ìˆ˜ -----
    function uploadWithProgress(path, blob) {
      return new Promise((resolve, reject) => {
        const fileRef = ref(storage, path);
        const metadata = { contentType: 'image/jpeg' };
        const task = uploadBytesResumable(fileRef, blob, metadata);

        task.on('state_changed',
          (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            statusEl.textContent = `â³ uploadingâ€¦ ${pct}%`;
          },
          (err) => reject(err),
          async () => { const url = await getDownloadURL(fileRef); resolve(url); }
        );
      });
    }

    // ----- ìº¡ì²˜ & ì—…ë¡œë“œ -----
    captureBtn.addEventListener('click', async () => {
      try {
        statusEl.textContent = "â³ encodingâ€¦";
        // í˜„ì¬ ìº”ë²„ìŠ¤ í”½ì…€ì€ ì´ë¯¸ forceGrayscaleOnCanvas()ë¡œ í‘ë°±í™”ë¨
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
        if (!blob) throw new Error("blob-null");

        const path = `uploads/capture_${Date.now()}_trail_bw.jpg`;
        const url = await uploadWithProgress(path, blob);
        statusEl.textContent = "âœ… uploaded: " + path;
        alert("ì—…ë¡œë“œ ì™„ë£Œ!\n" + url);
        console.log("Download URL:", url);
      } catch (e) {
        statusEl.textContent = "âŒ upload failed";
        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + (e.code || e.message));
        console.error(e);
      }
    });
  </script>
</body>
</html>
