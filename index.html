<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --frame: clamp(16px, 4vmin, 40px);
    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  body{font-family:Impact, "Anton", "Arial Black", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif;}

  /* 배경 카메라 (웰컴 이후부터만 사용) */
  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  /* 상단 런처 (일반 시점에서만 보이게, 프리셋/타이틀/인트로시 숨김) */
  .launcher{position:fixed;z-index:50;color:#fff;opacity:.9}
  #docLauncher{left:calc(var(--frame) + var(--safe-l)); top:calc(var(--frame) + var(--safe-t));}
  #mapLauncher{right:calc(var(--frame) + var(--safe-r)); top:calc(var(--frame) + var(--safe-t));}
  .uiBtn{background:#000;color:#fff;border:1px solid #444;font-size:var(--fs-strong);
    padding:.5em .9em;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.flat{border:none;background:transparent;text-decoration:underline;text-underline-offset:3px}
  .hide{display:none !important;}

  /* 권한 오버레이 */
  #overlay{
    position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
    padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
    color:#fff;background:rgba(0,0,0,.85)
  }
  #overlayContent{max-width:min(92vw, 72ch);font-family:"Courier New", ui-monospace, monospace;line-height:1.7;text-align:center}
  .tip{opacity:.8;font-size:var(--fs-small)}

  /* 프리셋: SLEEEEEP 패턴 풀스크린 */
  #preset{position:fixed;inset:0;z-index:250;background:#000;display:none;cursor:pointer}
  #presetCanvas{position:absolute;left:0;top:0;width:100%;height:100%}

  /* 풀스크린 타이틀 (INTRODUCTION / SLEEPS / SILENCE) */
  #titleScreen{
    position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center;
    background:#000; color:#fff; text-align:center; padding:calc(var(--safe-t)) calc(var(--safe-r)) calc(var(--safe-b)) calc(var(--safe-l));
  }
  #titleText{font-weight:900; letter-spacing:.06em; line-height:1.05;
    font-size:clamp(24px, 10vmin, 96px);}

  /* 인트로 카드 */
  #introOverlay{
    position:fixed; inset:0; z-index:210; display:none; align-items:center; justify-content:center;
    color:#fff; background:rgba(0,0,0,.75); padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;
  }
  .introCard{ width:min(92vw, 860px); font-family:"Courier New", ui-monospace, monospace; }
  .introCard h2{margin:.2em 0 .6em 0; font-size:clamp(16px, 3.2vmin, 24px); letter-spacing:.1em; text-align:center;}
  .introCard p, .introCard li{font-size:var(--fs-body); line-height:1.8;}
  .introCard ol{padding-left:1.2em; margin:.4em 0 1em 0;}
  .count{margin-top:10px; text-align:center; font-size:var(--fs-strong);}

  /* 페이드 */
  .fade-enter{opacity:0; transition:opacity .45s ease}
  .fade-enter.show{opacity:1}
  .fade-leave{opacity:1; transition:opacity .45s ease}
  .fade-leave.hide{opacity:0}
</style>
</head>
<body>
  <!-- 카메라 배경 (웰컴 이후) -->
  <canvas id="view"></canvas>

  <!-- 런처 (일반 화면에서만) -->
  <button id="docLauncher" class="launcher uiBtn">DOCUMENT</button>
  <button id="mapLauncher" class="launcher uiBtn">MAP</button>

  <!-- 권한 오버레이 -->
  <div id="overlay">
    <div id="overlayContent">
      <div style="margin-bottom:10px">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="uiBtn">화면을 탭하여 카메라·동작(센서)·오디오를 허용해주세요</button>
      <div class="tip">승인 후 ‘SLEEEEE…’ 프리셋 화면이 뜹니다.</div>
    </div>
  </div>

  <!-- 프리셋 -->
  <div id="preset" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <!-- 웰컴 -->
  <div id="overlayWelcome" class="hide" style="position:fixed;inset:0;z-index:220;display:flex;align-items:center;justify-content:center;color:#fff;background:rgba(0,0,0,.55);padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;">
    <div style="text-align:center;max-width:min(92vw, 680px);">
      <div style="letter-spacing:.1em;margin-bottom:12px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div style="font-size:clamp(16px,3.6vmin,28px);font-weight:900;letter-spacing:.06em;line-height:1.1;margin-bottom:14px;">
        Welcome to<br>
        SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP,<br>
        SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP
      </div>
      <button id="goIntro" class="uiBtn flat">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- 인트로(텍스트+20초 카운트다운) -->
  <div id="introOverlay"><div class="introCard">
    <h2>INTRODUCTION</h2>
    <p>지금 이 화면을 보고 있는 당신,<br>
    주변의 소리에 천천히 귀를 기울이며 이 공간에 진입해주세요.<br>
    이제부터 당신은 약 30분 동안, 짧은 단잠에 들게 됩니다.</p>

    <ol>
      <li>세계관 설명입니다.</li>
      <li>우리는 언제나 타자와 함께 존재해왔습니다.</li>
      <li>그러나 어느 순간, 타자는 ‘너’가 아닌 ‘그것’이 되기 시작했습니다.</li>
      <li>‘그것’으로 전락한 ‘너’들은 서서히 우리의 내면 속에서 희미해져 갑니다.</li>
      <li>마치 꿈 속에서 분명 누군가를 만난 것 같은데, 그게 누구인지 떠오르지 않는 것처럼 말이죠.</li>
      <li>자, 이곳은 바로, 그 ‘너’가 사라져버린 누군가의 내면 세계입니다.</li>
    </ol>

    <p>의식이 서서히 희미해져가는 지금,</p>
    <p>당신은 이 내면의 미로를 거닐며,</p>
    <p>천천히 눈을 감고, 이 세상에서 사라져버린 ‘너’의 이야기에 귀를 기울입니다.</p>

    <div class="count">The door will close in <span id="countNum">20</span> seconds.</div>
  </div></div>

  <!-- 풀스크린 타이틀 -->
  <div id="titleScreen"><div id="titleText"></div></div>

<script>
(() => {
  /* Manifest (홈화면용) */
  (function injectManifest(){
    const manifest = {"name":"SLEEEEEP","short_name":"SLEEEEEP","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  /* 실제 가시 높이 */
  function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppH(); addEventListener('resize', setAppH, {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppH, 50)); }

  const qs = s => document.querySelector(s);
  const overlay = qs('#overlay');
  const permBtn = qs('#permGateBtn');
  const preset = qs('#preset');
  const presetCanvas = qs('#presetCanvas');
  const welcome = qs('#overlayWelcome');
  const goIntroBtn = qs('#goIntro');
  const intro = qs('#introOverlay');
  const countNum = qs('#countNum');
  const titleScreen = qs('#titleScreen');
  const titleText = qs('#titleText');
  const view = qs('#view');
  const docBtn = qs('#docLauncher');
  const mapBtn = qs('#mapLauncher');

  let camStream = null, camOn = false, vctx = null, proc = null, pctx = null, camVideo = null, ZOOM = 1.0;

  /* -------- 권한 게이트: 카메라/동작/오디오 사전 승인 -------- */
  async function requestMotionPermissions(){
    const needsIOS = typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function';
    try{
      if(needsIOS){
        const r1=await DeviceOrientationEvent.requestPermission().catch(()=> 'denied');
        if(r1!=='granted') return false;
      }
    }catch{}
    return true;
  }

  async function gate(){
    try{
      await requestMotionPermissions(); // 동작 센서
      // 카메라 "승인만" 받아둔다 (표시는 안 함)
      camStream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}}, audio:false
      });
    }catch(e){ console.warn('permission error:', e); }
    // 권한창 닫고 → 프리셋 표시
    overlay.style.display='none';
    showPreset();
  }

  ['pointerdown','touchstart','click','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{ if(overlay.style.display!=='none') gate(); }, {once:true, capture:true, passive:true});
  });
  permBtn.addEventListener('click',(e)=>{ e.preventDefault(); gate(); },{passive:false});

  /* -------- 프리셋 (풀스크린 S/E 패턴) -------- */
  function drawPreset(){
    const dpr = window.devicePixelRatio||1;
    const w = preset.clientWidth, h = preset.clientHeight;
    presetCanvas.width = w*dpr; presetCanvas.height = h*dpr;
    const ctx = presetCanvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#fff';

    // 컬럼 수는 화면비에 따라 가변, E는 세로로 큼직하게
    const base = Math.min(w,h);
    const colGutter = base*0.06;
    const colWidth = base*0.18;
    const columns = Math.max(3, Math.floor((w + colGutter)/(colWidth + colGutter)));
    const usableW = columns*colWidth + (columns-1)*colGutter;
    const left = (w-usableW)/2;

    // 폰트 크기: 컬럼 폭 기준으로 E가 딱 차도록
    const fontSize = colWidth*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font = `900 ${fontSize}px Impact, Anton, "Arial Black", system-ui, sans-serif`;

    for(let c=0;c<columns;c++){
      const x = left + c*(colWidth+colGutter) + colWidth/2;
      // 맨 왼/오른쪽은 'S' 세로 배치, 나머지는 'E' 연속
      const isSide = (c===0 || c===columns-1);
      const step = fontSize*1.35;
      const startY = (h % step)/2;

      for(let y=startY; y<h; y+=step){
        const ch = isSide ? ( (Math.round(y/step)%6===0) ? 'S' : 'E') : 'E';
        ctx.fillText(ch, x, y);
      }
    }
  }
  function showPreset(){
    hideAllUI(true);
    preset.style.display='block';
    drawPreset();
  }
  addEventListener('resize', ()=>{ if(preset.style.display==='block') drawPreset(); }, {passive:true});
  preset.addEventListener('click', ()=>{ // 프리셋 → 웰컴
    preset.style.display='none';
    startCamera(); // 이 시점부터 카메라 사용
    showWelcome();
  }, {passive:true});

  /* -------- 웰컴 → 인트로 -------- */
  function showWelcome(){
    welcome.classList.remove('hide');
  }
  goIntroBtn.addEventListener('click', ()=>{
    welcome.classList.add('hide');
    showIntro();
  }, {passive:true});

  /* -------- 카메라 (웰컴 이후만 렌더) -------- */
  function startCamera(){
    if(camOn || !camStream) return;
    camOn = true;
    camVideo = document.createElement('video');
    camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;
    camVideo.srcObject = camStream;
    vctx = view.getContext('2d',{alpha:false});
    proc = document.createElement('canvas'); pctx = proc.getContext('2d',{willReadFrequently:true});
    resizeCam(); loopCam();
  }
  function resizeCam(){
    const dpr = window.devicePixelRatio||1;
    const w = window.innerWidth, h = window.innerHeight;
    view.width=w*dpr; view.height=h*dpr; vctx.setTransform(dpr,0,0,dpr,0,0);
    const scale = matchMedia('(orientation: landscape)').matches? 0.86 : 0.9;
    proc.width=Math.floor(w*scale); proc.height=Math.floor(h*scale);
  }
  addEventListener('resize', ()=>{ if(camOn) setTimeout(resizeCam,50); }, {passive:true});

  function loopCam(){
    if(!camOn) return;
    requestAnimationFrame(loopCam);
    const W=view.width/(window.devicePixelRatio||1), H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;

    // 페이드한 흑백 카메라 배경
    pctx.fillStyle='rgba(0,0,0,.14)'; pctx.fillRect(0,0,PW,PH);
    if(camVideo.readyState>=2){
      const vw=camVideo.videoWidth||0, vh=camVideo.videoHeight||0;
      if(vw&&vh){
        const cover=Math.max(PW/vw, PH/vh)*ZOOM;
        const dw=vw*cover, dh=vh*cover, dx=(PW-dw)/2, dy=(PH-dh)/2;
        pctx.globalAlpha=.7; pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1;
        const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;
        for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.drawImage(proc,0,0,W,H);
  }

  /* -------- 인트로 (20s) -------- */
  function showIntro(){
    hideAllUI(true);
    intro.style.display='flex';
    let count=20;
    countNum.textContent = count;
    const t = setInterval(()=>{
      count--;
      if(count>=0) countNum.textContent = count;
      if(count<=0){
        clearInterval(t);
        intro.style.display='none';
        runChapters();
      }
    },1000);
  }

  /* -------- 챕터 타이틀 풀스크린 -------- */
  const chapters = [
    'INTRODUCTION',          // 이미 봤지만, 시퀀스 첫 화면으로 한 번 더 풀스크린 라벨링
    'THE FIRST SLEEP',
    'THE SECOND SLEEP',
    'THE THIRD SLEEP',
    'THE FOURTH SLEEP',
    'SILENCE'
  ];
  async function runChapters(){
    for(const label of chapters){
      await showTitle(label, 1500);
    }
    // 끝나면 일반 UI 복귀 (원하면 여기서 MAP/DOC 노출)
    hideAllUI(false);
  }
  function showTitle(text, hold=1500){
    return new Promise(res=>{
      titleText.textContent = text;
      titleScreen.style.display='flex';
      titleScreen.className='fade-enter show';
      setTimeout(()=>{ // 페이드 아웃
        titleScreen.className='fade-leave';
        requestAnimationFrame(()=>{ titleScreen.classList.add('hide'); });
        setTimeout(()=>{
          titleScreen.style.display='none';
          titleScreen.className='';
          res();
        }, 450);
      }, hold);
    });
  }

  /* -------- UI 표시/숨김 제어 -------- */
  function hideAllUI(hide){
    docBtn.classList.toggle('hide', hide);
    mapBtn.classList.toggle('hide', hide);
  }

  /* 초기 상태: 권한 오버레이 표시 */
  overlay.style.display='flex';
})();
</script>
</body>
</html>
