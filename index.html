<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Dialogue into Silence — Camera+Audio+Pixel Maze+Docs</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dialogue into Silence">
<link rel="manifest" href="/manifest.webmanifest">

<style>
  :root{
    --frame:40px; --ui-gap:8px;
    --fs-body:clamp(12px,2.2vmin,16px);
    --fs-strong:clamp(14px,2.8vmin,20px);
    --fs-small:clamp(10px,1.7vmin,13px);
    --pad-line:clamp(4px,0.9vmin,8px);
    --pad-btn-y:clamp(6px,1.1vmin,10px);
    --pad-btn-x:clamp(10px,1.8vmin,20px);
    --box-alpha:.4;
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden;touch-action:manipulation;font-family:"Courier New",monospace}

  #view{position:fixed;inset:0;display:block;z-index:0}
  .frameBox{position:fixed;left:calc(var(--frame)+env(safe-area-inset-left));top:calc(var(--frame)+env(safe-area-inset-top));right:calc(var(--frame)+env(safe-area-inset-right));bottom:calc(var(--frame)+env(safe-area-inset-bottom));border:1px solid #000;pointer-events:none;z-index:50;}

  .uiBtn{background:rgba(0,0,0,var(--box-alpha));color:#fff;border:1px solid #000;font-size:var(--fs-strong);padding:var(--pad-btn-y)var(--pad-btn-x);white-space:nowrap;cursor:pointer;user-select:none;}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}
  .uiBtn[disabled]{opacity:.5;pointer-events:none}

  .controls{position:fixed;right:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-right));bottom:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-bottom));z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-size:var(--fs-small)}
  .btn-capture{position:fixed;left:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-left));bottom:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-bottom));z-index:150;}

  #mapLauncher{position:fixed;right:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-right));top:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-top));z-index:280;}
  #docLauncher{position:fixed;left:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-left));top:calc(var(--frame)+var(--ui-gap)+env(safe-area-inset-top));z-index:280;}

  #overlay{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;color:#fff;background:rgba(0,0,0,.72)}
  #overlayContent{pointer-events:auto;line-height:1.7;font-size:var(--fs-body);max-width:min(72ch,calc(100vw-(var(--frame)*2)));max-height:calc(100vh-(var(--frame)*2));overflow:hidden;text-align:left}
  body.locked [data-lock]{pointer-events:none!important}
  /* 터치 강제 활성화 */
  #overlay,#overlay *{pointer-events:auto!important}
  #overlay{-webkit-user-select:none;-webkit-touch-callout:none;}

  .line{display:inline;background:rgba(0,0,0,var(--box-alpha));color:#fff;padding:calc(var(--pad-line)*0.8)var(--pad-line);box-decoration-break:clone;-webkit-box-decoration-break:clone}
  .lineWrap{margin:6px 0}
  .fade{opacity:1;transition:opacity .45s ease}
  .fade.hidden{opacity:0}

  #goodnight{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:250;display:none;text-align:center;font-size:var(--fs-strong);color:#fff;background:rgba(0,0,0,var(--box-alpha));padding:var(--pad-btn-y)var(--pad-btn-x);white-space:nowrap;transition:opacity .6s ease}
  #goodnight.show{display:block;opacity:1}#goodnight.fadeout{opacity:0}
  #cutin{position:fixed;inset:0;z-index:260;display:none;align-items:center;justify-content:center;background:#000;color:#fff;text-align:center}
  #cutin.show{display:flex;opacity:1;transition:opacity .45s ease}#cutin.fadeout{opacity:0}
  #cutinText{font-size:clamp(24px,8vmin,64px);letter-spacing:.02em;line-height:1.2;padding:0 .2em}
  #hint{position:fixed;left:50%;bottom:calc(var(--frame)+6px+env(safe-area-inset-bottom));transform:translateX(-50%);z-index:500;background:rgba(0,0,0,var(--box-alpha));color:#fff;border:1px solid #333;padding:8px 12px;font-size:var(--fs-small);display:none;white-space:pre-wrap;text-align:center;}
  @media (orientation:landscape){:root{--frame:32px;}}
</style>
</head>
<body>
<canvas id="view"></canvas>
<div class="frameBox" aria-hidden="true"></div>

<div class="controls">
  <button class="uiBtn small" id="zoomOut" data-lock>–</button>
  <div class="readout"><span id="zoomVal">1.0×</span></div>
  <button class="uiBtn small" id="zoomIn" data-lock>+</button>
</div>
<button id="captureBtn" class="uiBtn small btn-capture" data-lock>CAPTURE</button>
<button id="docLauncher" class="uiBtn small" data-lock>DOCUMENT</button>
<button id="mapLauncher" class="uiBtn small" data-lock>MAP</button>

<div id="overlay" class="fade">
  <div id="overlayContent" class="fade" style="text-align:left">
    <button id="permGateBtn" class="uiBtn" style="width:min(80vw,420px)">화면을 탭하여 카메라·동작(센서)·마이크를 허용해주세요</button>
    <div class="tip" style="text-align:center">허용 후 WELCOME 화면으로 이동합니다.</div>
  </div>
</div>

<div id="goodnight">GOOD NIGHT, HAVE A NICE DREAM</div>
<div id="cutin"><div id="cutinText">FIRST SILENCE</div></div>
<div id="hint"></div>

<script>
(async()=>{
const qs=s=>document.querySelector(s);
const qsa=s=>Array.from(document.querySelectorAll(s));
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
/* onTap helper (iOS click 미발화 방지) */
const onTap=(el,handler)=>{
 if(!el)return;
 el.addEventListener('click',handler,{passive:true});
 el.addEventListener('pointerup',handler,{passive:true});
 el.addEventListener('touchend',e=>{e.preventDefault();handler(e);},{passive:false});
};

let phase='gate';
function setLocked(on){
 qsa('[data-lock]').forEach(el=>{
   if(on){el.setAttribute('disabled','');el.setAttribute('aria-disabled','true');}
   else{el.removeAttribute('disabled');el.removeAttribute('aria-disabled');}
 });
 document.body.classList.toggle('locked',!!on);
}
setLocked(true);

let audioCtx=null,mixBus,sfxBus;
async function ensureAudio(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();mixBus=audioCtx.createGain();mixBus.connect(audioCtx.destination);sfxBus=audioCtx.createGain();sfxBus.gain.value=0.7;sfxBus.connect(mixBus);}
async function resumeAudio(){await ensureAudio();if(audioCtx.state==='suspended')await audioCtx.resume();}
function beep(){if(!audioCtx)return;const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.setValueAtTime(880,t);g.gain.setValueAtTime(0.0001,t);g.gain.linearRampToValueAtTime(0.5,t+0.01);g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);o.connect(g).connect(sfxBus);o.start(t);o.stop(t+0.14);}

const view=qs('#view'),vctx=view.getContext('2d',{alpha:false});
const PROC_SCALE=0.8;let ZOOM=1.0;
const TRAIL_ALPHA=0.12,GLOBAL_ALPHA=0.7,ZOOM_MIN=0.5,ZOOM_MAX=3.0,ZOOM_STEP=0.1;
const zoomVal=qs('#zoomVal');const updateZoom=()=>zoomVal.textContent=ZOOM.toFixed(1)+'×';
qs('#zoomIn').onclick=()=>{ZOOM=clamp(ZOOM+ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom();beep();};
qs('#zoomOut').onclick=()=>{ZOOM=clamp(ZOOM-ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom();beep();};
updateZoom();

const camVideo=document.createElement('video');camVideo.autoplay=true;camVideo.playsInline=true;camVideo.muted=true;
const proc=document.createElement('canvas');const pctx=proc.getContext('2d',{willReadFrequently:true});
let camStream=null;
async function attachCamera(){if(camStream)return;camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});camVideo.srcObject=camStream;await camVideo.play().catch(()=>{});}
function resizeAll(){const dpr=devicePixelRatio||1,w=innerWidth,h=innerHeight;view.width=w*dpr;view.height=h*dpr;vctx.setTransform(dpr,0,0,dpr,0,0);const scale=matchMedia('(orientation:landscape)').matches?PROC_SCALE*0.9:PROC_SCALE;proc.width=Math.floor(w*scale);proc.height=Math.floor(h*scale);}addEventListener('resize',()=>setTimeout(resizeAll,50),{passive:true});resizeAll();
(function loop(){requestAnimationFrame(loop);const W=view.width/(devicePixelRatio||1),H=view.height/(devicePixelRatio||1),PW=proc.width,PH=proc.height;pctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`;pctx.fillRect(0,0,PW,PH);if(camVideo.readyState>=2){const vw=camVideo.videoWidth,vh=camVideo.videoHeight;if(vw&&vh){const base=Math.max(PW/vw,PH/vh),sc=base*ZOOM;const dw=vw*sc,dh=vh*sc,dx=(PW-dw)/2,dy=(PH-dh)/2;pctx.globalAlpha=GLOBAL_ALPHA;pctx.drawImage(camVideo,dx,dy,dw,dh);pctx.globalAlpha=1.0;const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;d[i]=d[i+1]=d[i+2]=g;}pctx.putImageData(frame,0,0);}}vctx.drawImage(proc,0,0,W,H);})();

async function requestMotionPermissions(){try{if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){await DeviceOrientationEvent.requestPermission();}}catch{}try{if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){await DeviceMotionEvent.requestPermission();}}catch{}}

const overlay=qs('#overlay'),overlayContent=qs('#overlayContent'),permGateBtn=qs('#permGateBtn');
async function runPermissionGate(){if(phase!=='gate')return;await resumeAudio();beep();try{await requestMotionPermissions();await attachCamera();}catch(e){console.warn(e);}phase='welcome';overlayContent.innerHTML=`<div style="text-align:center"><button id="welcomeBtn" class="uiBtn" style="min-width:260px">WELCOME TO ‘DIALOGUE INTO SILENCE’</button><div class="tip">WELCOME을 눌러 시작하세요.</div></div>`;onTap(qs('#welcomeBtn'),()=>{beep();overlay.style.display='none';setLocked(false);});}
onTap(permGateBtn,runPermissionGate);
onTap(overlay,(e)=>{if(e.target===overlay&&phase==='gate')runPermissionGate();});
let tried=false;const tryAuto=e=>{if(tried||phase!=='gate')return;tried=true;runPermissionGate();};
document.addEventListener('touchend',tryAuto,{passive:false,once:true});
document.addEventListener('pointerup',tryAuto,{passive:true,once:true});
document.addEventListener('click',tryAuto,{passive:true,once:true});

document.getElementById('overlay').style.display='flex';
})();
</script>
</body>
</html>