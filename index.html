<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera â€“ BW + Strong Trail + Frame</title>

<!-- iOS í’€ìŠ¤í¬ë¦° ì•± ëª¨ë“œ/PWA íŒíŠ¸ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Camera Trail">
<meta name="theme-color" content="#0b0b0b">
<link rel="manifest" href="app.webmanifest"><!-- manifestì—ì„œ display: "standalone" ê¶Œì¥ -->

<style>
  :root{ color-scheme: dark; }
  html,body{
    margin:0; height:100%;
    background:#000; overflow:hidden;
    overscroll-behavior:none;
    -webkit-touch-callout:none;
    -webkit-user-select:none; user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
  /* ì£¼ì†Œì°½ ë†’ì´ë³€ë™ ëŒ€ì‘: 100svh */
  #app{
    position:fixed; inset:0;
    width:100vw; height:100svh; /* iOS 16+ ì•ˆì •ì  ë·°í¬íŠ¸ */
    background:#000;
    padding-top:env(safe-area-inset-top);
    padding-right:env(safe-area-inset-right);
    padding-bottom:env(safe-area-inset-bottom);
    padding-left:env(safe-area-inset-left);
    touch-action:none;
  }
  #view{ width:100%; height:100%; display:block; }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:12px 18px; border:0; border-radius:999px;
    font:700 16px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff; background:#12a150; z-index:10; display:none;
  }
  #hint{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    color:#fff; background:rgba(0,0,0,.55); padding:8px 12px; border-radius:8px;
    font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:none;
    text-align:center;
  }
</style>
</head>
<body>
  <div id="app">
    <canvas id="view"></canvas>
    <button id="start">ì¹´ë©”ë¼ ì‹œì‘</button>
    <div id="hint">
      iOS ê¶Œí•œ/ìë™ì¬ìƒìœ¼ë¡œ ì²« íƒ­ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”.<br/>
      ì£¼ì†Œì°½ì„ ì™„ì „íˆ ìˆ¨ê¸°ë ¤ë©´ í™ˆ í™”ë©´ì— ì¶”ê°€(PWA)ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.
    </div>
  </div>

<script>
(async ()=>{
  const app  = document.getElementById('app');
  const view = document.getElementById('view');
  const vctx = view.getContext('2d', { alpha:false });
  const startBtn = document.getElementById('start');
  const hint = document.getElementById('hint');

  // ğŸ›ï¸ ì„¤ì •ê°’
  const PROC_SCALE   = 0.6;       // ë‚´ë¶€ ì²˜ë¦¬ í•´ìƒë„ (0.4~0.8)
  const TRAIL_ALPHA  = 0.004;     // ğŸ”¥ ì•„ì£¼ ê°•í•œ ì”ìƒ(ë‚®ì„ìˆ˜ë¡ ì˜¤ë˜ ë‚¨ìŒ)
  const FRAME_MARGIN = 40;        // í”„ë ˆì„ ì—¬ë°±
  const FRAME_COLOR  = "#ffffff"; // í°ìƒ‰ ì‹¤ì„ 
  const FRAME_WIDTH  = 0.5;       // ë§¤ìš° ì–‡ê²Œ(px)

  // ì¹´ë©”ë¼ ë¹„ë””ì˜¤
  const camVideo = document.createElement('video');
  camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;

  // ì²˜ë¦¬ìš© ìº”ë²„ìŠ¤
  const proc = document.createElement('canvas');
  const pctx = proc.getContext('2d', { alpha:false });

  function resizeAll(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = app.getBoundingClientRect();
    const w = Math.max(1, Math.floor(rect.width));
    const h = Math.max(1, Math.floor(rect.height));

    // ë©”ì¸ ìº”ë²„ìŠ¤
    view.style.width = w+'px'; view.style.height = h+'px';
    view.width = Math.floor(w * dpr); view.height = Math.floor(h * dpr);
    vctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // ì²˜ë¦¬ ìº”ë²„ìŠ¤
    proc.width  = Math.max(1, Math.floor(w * PROC_SCALE));
    proc.height = Math.max(1, Math.floor(h * PROC_SCALE));
  }
  addEventListener('resize', resizeAll);
  addEventListener('orientationchange', ()=>setTimeout(resizeAll, 200));
  resizeAll();

  async function attachCamera(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ ideal:'environment' },
          // í•´ìƒë„ íŒíŠ¸(ê°€ëŠ¥ ì‹œ)
          width:{ ideal: 1920 }, height:{ ideal: 1080 }
        },
        audio:false
      });
      camVideo.srcObject = s;
      await camVideo.play();
    }catch(e){
      // í´ë°±
      const s2 = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      camVideo.srcObject = s2;
      await camVideo.play();
    }
  }

  // iOS ì£¼ì†Œì°½ ìµœì†Œí™”/í’€ìŠ¤í¬ë¦° ì‹œë„ (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”)
  async function goFullscreenIfPossible(){
    try{
      if (document.fullscreenElement) return;
      // iOS 16+ Fullscreen API ì§€ì›
      if (app.requestFullscreen) await app.requestFullscreen();
      // ì¶”ê°€ ìŠ¤í¬ë¡¤ íŠ¸ë¦­ (êµ¬í˜•)
      setTimeout(()=>scrollTo(0,1), 50);
    }catch(e){}
  }

  // í™”ë©´ ê¹¨ì§ ë°©ì§€: íƒ­ ì‹œ ì£¼ì†Œì°½ ë‚´ë ¤ê°€ë©´ ì¬ê³„ì‚°
  let visTimer = null;
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden){
      camVideo.play().catch(()=>{});
      clearTimeout(visTimer);
      visTimer = setTimeout(resizeAll, 120);
    }
  });

  let rafId = 0;
  function loop(){
    rafId = requestAnimationFrame(loop);

    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = app.getBoundingClientRect();
    const W = rect.width;
    const H = rect.height;
    const PW = proc.width, PH = proc.height;

    // 1) ì”ìƒ í˜ì´ë“œ
    pctx.fillStyle = `rgba(0,0,0,${TRAIL_ALPHA})`;
    pctx.fillRect(0,0,PW,PH);

    // 2) ì¹´ë©”ë¼ í”„ë ˆì„ ë“œë¡œìš°
    if (camVideo.readyState >= 2){
      const vw = camVideo.videoWidth || 0, vh = camVideo.videoHeight || 0;
      if (vw && vh){
        const scale = Math.max(PW / vw, PH / vh); // cover
        const dw = vw * scale, dh = vh * scale;
        const dx = (PW - dw) / 2, dy = (PH - dh) / 2;
        pctx.drawImage(camVideo, dx, dy, dw, dh);

        // 3) í‘ë°± ë³€í™˜ (ë¹ ë¥¸ ë£¨í”„)
        const frame = pctx.getImageData(0,0,PW,PH);
        const d = frame.data;
        for (let i=0; i<d.length; i+=4){
          const r=d[i], g=d[i+1], b=d[i+2];
          const gray = (0.299*r + 0.587*g + 0.114*b)|0;
          d[i]=d[i+1]=d[i+2]=gray;
        }
        pctx.putImageData(frame,0,0);
      }
    }

    // 4) ë©”ì¸ ìº”ë²„ìŠ¤ì— ì—…ìŠ¤ì¼€ì¼
    // (ì •í™•í•œ í”½ì…€ì„ ìœ„í•´ ì§ì ‘ í¬ê¸° ì‚¬ìš© + dpr ë³€í™˜ì€ setTransformìœ¼ë¡œ ì²˜ë¦¬)
    vctx.clearRect(0,0,W,H);
    vctx.drawImage(proc, 0, 0, W, H);

    // 5) í°ìƒ‰ ì‹¤ì„  í”„ë ˆì„
    vctx.save();
    vctx.strokeStyle = FRAME_COLOR;
    vctx.lineWidth = FRAME_WIDTH;
    vctx.setLineDash([]); // ì‹¤ì„ 
    vctx.strokeRect(FRAME_MARGIN, FRAME_MARGIN, W-2*FRAME_MARGIN, H-2*FRAME_MARGIN);
    vctx.restore();
  }

  async function startAll(){
    try{
      await attachCamera();
      await goFullscreenIfPossible(); // ì²« ì œìŠ¤ì²˜ ì‹œ í’€ìŠ¤í¬ë¦° ì‹œë„
      startBtn.style.display = 'none';
      hint.style.display = 'none';
      if (!rafId) loop();
    }catch(e){
      // ê¶Œí•œ/ìë™ì¬ìƒ ì´ìŠˆë¡œ ë²„íŠ¼ ë…¸ì¶œ
      startBtn.style.display = 'inline-block';
      hint.style.display = 'block';
    }
  }

  // ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ í›…
  const trigger = async ()=>{
    await startAll();
    window.removeEventListener('pointerdown', trigger, { once:true });
  };
  window.addEventListener('pointerdown', trigger, { once:true, passive:true });
  startBtn.addEventListener('click', startAll, { once:true });

  // ì´ˆê¸° ì‹œë„ (ìë™ì‹¤í–‰ ê°€ëŠ¥í•œ í™˜ê²½ì´ë©´ ë°”ë¡œ ë™ì‘)
  startAll();

  // ë·°í¬íŠ¸ ì•ˆì •í™”ë¥¼ ìœ„í•œ ì£¼ê¸°ì  ì¬ê³„ì‚°(ì£¼ì†Œì°½ ì• ë‹ˆë©”ì´ì…˜ ì¤‘)
  let resizeTick=null;
  window.addEventListener('scroll', ()=>{
    clearTimeout(resizeTick);
    resizeTick = setTimeout(resizeAll, 120);
  }, { passive:true });

})();
</script>
</body>
</html>
