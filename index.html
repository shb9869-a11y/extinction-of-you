<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --frame: clamp(16px, 4vmin, 40px);
    --ui-gap: 8px;

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);

    --pad-btn-y: clamp(6px, 1.1vmin, 10px);
    --pad-btn-x: clamp(10px, 1.8vmin, 20px);

    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  body{font-family:Impact,"Anton","Arial Black",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;}

  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  .frameBox{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    right:calc(var(--frame) + var(--safe-r));
    bottom:calc(var(--frame) + var(--safe-b));
    border:2px solid rgba(255,255,255,.22); pointer-events:none; z-index:50;
  }

  .uiBtn{background:#000;color:#fff;border:1px solid #444;font-size:var(--fs-strong);
    padding:var(--pad-btn-y) var(--pad-btn-x);font-family:"Courier New",ui-monospace,monospace;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}
  .uiBtn.flat{border:none;background:transparent;text-decoration:none}
  .uiBtn[disabled]{opacity:.35;pointer-events:none;filter:grayscale(1)}
  .hide{display:none !important;}

  .controls{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-family:"Courier New",ui-monospace,monospace;font-size:var(--fs-small);color:#ddd}
  .btn-capture{
    position:fixed;
    left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:150}

  #mapLauncher{
    position:fixed; right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}
  #docLauncher{
    position:fixed; left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}

  /* 타이머 (MAP 옆) */
  #runTimer{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r) + 62px); /* MAP 버튼 왼쪽에 붙임 */
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t) + 2px);
    z-index:181;
    font-family:"Courier New",ui-monospace,monospace;
    font-size:var(--fs-strong);
    color:#fff; opacity:.9;
    pointer-events:none;
    user-select:none;
    display:none; /* 시작 전 숨김 */
  }

  .credits{
    font-family:"Courier New",ui-monospace,monospace;
    letter-spacing:.08em;
  }

  /* 1) 권한 게이트 */
  #overlay{
    position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;
    padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
    color:#fff;background:rgba(0,0,0,.85)
  }
  #overlayContent{max-width:min(92vw, 72ch);font-family:"Courier New",ui-monospace,monospace;line-height:1.7;text-align:center}

  /* 2) 이름 입력 */
  #nameOverlay{position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.85); color:#fff;}
  #nameCard{ width:min(92vw,600px); text-align:center; font-family:"Courier New",ui-monospace,monospace; }
  #nameCard h2{ margin:0 0 12px 0; letter-spacing:.08em; font-size:clamp(16px,3.2vmin,24px); }
  #nick{ width:100%; padding:12px 14px; background:#000; border:1px solid #555; color:#fff; font-size:clamp(16px,3.2vmin,22px); outline:none; }
  #nameRow{ display:flex; gap:10px; margin-top:12px; justify-content:center; }
  #nameRow .uiBtn{ padding:10px 14px; }

  /* 3) 프리셋 */
  #preset{position:fixed;inset:0;z-index:250;background:#000;display:none;cursor:pointer}
  #presetCanvas{position:absolute;left:0;top:0;width:100%;height:100%}

  /* 4) WELCOME */
  #overlayWelcome{
    position:fixed;inset:0;z-index:220;display:none;align-items:center;justify-content:center;color:#fff;background:rgba(0,0,0,.55);
    padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;}
  #welcomeCard{ text-align:center; max-width:min(92vw, 900px); }
  #welcomeCard .title{
    font-size:clamp(32px, 12vmin, 120px);
    font-weight:900;
    letter-spacing:.04em;
    line-height:1.02;
    margin-bottom:16px;
    text-transform:uppercase;
  }

  /* INTRO — 스크롤 가능 */
  #introOverlay{
    position:fixed; inset:0; z-index:230; display:none;
    align-items:flex-start; justify-content:center;
    color:#fff; background:rgba(0,0,0,.85);
    padding:calc(24px + var(--safe-t)) calc(16px + var(--safe-r)) calc(20px + var(--safe-b)) calc(16px + var(--safe-l));
    font-family:"Courier New",ui-monospace,monospace;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
  }
  #introBox{ width:min(92vw, 860px); margin:0 auto; }
  #introBox h2{margin:.2em 0 .6em 0; font-size:clamp(18px, 3.6vmin, 26px); letter-spacing:.1em; text-align:center;}
  #introBox p, #introBox li{font-size:var(--fs-body); line-height:1.85;}
  #introBox ol{padding-left:1.2em; margin:.4em 0 1.2em 0;}
  .count{margin:14px 0 4px 0; text-align:center; font-size:var(--fs-strong);}

  /* TITLE */
  #titleScreen{
    position:fixed; inset:0; z-index:240; display:none; align-items:center; justify-content:center;
    background:#000; color:#fff; text-align:center; padding:calc(var(--safe-t)) calc(var(--safe-r)) calc(var(--safe-b)) calc(var(--safe-l));
  }
  #titleText{font-weight:900; letter-spacing:.06em; line-height:1.05;
    font-size:clamp(24px, 10vmin, 96px);}

  /* DOC/MAP */
  #docOverlay{ position:fixed; inset:0; z-index:210; display:none; background:rgba(0,0,0,.8); color:#fff; font-family:"Courier New",ui-monospace,monospace; padding-bottom:var(--safe-b); padding-top:var(--safe-t);}
  #docUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(96vw,1100px); display:flex; flex-direction:column; gap:10px; }
  #docHeader{ display:flex; justify-content:space-between; align-items:center; }
  #docGrid{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; }
  .docBtn{ border:1px solid #444; background:#000; color:#fff; padding:12px; text-align:center; cursor:pointer; font-size:var(--fs-small) }
  .docPane{ border:1px solid #444; padding:12px; max-height:50vh; overflow:auto; background:#000; }

  #mapOverlay{ position:fixed; inset:0; z-index:210; display:none; background:rgba(0,0,0,.8); color:#fff; font-family:"Courier New",ui-monospace,monospace; }
  #mapUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; width:min(92vw, 820px); }
  #mapUI h3{ letter-spacing:.08em; }

  .fade-enter{opacity:0; transition:opacity .45s ease}
  .fade-enter.show{opacity:1}
  .fade-leave{opacity:1; transition:opacity .45s ease}
  .fade-leave.hide{opacity:0}
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <div class="controls">
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>
  <button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>

  <button id="docLauncher" class="uiBtn small">DOCUMENT</button>
  <button id="mapLauncher" class="uiBtn small">MAP</button>
  <div id="runTimer" aria-live="polite">08:00</div>

  <!-- 1) 권한 게이트 -->
  <div id="overlay">
    <div id="overlayContent">
      <div class="credits" style="margin-bottom:10px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="uiBtn" type="button">화면을 탭하여 카메라·동작(센서)을 허용해주세요</button>
      <div class="tip" style="opacity:.7;margin-top:6px">허용 후 이름 입력 화면으로 이동합니다.</div>
    </div>
  </div>

  <!-- 2) 이름 입력 -->
  <div id="nameOverlay">
    <div id="nameCard">
      <h2>TELL ME YOUR NAME</h2>
      <input id="nick" type="text" maxlength="24" placeholder="닉네임을 입력하세요" autocomplete="off" />
      <div id="nameRow">
        <button id="nameSubmit" class="uiBtn" type="button">GO</button>
      </div>
    </div>
  </div>

  <!-- 3) 프리셋 -->
  <div id="preset" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <!-- 4) WELCOME -->
  <div id="overlayWelcome">
    <div id="welcomeCard">
      <div class="credits" style="margin-bottom:12px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div class="title">
        Welcome to SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP
      </div>
      <button id="goIntro" class="uiBtn flat" type="button">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- INTRODUCTION -->
  <div id="introOverlay"><div id="introBox">
    <h2>INTRODUCTION</h2>

    <p>지금 이 화면을 보고 있는 당신,<br>
    주변의 소리에 천천히 귀를 기울이며 공간을 거닐기 시작합니다.<br>
    지금부터 당신은 약 30분 간, 짧은 단잠에 들게 됩니다.</p>

    <ol>
      <li>당신이 거닐고 있는 이곳의 세계관 설명입니다.</li>
      <li>우리는 언제나 타자와 함께 존재해왔습니다. 친구, 엄마, 누나, 아버지, 지나가는 저 사람과 같이 말이죠.</li>
      <li>그러나 어느 순간, ‘너’로 존재했던 그들은 ‘너’가 아닌 ‘그것’으로 전락하기 시작했습니다.</li>
      <li>이제는 그 어느곳에서도 ‘너’를 찾아볼 수는 없습니다.</li>
      <li>‘그것’으로 전락한 ‘너’들은 서서히 우리의 내면 속에서 희미해져 가고 있기 때문이죠.</li>
      <li>마치 꿈 속에서 분명 누군가를 만난 것 같은데, 그게 누구인지 떠오르지 않는 것처럼.</li>
      <li>네, 그렇습니다. 이곳은 바로, 그 ‘너’가 사라져버린, ‘너’를 제거해버린, 누군가의 내면 세계입니다.</li>
    </ol>

    <p>당신의 의식이 서서히 희미해져가는 지금, 두 번의 심호흡을 크게 한 후,</p>
    <p>이 내면의 미로를 거닐며, 천천히 눈을 감고,</p>
    <p>이 세상에서 사라져버린 ‘너’의 이야기에 귀를 기울입니다.</p>

    <div class="count">It will come in <span id="countNum">30</span> seconds.</div>
    <div style="height:12vh"></div>
  </div></div>

  <!-- TITLE -->
  <div id="titleScreen"><div id="titleText"></div></div>

  <!-- DOC -->
  <div id="docOverlay">
    <div id="docUI">
      <div id="docHeader">
        <div class="readout">DOCUMENTS</div>
        <div><button id="btnExitDoc" class="uiBtn small" type="button">EXIT</button></div>
      </div>
      <div id="docGrid"></div>
      <div id="docPane" class="docPane" style="display:none">
        <div class="docTitle" id="docTitle" style="font-size:var(--fs-strong);margin-bottom:8px;">Document</div>
        <div id="docBody">준비중입니다.</div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="mapOverlay">
    <div id="mapUI">
      <h3>MAP</h3>
      <p style="opacity:.85">지금은 준비 중입니다. (게임 모듈 비활성화)</p>
      <button id="btnExitMap" class="uiBtn small" type="button" style="margin-top:10px">EXIT</button>
    </div>
  </div>

<script>
(() => {
  // Manifest
  (function injectManifest(){
    const manifest = {"name":"SLEEEEEP","short_name":"SLEEEEEP","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  // App height
  function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppH(); addEventListener('resize', setAppH, {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppH,50)); }

  const qs = s => document.querySelector(s);

  // Refs
  const overlay = qs('#overlay');
  const permBtn = qs('#permGateBtn');

  const nameOverlay = qs('#nameOverlay');
  const nickInput = qs('#nick');
  const nameSubmit = qs('#nameSubmit');

  const preset = qs('#preset');
  const presetCanvas = qs('#presetCanvas');

  const welcome = qs('#overlayWelcome');
  const goIntroBtn = qs('#goIntro');

  const intro = qs('#introOverlay');
  const countNum = qs('#countNum');

  const titleScreen = qs('#titleScreen');
  const titleText = qs('#titleText');

  const docBtn = qs('#docLauncher');
  const mapBtn = qs('#mapLauncher');
  const zoomIn = qs('#zoomIn');
  const zoomOut = qs('#zoomOut');
  const zoomVal = qs('#zoomVal');
  const captureBtn = qs('#captureBtn');

  const docOverlay = qs('#docOverlay');
  const btnExitDoc = qs('#btnExitDoc');
  const docGrid = qs('#docGrid');
  const docPane = qs('#docPane');
  const docTitle = qs('#docTitle');
  const docBody = qs('#docBody');

  const mapOverlay = qs('#mapOverlay');
  const btnExitMap = qs('#btnExitMap');

  const frameBox = qs('.frameBox');
  const view = qs('#view');
  const runTimer = qs('#runTimer');

  // State
  let camPermGranted = false;
  let camStream = null, camVideo = null, vctx = null, proc = null, pctx = null, ZOOM = 1.0;
  let animStarted = false;

  // === 버튼 클릭 사운드 (유지/추가) ===
  let audioCtx = null;
  function playClick(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square';
      o.frequency.value = 880; // 짧은 '틱'
      g.gain.value = 0.04;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      // 아주 짧게 감쇄
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.06);
      o.stop(audioCtx.currentTime + 0.07);
    }catch(e){}
  }
  // 모든 UI 버튼에 사운드 연결
  function wireButtonClicks(){
    document.querySelectorAll('.uiBtn').forEach(btn=>{
      btn.addEventListener('click', playClick, {passive:true});
    });
  }

  // UI toggle helpers
  function hideTopUI(hide){
    docBtn.classList.toggle('hide', hide);
    mapBtn.classList.toggle('hide', hide);
    qs('.controls').classList.toggle('hide', hide);
    captureBtn.classList.toggle('hide', hide);
    // 타이머는 hideTopUI의 영향을 받지 않음 (진행 표시 계속)
  }

  function updateZoomLabel(){ zoomVal.textContent = ZOOM.toFixed(1)+'×'; }
  updateZoomLabel();
  zoomIn.addEventListener('click', ()=>{ ZOOM=Math.min(3.0, ZOOM+0.05); updateZoomLabel(); }, {passive:true});
  zoomOut.addEventListener('click', ()=>{ ZOOM=Math.max(0.35, ZOOM-0.05); updateZoomLabel(); }, {passive:true});

  // Permissions first
  async function requestMotionPermissions(){
    const needsIOS = typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function';
    try{ if(needsIOS){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); } }catch{}
  }
  async function gate(){
    try{
      await requestMotionPermissions();
      const tmp = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}, audio:false
      });
      tmp.getTracks().forEach(t=>t.stop());
      camPermGranted = true;
    }catch(e){
      console.warn('permission error:', e);
    }
    overlay.style.display='none';
    showName();
  }
  permBtn.addEventListener('click', gate, {passive:true});
  ['pointerdown','touchstart','click','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{ if(overlay.style.display!=='none') gate(); }, {once:true, capture:true, passive:true});
  });

  // Name
  let displayName = 'YOU';
  function showName(){
    nameOverlay.style.display='flex';
    setTimeout(()=>nickInput.focus(), 50);
  }
  function acceptName(){
    const v = (nickInput.value||'').trim();
    if(v.length>0){ displayName = v; }
    nameOverlay.style.display='none';
    showPreset();
  }
  nameSubmit.addEventListener('click', acceptName, {passive:true});
  nickInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ acceptName(); }});

  // Preset
  function drawPreset(){
    const dpr = window.devicePixelRatio||1;
    const w = preset.clientWidth, h = preset.clientHeight;
    presetCanvas.width = w*dpr; presetCanvas.height = h*dpr;
    const ctx = presetCanvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#fff';

    const base = Math.min(w,h);
    const colGutter = base*0.06;
    const colWidth = base*0.18;
    const columns = Math.max(3, Math.floor((w + colGutter)/(colWidth + colGutter)));
    const usableW = columns*colWidth + (columns-1)*colGutter;
    const left = (w-usableW)/2;

    const fontSize = colWidth*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font = `900 ${fontSize}px Impact, Anton, "Arial Black", system-ui, sans-serif`;

    for(let c=0;c<columns;c++){
      const x = left + c*(colWidth+colGutter) + colWidth/2;
      const isSide = (c===0 || c===columns-1);
      const step = fontSize*1.35;
      const startY = (h % step)/2;
      for(let y=startY; y<h; y+=step){
        const ch = isSide ? ( (Math.round(y/step)%6===0) ? 'S' : 'E') : 'E';
        ctx.fillText(ch, x, y);
      }
    }
  }
  function showPreset(){
    hideTopUI(true);
    preset.style.display='block';
    drawPreset();
  }
  addEventListener('resize', ()=>{ if(preset.style.display==='block') drawPreset(); }, {passive:true});
  preset.addEventListener('click', async ()=>{
    preset.style.display='none';
    await startCameraFresh();
    showWelcome();
  }, {passive:true});

  // Welcome → Intro → Title → Character move
  function showWelcome(){ welcome.style.display='flex'; }
  goIntroBtn.addEventListener('click', ()=>{
    welcome.style.display='none';
    showIntro();
  }, {passive:true});

  function showIntro(){
    hideTopUI(true);
    intro.style.display='flex';
    let count=30;
    countNum.textContent = count;
    const t = setInterval(()=>{
      count--;
      if(count>=0) countNum.textContent = count;
      if(count<=0){
        clearInterval(t);
        intro.style.display='none';
        (async ()=>{
          await showTitle('THE FIRST SILENCE', 1500);
          beginCharacterMove();
          hideTopUI(false);
        })();
      }
    },1000);
  }

  function showTitle(text, hold=1500){
    return new Promise(res=>{
      titleText.textContent = text;
      titleScreen.style.display='flex';
      titleScreen.className='fade-enter show';
      setTimeout(()=>{ titleScreen.className='fade-leave'; requestAnimationFrame(()=>{ titleScreen.classList.add('hide'); });
        setTimeout(()=>{ titleScreen.style.display='none'; titleScreen.className=''; res(); },450);
      }, hold);
    });
  }

  // Camera + render
  async function startCameraFresh(){
    try{
      if(!camPermGranted){
        await navigator.mediaDevices.getUserMedia({video:true, audio:false}).then(s=>{ s.getTracks().forEach(t=>t.stop()); camPermGranted=true; });
      }
      camStream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment', width:{ideal:1920}, height:{ideal:1080}},
        audio:false
      });
      if(!camVideo){
        camVideo = document.createElement('video');
        camVideo.setAttribute('playsinline','');
        camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;
      }
      camVideo.srcObject = camStream;
      await camVideo.play().catch(()=>{});

      if(!vctx){
        vctx = view.getContext('2d',{alpha:false});
        proc = document.createElement('canvas');
        pctx = proc.getContext('2d',{willReadFrequently:true});
        resizeCam();
      }
      if(!animStarted){
        animStarted = true;
        loopCam();
      }
      wireButtonClicks(); // 권한 허용 후 버튼 사운드 배선
    }catch(e){
      console.warn('startCameraFresh error:', e);
    }
  }

  function resizeCam(){
    const dpr = window.devicePixelRatio||1;
    const w = window.innerWidth, h = window.innerHeight;
    view.width=w*dpr; view.height=h*dpr; if(vctx) vctx.setTransform(dpr,0,0,dpr,0,0);
    const scale = matchMedia('(orientation: landscape)').matches? 0.86 : 0.9;
    if(proc){ proc.width=Math.floor(w*scale); proc.height=Math.floor(h*scale); }
  }
  addEventListener('resize', ()=>setTimeout(resizeCam,50), {passive:true});

  document.addEventListener('visibilitychange', async ()=>{
    if(document.visibilityState==='visible' && camVideo){
      try{
        if(camVideo.paused){ await camVideo.play(); }
        if(!camStream || camStream.getVideoTracks().every(t=>t.readyState!=='live')){
          await startCameraFresh();
        }
      }catch{}
    }
  });

  function loopCam(){
    requestAnimationFrame(loopCam);
    if(!vctx || !pctx) return;
    const W=view.width/(window.devicePixelRatio||1), H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;
    pctx.fillStyle='rgba(0,0,0,.14)'; pctx.fillRect(0,0,PW,PH);
    if(camVideo && camVideo.readyState>=2){
      const vw=camVideo.videoWidth||0, vh=camVideo.videoHeight||0;
      if(vw&&vh){
        const cover=Math.max(PW/vw, PH/vh)*ZOOM;
        const dw=vw*cover, dh=vh*cover, dx=(PW-dw)/2, dy=(PH-dh)/2;
        pctx.globalAlpha=.7; pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1;
        const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;
        for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.imageSmoothingEnabled = false;
    vctx.drawImage(proc,0,0,W,H);
    if(charActive){ drawCharacter(W,H); }
  }

  // Character (8분, 'ㄹ' 동선)
  let charActive = false;
  let charStartTime = 0;
  const CHAR_DURATION = 480000; // 8분
  let pathSegments = null;
  let timerInterval = null;

  function buildReulPath(){
    const r = frameBox.getBoundingClientRect();
    const pad = 14;
    const x0 = r.left + pad;
    const x1 = r.left + r.width * 0.35;
    const x3 = r.right - pad;

    const y0 = r.top + pad;
    const y2 = r.top + r.height * 0.5;
    const y4 = r.bottom - pad;

    const pts = [
      {x:x0, y:y0},
      {x:x3, y:y0},
      {x:x3, y:y2},
      {x:x1, y:y2},
      {x:x1, y:y4},
      {x:x3, y:y4}
    ];
    const segs=[]; let total=0;
    for(let i=0;i<pts.length-1;i++){
      const a=pts[i], b=pts[i+1]; const len=Math.hypot(b.x-a.x, b.y-a.y);
      segs.push({a,b,len}); total+=len;
    }
    let acc=0; for(const s of segs){ s.t0=acc/total; acc+=s.len; s.t1=acc/total; }
    return segs;
  }

  function beginCharacterMove(){
    pathSegments = buildReulPath();
    charActive = true;
    charStartTime = performance.now();
    startRunTimer();
  }

  // ===== 업그레이드된 픽셀 사람 스프라이트 (12x20) =====
  const PIXEL_SPRITE = [
    "....XXXX....",
    "...XXXXXX...",
    "..XXXXXXXX..",
    "..XX.XX.XX..",
    "..XX.XX.XX..",
    "..XXXXXXXX..",  // 머리/어깨
    "...XXXXXX...",
    "...X.XX.X...",
    "..XXXXXXXX..",  // 가슴/몸통
    "..XXXXXXXX..",
    "..XX.XX.XX..",  // 팔
    "..XX.XX.XX..",
    "...XXXXXX...",  // 허리
    "...X.XX.X...",
    "..XX.XX.XX..",  // 허벅지
    "..XX.XX.XX..",
    "...X....X...",  // 종아리
    "...X....X...",
    "...X....X...",  // 발목
    "..XXX..XXX.."   // 발
  ];

  function drawPixelHuman(ctx, cx, baselineY, name, W){
    // 셀 크기 ↑ (사람 형체 크게)
    const cell = Math.max(3, Math.min(9, Math.floor(W * 0.006)));
    const cols = PIXEL_SPRITE[0].length;
    const rows = PIXEL_SPRITE.length;
    const width = cols * cell;
    const height = rows * cell;

    const x0 = Math.round(cx - width/2);
    const y0 = Math.round(baselineY - height);

    // 그림자
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    for(let y=0; y<rows; y++){
      const row = PIXEL_SPRITE[y];
      for(let x=0; x<cols; x++){
        if(row[x]==='X'){
          ctx.fillRect(x0 + (x+1)*cell, y0 + (y+1)*cell, cell, cell);
        }
      }
    }

    // 본체
    ctx.fillStyle = '#fff';
    for(let y=0; y<rows; y++){
      const row = PIXEL_SPRITE[y];
      for(let x=0; x<cols; x++){
        if(row[x]==='X'){
          ctx.fillRect(x0 + x*cell, y0 + y*cell, cell, cell);
        }
      }
    }

    // 이름 (발 아래)
    ctx.font = `700 ${Math.max(12, Math.min(28, Math.floor(W*0.024)))}px "Courier New", ui-monospace, monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    const ny = Math.round(baselineY + Math.max(6, cell));
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    ctx.fillText(name, cx, ny-1);
    ctx.fillText(name, cx, ny+1);
    ctx.fillText(name, cx-1, ny);
    ctx.fillText(name, cx+1, ny);
    ctx.fillStyle = '#fff';
    ctx.fillText(name, cx, ny);
  }

  function getCharPos(now){
    const t = Math.min(1, (now - charStartTime)/CHAR_DURATION);
    const sgs = pathSegments||[]; if(!sgs.length) return null;
    let seg = sgs[sgs.length-1], lt=1;
    for(const s of sgs){ if(t>=s.t0 && t<=s.t1){ seg=s; lt=(t - s.t0)/(s.t1 - s.t0); break; } }
    return { x: seg.a.x + (seg.b.x - seg.a.x)*lt, y: seg.a.y + (seg.b.y - seg.a.y)*lt, t };
  }

  function drawCharacter(W,H){
    const now = performance.now();
    const p = getCharPos(now);
    if(!p){ return; }
    const ctx = vctx;
    drawPixelHuman(ctx, Math.round(p.x), Math.round(p.y), displayName, W);
    if(now - charStartTime >= CHAR_DURATION){
      charActive=false;
      stopRunTimer();
    }
  }

  // ===== 8분 타이머 (MAP 옆 표시) =====
  function fmt(mmss){
    const m = Math.floor(mmss/60);
    const s = mmss%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  function startRunTimer(){
    const start = performance.now();
    runTimer.style.display = 'block';
    // 초기값
    runTimer.textContent = "08:00";
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      const elapsed = performance.now() - start;
      const remain = Math.max(0, Math.round((CHAR_DURATION - elapsed)/1000));
      runTimer.textContent = fmt(remain);
      if(remain<=0){
        clearInterval(timerInterval);
      }
    }, 1000);
  }
  function stopRunTimer(){
    if(timerInterval) clearInterval(timerInterval);
    runTimer.textContent = "00:00";
  }

  // Capture
  captureBtn.addEventListener('click', ()=>{
    try{
      const a=document.createElement('a');
      a.download=`sleep_capture_${Date.now()}.png`;
      a.href=view.toDataURL('image/png'); a.click();
    }catch(e){}
  }, {passive:true});

  // DOC
  function openDoc(){ docOverlay.style.display='block'; }
  function closeDoc(){ docOverlay.style.display='none'; }
  docBtn.addEventListener('click', openDoc, {passive:true});
  btnExitDoc.addEventListener('click', closeDoc, {passive:true});
  (function buildDocGrid(){
    docGrid.innerHTML='';
    for(let i=1;i<=8;i++){
      const b=document.createElement('button'); b.className='docBtn uiBtn small'; b.textContent=`Document ${i}`;
      b.onclick=()=>{ playClick(); docTitle.textContent=`Document ${i}`; docBody.innerHTML='준비중입니다.'; docPane.style.display='block'; };
      docGrid.appendChild(b);
    }
  })();

  // MAP
  function openMap(){ mapOverlay.style.display='block'; }
  function closeMap(){ mapOverlay.style.display='none'; }
  mapBtn.addEventListener('click', openMap, {passive:true});
  btnExitMap.addEventListener('click', closeMap, {passive:true});

  // boot: 권한 → 이름 → 프리셋 → (탭) → 카메라 시작 → Welcome ...
})();
</script>
</body>
</html>
