<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<!-- Pixel font -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --fs-body: 14px;
    --fs-strong: 18px;
    --fs-small: 12px;

    --yellow: #f0e7a0;
    --black: #000000;
    --dark:  #0d0d0d;
  }

  html,body{
    margin:0;padding:0;
    width:100%;height:100%;
    font-family:'Press Start 2P', monospace;
    background:#000;
    overflow:hidden;
  }

  .scene{
    position:absolute;
    inset:0;
    width:100%;
    height:var(--appH);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    background:#000;
    color:#f0e7a0;
    font-size:var(--fs-body);
    opacity:0;
    transition:opacity 0.8s ease;
    pointer-events:none;
  }
  .scene.active{
    opacity:1;
    pointer-events:auto;
  }

  .title{
    font-size:24px;
    text-align:center;
    line-height:1.6;
    margin-bottom:24px;
  }

  .btn{
    padding:12px 20px;
    margin-top:20px;
    background:#f0e7a0;
    color:#000;
    border:none;
    font-family:'Press Start 2P';
    font-size:14px;
    cursor:pointer;
  }

  .typewrap{
    width:80%;
    max-width:900px;
    margin:0 auto;
    text-align:left;
    line-height:1.8;
    white-space:pre-wrap;
  }

  .skip-btn{
    position:absolute;
    left:20px;
    top:20px;
    padding:10px 16px;
    font-size:12px;
    background:#222;
    color:#fff;
    border:none;
    z-index:99999;
    cursor:pointer;
    opacity:0.7;
  }

  video#cam{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    filter:grayscale(1);
    opacity:0;
    transition:opacity 1s ease;
  }
  video#cam.on{
    opacity:1;
  }
</style>
</head>
<body>
<!-- 카메라 영상 -->
<video id="cam" playsinline autoplay muted></video>

<!-- 스킵 버튼 (모든 장면 공통) -->
<button class="skip-btn" id="skipBtn">SKIP</button>

<!-- ================================
     SCENE: INTRODUCTION
================================ -->
<div class="scene active" id="scene-intro">
  <div class="title">SLEEEEEEEEEEP</div>
  <button class="btn" id="introNextBtn">NEXT</button>
</div>

<!-- ================================
     SCENE: FIRST SLEEP (Scene 1)
================================ -->
<div class="scene" id="scene-1">
  <div class="title">THE FIRST SLEEP</div>
  <div class="typewrap" id="text-1"></div>
</div>

<!-- ================================
     SCENE: SECOND SLEEP (Scene 2)
================================ -->
<div class="scene" id="scene-2">
  <div class="title">THE SECOND SLEEP</div>
  <div class="typewrap" id="text-2"></div>
</div>

<!-- ================================
     SCENE: THIRD SLEEP (Scene 3)
================================ -->
<div class="scene" id="scene-3">
  <div class="title">THE THIRD SLEEP</div>
  <div class="typewrap" id="text-3"></div>
</div>

<!-- ================================
     SCENE: FOURTH SLEEP (Scene 4)
================================ -->
<div class="scene" id="scene-4">
  <div class="title">THE FOURTH SLEEP</div>
  <div class="typewrap" id="text-4"></div>
</div>

<!-- ================================
     SCENE: SILENCE (카메라만 켜짐)
================================ -->
<div class="scene" id="scene-silence">
  <div class="title">SILENCE</div>
</div>

<!-- ================================
     SCENE: THE END
================================ -->
<div class="scene" id="scene-end">
  <div class="title">THE END</div>
  <button class="btn" id="restartBtn">RESTART</button>
</div>

<!-- ================================
     SCRIPT 영역 시작
================================ -->
<script>
/* ============================================================
   AUDIO ENGINE (WebAudio)
   갤럭시탭 A9+ 딜레이 제거 + 안정화 버전
============================================================ */
let audioCtx;
let audioReady = false;

function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  audioReady = true;
}

/* ------------------------
   버튼 사운드 (딜레이 없는 버전)
------------------------- */
function playButtonSound(){
  try{
    ensureAudio();
    const ctx = audioCtx;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.frequency.value = 600;
    osc.type = "square";

    gain.gain.setValueAtTime(0.001, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15);

    osc.connect(gain).connect(ctx.destination);

    osc.start();
    osc.stop(ctx.currentTime + 0.16);
  } catch(e){}
}

/* ------------------------
   타이핑 사운드 (버벅임 제거)
------------------------- */
let typeBuffer = null;
let lastType = 0;

function buildTypeBuffer(ctx){
  const duration = 0.06;
  const sr = ctx.sampleRate;
  const length = Math.floor(sr * duration);
  const buf = ctx.createBuffer(1, length, sr);
  const data = buf.getChannelData(0);

  for(let i=0; i<length; i++){
    const t = i / sr;
    const env = Math.exp(-t * 20);
    const freq = 1600;
    data[i] = Math.sin(2*Math.PI*freq*t) * env;
  }
  return buf;
}

function playType(){
  try{
    ensureAudio();
    const ctx = audioCtx;
    const now = ctx.currentTime;

    if(now - lastType < 0.03) return;
    lastType = now;

    if(!typeBuffer) typeBuffer = buildTypeBuffer(ctx);

    const src = ctx.createBufferSource();
    src.buffer = typeBuffer;
    const g = ctx.createGain();
    g.gain.value = 0.25;

    src.connect(g).connect(ctx.destination);
    src.start();
  }catch(e){}
}

/* ============================================================
   TTS (한국어 남자 목소리 우선 + 갤탭 재초기화 지원)
============================================================ */
let ttsReady = 'speechSynthesis' in window;
let ttsVoice = null;
let ttsEnabled = false;

function pickMaleKoreanVoice(voices){
  const ko = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith("ko"));

  return (
    ko.find(v => /male|man|남성|남자|M/i.test(v.name)) ||
    (ko.length ? ko[0] : null) ||
    voices.find(v => /male|man/i.test(v.name)) ||
    voices[0]
  );
}

function initTts(retry = 0){
  if(!ttsReady) return;

  const voices = window.speechSynthesis.getVoices();

  if(!voices || !voices.length){
    if(retry < 10){
      setTimeout(()=>initTts(retry+1), 300);
    }
    return;
  }

  ttsVoice = pickMaleKoreanVoice(voices);
  ttsEnabled = true;
}

if(ttsReady){
  initTts();
  window.speechSynthesis.onvoiceschanged = () => initTts();
}

/* ------------------------
   speakText()
------------------------- */
function speakText(text){
  if(!ttsReady || !ttsEnabled || !text) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    if(ttsVoice) u.voice = ttsVoice;

    u.pitch = 0.9;   // 남성 톤
    u.rate  = 0.9;
    u.volume = 1;

    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);

  }catch(e){}
}

/* ============================================================
   사용자 제스처 이후 오디오/TTS 재활성화
============================================================ */
async function resumeAll(){
  try{
    ensureAudio();
    if(audioCtx.state === "suspended") await audioCtx.resume();

    if(ttsReady && !ttsEnabled){
      initTts();
    }
  }catch(e){}
}

document.body.addEventListener("pointerdown", resumeAll, {once:false});
document.body.addEventListener("click", resumeAll, {once:false});
/* ============================================================
   TEXT TYPING SYSTEM
============================================================ */
function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

async function typeText(targetEl, text, speed=28, speak=false){
  targetEl.innerHTML = "";
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    targetEl.innerHTML += ch;

    // 타이핑 사운드
    playType();

    // 필요 시 읽어주기
    if(speak && ch !== "\n"){
      // 글자가 조금 누적될 때마다 읽도록 설정 가능
    }

    await sleep(speed);
  }
}

/* ============================================================
   CAMERA SYSTEM
============================================================ */
const cam = document.getElementById("cam");

async function enableCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"user" },
      audio:false
    });
    cam.srcObject = stream;
    cam.classList.add("on");
  }catch(e){
    console.log("Camera blocked:", e);
  }
}

function disableCamera(){
  cam.classList.remove("on");
  if(cam.srcObject){
    cam.srcObject.getTracks().forEach(t => t.stop());
    cam.srcObject = null;
  }
}

/* ============================================================
   SCENE MANAGER
============================================================ */
let currentScene = "scene-intro";

function showScene(id){
  // 모든 scene 숨기기
  document.querySelectorAll(".scene").forEach(s=>{
    s.classList.remove("active");
  });

  // 해당 scene만 보이기
  const sc = document.getElementById(id);
  if(sc){
    sc.classList.add("active");
    currentScene = id;
  }
}

/* ============================================================
   SKIP 기능
============================================================ */
document.getElementById("skipBtn").addEventListener("click", ()=>{
  playButtonSound();
  skipCurrentScene();
});

function skipCurrentScene(){
  if(currentScene === "scene-intro") goScene1();
  else if(currentScene === "scene-1") goScene2();
  else if(currentScene === "scene-2") goScene3();
  else if(currentScene === "scene-3") goScene4();
  else if(currentScene === "scene-4") goSilence();
  else if(currentScene === "scene-silence") goEnd();
}

/* ============================================================
   각 SCENE 실행 로직
============================================================ */

/* ---------- INTRO ---------- */
document.getElementById("introNextBtn").addEventListener("click", ()=>{
  playButtonSound();
  goScene1();
});

/* ---------- Scene 1 ---------- */
async function goScene1(){
  disableCamera();
  showScene("scene-1");

  const text = 
`- 문장을 입력하세요
- 문장을 입력하세요
- 문장을 입력하세요`;

  const box = document.getElementById("text-1");
  await sleep(300);
  await typeText(box, text, 28, true);

  // 5분 타이머 → 자동 다음
  setTimeout(goScene2, 5*60*1000);
}

/* ---------- Scene 2 ---------- */
async function goScene2(){
  disableCamera();
  showScene("scene-2");

  const text = 
`- 문장을 입력하세요
- 문장을 입력하세요
- 문장을 입력하세요`;

  const box = document.getElementById("text-2");
  await sleep(300);
  await typeText(box, text, 28, false);

  // 8분 타이머
  setTimeout(goScene3, 8*60*1000);
}

/* ---------- Scene 3 ---------- */
async function goScene3(){
  disableCamera();
  showScene("scene-3");

  const text =
`- 문장을 입력하세요
- 문장을 입력하세요
- 문장을 입력하세요`;

  const box = document.getElementById("text-3");
  await sleep(300);
  await typeText(box, text, 32, false);

  // 5분 후
  setTimeout(goScene4, 5*60*1000);
}

/* ---------- Scene 4 ---------- */
async function goScene4(){
  disableCamera();
  showScene("scene-4");

  const text =
`- 문장을 입력하세요
- 문장을 입력하세요
- 문장을 입력하세요`;

  const box = document.getElementById("text-4");
  await sleep(300);
  await typeText(box, text, 30, false);

  // 5분 후
  setTimeout(goSilence, 5*60*1000);
}

/* ---------- SILENCE ---------- */
async function goSilence(){
  showScene("scene-silence");

  await sleep(500);
  enableCamera();

  // 3분 후 THE END
  setTimeout(goEnd, 3*60*1000);
}

/* ---------- THE END ---------- */
function goEnd(){
  disableCamera();
  showScene("scene-end");
}

document.getElementById("restartBtn").addEventListener("click", ()=>{
  playButtonSound();
  disableCamera();
  showScene("scene-intro");
});
/* ============================================================
   초기 시작 처리
============================================================ */
window.addEventListener("load", ()=>{
  // 오디오/tts 재활성화
  resumeAll();

  // 인트로 장면 이미 active 상태
  showScene("scene-intro");
});

/* ============================================================
   SCRIPT 종료
============================================================ */
</script>

</body>
</html>
