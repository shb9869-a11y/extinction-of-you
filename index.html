<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera – BW + Afterimage + Mission Flow</title>

<!-- PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="app.webmanifest">

<style>
  :root{
    --frame: 40px;            
    --ui-gap: 8px;
    --font-body: 16px;
    --font-strong: 18px;
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #view{width:100%;height:100%;display:block;position:fixed;left:0;top:0;z-index:0}

  /* 프로시니엄 프레임 (검정 라인) */
  .frameBox{
    position:fixed;left:var(--frame);top:var(--frame);
    right:var(--frame);bottom:var(--frame);
    border:1px solid #000;
    pointer-events:none; z-index:50;
  }

  /* 컨트롤 */
  .controls{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap));
    bottom:calc(var(--frame) + var(--ui-gap));
    z-index:100; display:flex; gap:8px; align-items:center;
    background:rgba(0,0,0,.45); padding:8px; border-radius:12px;
    font:14px/1 system-ui,-apple-system,sans-serif; color:#fff;
  }
  .btn{border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08);color:#fff;padding:6px 10px;
    border-radius:8px;font-weight:700;cursor:pointer;font-family:"Courier New",monospace}
  .readout{min-width:64px;text-align:center;opacity:.9;font-family:"Courier New",monospace}

  .btn-capture{
    position:fixed;
    left:calc(var(--frame) + var(--ui-gap));
    bottom:calc(var(--frame) + var(--ui-gap));
    z-index:150;
    border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);
    color:#fff;padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-family:"Courier New",monospace;
  }

  /* 오버레이 */
  #overlay{
    position:fixed;inset:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    padding:20px;font-family:"Courier New",monospace;color:#fff;
    pointer-events:none;
  }
  #overlayContent{
    pointer-events:auto; line-height:1.7; font-size:var(--font-body);
    max-width:min(680px, calc(100vw - (var(--frame)*2)));
    max-height:calc(100vh - (var(--frame)*2));
    overflow:hidden; text-align:left;
  }

  /* 시작 버튼 */
  #startBtn{
    background:#000;color:#fff;border:1px solid #000;
    font-size:var(--font-strong);padding:10px 20px;cursor:pointer;
    font-family:"Courier New",monospace;border-radius:0; display:block; margin:0 auto;
    white-space:nowrap; /* ✅ 한 줄 고정 */
  }

  /* 안내문 각 줄 */
  .line{
    display:inline; background:#000; color:#fff; padding:6px 8px;
    box-decoration-break:clone; -webkit-box-decoration-break:clone;
  }
  .lineWrap{ margin:6px 0 }

  /* 페이드 */
  .fade{opacity:1;transition:opacity .45s ease}
  .fade.hidden{opacity:0}

  /* GOOD NIGHT */
  #goodnight{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    z-index:250;color:#fff;font-weight:bold;display:none;text-align:center;
    font-family:"Courier New",monospace;
    font-size:var(--font-strong); /* ✅ PRESS와 동일 크기 */
    background:#000; padding:10px 20px;
    white-space:nowrap; /* ✅ 한 줄 고정 */
    transition:opacity .6s ease;
  }
  #goodnight.show{display:block;opacity:1}
  #goodnight.fadeout{opacity:0}
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <!-- 줌 컨트롤 -->
  <div class="controls">
    <button class="btn" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.2×</span></div>
    <button class="btn" id="zoomIn">+</button>
  </div>
  <!-- 캡쳐 버튼 -->
  <button id="captureBtn" class="btn-capture">캡쳐</button>

  <!-- 오버레이 -->
  <div id="overlay" class="fade">
    <div id="overlayContent" class="fade">
      <button id="startBtn">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- GOOD NIGHT -->
  <div id="goodnight">GOOD NIGHT</div>

<script>
(async ()=>{
  const view=document.getElementById('view');
  const vctx=view.getContext('2d',{alpha:false});

  const PROC_SCALE=0.6, TRAIL_ALPHA=0.10, GLOBAL_ALPHA=0.7;
  let ZOOM=1.2, ZOOM_MIN=0.5, ZOOM_MAX=3.0, ZOOM_STEP=0.1;

  const zoomVal=document.getElementById('zoomVal');
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const updateZoom=()=>zoomVal.textContent=ZOOM.toFixed(1)+'×';
  document.getElementById('zoomIn').onclick=()=>{ZOOM=clamp(ZOOM+ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom()};
  document.getElementById('zoomOut').onclick=()=>{ZOOM=clamp(ZOOM-ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom()};
  updateZoom();

  const camVideo=document.createElement('video');
  camVideo.autoplay=true; camVideo.playsInline=true; camVideo.muted=true;
  const proc=document.createElement('canvas');
  const pctx=proc.getContext('2d',{willReadFrequently:true});

  async function attachCamera(){
    try{
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
      camVideo.srcObject=s;
      await camVideo.play().catch(()=>{});
    }catch(e){console.error("카메라 접근 실패:", e);}
  }

  function resizeAll(){
    const dpr=window.devicePixelRatio||1;
    const w=window.innerWidth,h=window.innerHeight;
    view.width=w*dpr; view.height=h*dpr;
    vctx.setTransform(dpr,0,0,dpr,0,0);
    proc.width=Math.floor(w*PROC_SCALE);
    proc.height=Math.floor(h*PROC_SCALE);

    // ✅ 폰트 크기 재계산 (세로/가로 전환 시 비율 깨짐 방지)
    if(window.innerWidth > window.innerHeight){
      document.documentElement.style.setProperty("--font-body","14px");
      document.documentElement.style.setProperty("--font-strong","16px");
    } else {
      document.documentElement.style.setProperty("--font-body","16px");
      document.documentElement.style.setProperty("--font-strong","18px");
    }
  }
  resizeAll(); addEventListener('resize',()=>setTimeout(resizeAll,50));

  function loop(){
    requestAnimationFrame(loop);
    const W=view.width/(window.devicePixelRatio||1);
    const H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;

    pctx.globalCompositeOperation="source-over";
    pctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`;
    pctx.fillRect(0,0,PW,PH);

    if(camVideo.readyState>=2){
      const vw=camVideo.videoWidth, vh=camVideo.videoHeight;
      if(vw && vh){
        const base=Math.max(PW/vw,PH/vh);
        const sc=base*ZOOM;
        const dw=vw*sc, dh=vh*sc;
        const dx=(PW-dw)/2, dy=(PH-dh)/2;

        pctx.globalAlpha=GLOBAL_ALPHA;
        pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1.0;

        const frame=pctx.getImageData(0,0,PW,PH);
        const d=frame.data;
        for(let i=0;i<d.length;i+=4){
          const gray=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;
          d[i]=d[i+1]=d[i+2]=gray;
        }
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.drawImage(proc,0,0,W,H);
  }
  await attachCamera(); loop();

  // UI 흐름
  const overlay=document.getElementById('overlay');
  const overlayContent=document.getElementById('overlayContent');
  const startBtn=document.getElementById('startBtn');
  const goodnight=document.getElementById('goodnight');

  function crossfadeUpdate(html,nextAction){
    overlayContent.classList.add('hidden');          
    setTimeout(()=>{
      overlayContent.innerHTML=html;
      overlayContent.classList.remove('hidden');     
      nextAction && nextAction();
    },450);
  }

  function showGoodNight15s(){
    goodnight.classList.add('show');
    setTimeout(()=>{
      goodnight.classList.add('fadeout');
      setTimeout(()=>{
        goodnight.classList.remove('show','fadeout');
        goodnight.style.display='none';
      },600);
    },15000);
  }

  startBtn.addEventListener('click', ()=>{
    const line = s => `<div class="lineWrap"><span class="line">${s}</span></div>`;
    const introHTML = `
      ${line('<b>INTRODUCTION</b>')}
      ${line('1. 이곳은 이미 ‘너’가 죽어버린, ‘그것’들의 세계다.')}
      ${line('2. 곧 당신은 30분간의 잠에 들며, 무의식 속 여정을 시작한다.')}
      ${line('3. 그 여정 속에서 당신은 사라져간 ‘너’를 마주하게 된다.')}
      ${line('4. 이제 당신에게는 네 단계의 미션이 주어진다.')}
      ${line('5. 당신은 미션에 따라 헤드폰으로 들려오는 ‘너’들의 목소리에 귀 기울이며, 휴대폰을 통해 잃어버린 ‘너’를 포착해야 한다.')}
      <div id="countdown" class="lineWrap">
        <span class="line">THE DOOR WILL OPEN IN <span id="countNum">60</span> SECONDS.</span>
      </div>
    `;
    crossfadeUpdate(introHTML, ()=>{
      let count = 60;
      const numEl = document.getElementById('countNum');
      const timer = setInterval(()=>{
        count--;
        if(count>=0){ numEl.textContent = count; }
        if(count<=0){
          clearInterval(timer);
          overlay.classList.add('hidden');
          setTimeout(()=>{
            overlay.style.display='none';
            showGoodNight15s();
          },450);
        }
      },1000);
    });
  });

  // 캡쳐
  document.getElementById('captureBtn').addEventListener('click',()=>{
    try{
      const a=document.createElement('a');
      a.download=`capture_${Date.now()}.png`;
      a.href=view.toDataURL('image/png');
      a.click();
    }catch(e){ console.warn('캡쳐 실패', e); }
  });
})();
</script>
</body>
</html>
