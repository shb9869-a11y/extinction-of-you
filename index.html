<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera (BW + Trail) + Stream Overlay</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #stage{position:fixed;inset:0;background:#000}
  #view{
    position:absolute; inset:0; width:100%; height:100%;
    background:#000; touch-action:none;
  }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:12px 18px; border:0; border-radius:999px;
    font:700 16px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff; background:#12a150; z-index:10; display:none;
  }
  #hint{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    color:#fff; background:rgba(0,0,0,.55); padding:8px 12px; border-radius:8px;
    font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:none;
  }
</style>
</head>
<body>
  <div id="stage">
    <!-- ìµœì¢… í•©ì„± ê²°ê³¼ë¥¼ ê·¸ë¦¬ëŠ” ë©”ì¸ ìº”ë²„ìŠ¤ -->
    <canvas id="view"></canvas>
    <button id="start">ì‹œì‘</button>
    <div id="hint">iOS ìë™ì¬ìƒ/ê¶Œí•œ ë•Œë¬¸ì— ì‹œì‘ ë²„íŠ¼ì´ í•„ìš”í•  ìˆ˜ ìˆì–´ìš”</div>
  </div>

<script>
(async ()=>{
  // âœ… Cloudflare HLS (ê²€ì¦ëœ ì£¼ì†Œ; llhlsbeta ì œê±°)
  const STREAM_URL = "https://customer-e1rhmg8edq32stcl.cloudflarestream.com/0561f69cdb850354620ce2f93cbb05ce/manifest/video.m3u8";

  // ğŸ›ï¸ íš¨ê³¼/ê²¹ì¹¨ ì¡°ì ˆê°’
  const TRAIL_ALPHA = 0.06;   // ì”ìƒ ê¸¸ì´(ì‘ì„ìˆ˜ë¡ ì˜¤ë˜ ë‚¨ìŒ, 0.03~0.12 ê¶Œì¥)
  const STREAM_ALPHA = 0.70;  // ìŠ¤íŠ¸ë¦¼ ê²¹ì¹¨ ê°•ë„(0~1)

  const view = document.getElementById('view');
  const vctx = view.getContext('2d', { alpha:false });
  const startBtn = document.getElementById('start');
  const hint = document.getElementById('hint');

  // ë¹„ë””ì˜¤ ìš”ì†Œ(ë Œë”ë§ìš©ìœ¼ë¡œë§Œ, í™”ë©´ì— ì•ˆ ë³´ì„)
  const camVideo = document.createElement('video'); // ê´€ê° ì¹´ë©”ë¼
  camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;

  const streamVideo = document.createElement('video'); // ìŠ¤íŠ¸ë¦¼
  streamVideo.autoplay = true; streamVideo.playsInline = true; streamVideo.muted = true;

  // ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤(ì¹´ë©”ë¼ ì „ìš©: í‘ë°±+ì”ìƒ ëˆ„ì )
  let camCanvas = document.createElement('canvas');
  let camCtx = camCanvas.getContext('2d', { alpha:false });

  // DPR ëŒ€ì‘ ë¦¬ì‚¬ì´ì¦ˆ
  function resizeAll(){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(1, Math.floor(window.innerWidth));
    const h = Math.max(1, Math.floor(window.innerHeight));
    // ë©”ì¸
    view.style.width = w+'px'; view.style.height = h+'px';
    view.width = Math.floor(w * dpr); view.height = Math.floor(h * dpr);
    vctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    // ì¹´ë©”ë¼ ì˜¤í”„ìŠ¤í¬ë¦°
    camCanvas.width = Math.floor(w * dpr);
    camCanvas.height = Math.floor(h * dpr);
    camCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resizeAll);
  window.addEventListener('orientationchange', ()=>setTimeout(resizeAll, 200));
  resizeAll();

  // ë¹„ë””ì˜¤ë¥¼ object-fit: cover ì²˜ëŸ¼ ê·¸ë¦¬ê¸°
  function drawCover(video, ctx, w, h){
    const vw = video.videoWidth || 0, vh = video.videoHeight || 0;
    if (!vw || !vh) return;
    const scale = Math.max(w / vw, h / vh);
    const dw = vw * scale, dh = vh * scale;
    const dx = (w - dw) / 2, dy = (h - dh) / 2;
    ctx.drawImage(video, dx, dy, dw, dh);
  }

  // ìŠ¤íŠ¸ë¦¼ ë¶™ì´ê¸°
  function attachStream(){
    return new Promise((resolve)=>{
      if (streamVideo.canPlayType('application/vnd.apple.mpegurl')) {
        streamVideo.src = STREAM_URL;
        streamVideo.addEventListener('loadedmetadata', ()=>{ streamVideo.play().catch(()=>{}); resolve(); }, { once:true });
      } else if (window.Hls && Hls.isSupported()){
        const hls = new Hls({ lowLatencyMode:true });
        hls.loadSource(STREAM_URL);
        hls.attachMedia(streamVideo);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ streamVideo.play().catch(()=>{}); resolve(); });
      } else {
        streamVideo.src = STREAM_URL;
        streamVideo.addEventListener('loadedmetadata', ()=>{ streamVideo.play().catch(()=>{}); resolve(); }, { once:true });
      }
    });
  }

  // ì¹´ë©”ë¼ ë¶™ì´ê¸°: í›„ë©´ ì‹¤íŒ¨ ì‹œ ì „ë©´ìœ¼ë¡œ í´ë°±
  async function attachCamera(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      camVideo.srcObject = s;
      await camVideo.play().catch(()=>{});
    }catch(e1){
      // í´ë°±: ì „ë©´
      const s2 = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      camVideo.srcObject = s2;
      await camVideo.play().catch(()=>{});
    }
  }

  // ë Œë” ë£¨í”„
  let rafId = 0;
  function loop(){
    rafId = requestAnimationFrame(loop);

    const W = view.width / (window.devicePixelRatio||1);
    const H = view.height / (window.devicePixelRatio||1);

    // 1) ì¹´ë©”ë¼ ì˜¤í”„ìŠ¤í¬ë¦°ì— ì”ìƒ í˜ì´ë“œ
    camCtx.fillStyle = `rgba(0,0,0,${TRAIL_ALPHA})`;
    camCtx.fillRect(0,0,W,H);

    // 2) ì¹´ë©”ë¼(í‘ë°± í•„í„°)
    if (camVideo.readyState >= 2){
      camCtx.save();
      camCtx.filter = 'grayscale(100%)';
      drawCover(camVideo, camCtx, W, H);
      camCtx.restore();
    }

    // 3) ë©”ì¸ ìº”ë²„ìŠ¤ ì´ˆê¸°í™” í›„, ì¹´ë©”ë¼ ìº”ë²„ìŠ¤ ë³µì‚¬
    vctx.drawImage(camCanvas, 0, 0, W, H);

    // 4) ìŠ¤íŠ¸ë¦¼ ì˜¤ë²„ë ˆì´(íˆ¬ëª…ë„ ì ìš©)
    if (streamVideo.readyState >= 2){
      vctx.save();
      vctx.globalAlpha = STREAM_ALPHA;
      drawCover(streamVideo, vctx, W, H);
      vctx.restore();
    }
  }

  // ìë™ ì‹œì‘ â†’ ë§‰íˆë©´ ë²„íŠ¼ ë…¸ì¶œ
  async function startAll(){
    try{
      await attachCamera();
      await attachStream();
      startBtn.style.display = 'none';
      hint.style.display = 'none';
      if (!rafId) loop();
    }catch(e){
      startBtn.style.display = 'inline-block';
      hint.style.display = 'block';
    }
  }

  startBtn.addEventListener('click', startAll, { once:true });
  // iOSì—ì„œ ìë™ ì‹œì‘ì´ ë§‰íˆë©´ ë²„íŠ¼ì´ ëœ¸
  startAll();

  // íƒ­ ë³µê·€ ì‹œ ì¬ìƒ ë³´ì •
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden){
      camVideo.play().catch(()=>{});
      streamVideo.play().catch(()=>{});
    }
  });
})();
</script>
</body>
</html>
