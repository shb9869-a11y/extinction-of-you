<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera + Stream Composite</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #stage{
    position:fixed; inset:0; background:#000;
  }
  /* 흑백은 CSS 필터로 처리(사파리 호환 ↑) */
  #canvas{
    position:absolute; inset:0; width:100%; height:100%;
    background:#000; filter:grayscale(100%);
    touch-action:none;
  }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:12px 18px; border:0; border-radius:999px;
    font:700 16px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff; background:#12a150; display:none; z-index:10;
  }
  #hint{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    color:#fff; background:rgba(0,0,0,.5); padding:8px 12px; border-radius:8px;
    font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:none;
  }
</style>
</head>
<body>
  <div id="stage">
    <canvas id="canvas"></canvas>
    <button id="start">시작</button>
    <div id="hint">권한/자동재생 때문에 시작 버튼이 필요할 수 있어요</div>
  </div>

<script>
(async ()=>{
  // ✅ 잘 뜨는 HLS 주소(LL-HLS 파라미터 없이)
  const STREAM_URL = "https://customer-e1rhmg8edq32stcl.cloudflarestream.com/0561f69cdb850354620ce2f93cbb05ce/manifest/video.m3u8";

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:false });
  const startBtn = document.getElementById('start');
  const hint = document.getElementById('hint');

  // 내부 비디오 요소(표시는 안 함)
  const camVideo = document.createElement('video');
  camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;

  const streamVideo = document.createElement('video');
  streamVideo.autoplay = true; streamVideo.playsInline = true; streamVideo.muted = true;

  // 캔버스 리사이즈 (DPR 대응)
  function resizeCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(1, Math.floor(window.innerWidth));
    const h = Math.max(1, Math.floor(window.innerHeight));
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', ()=>setTimeout(resizeCanvas, 200));
  resizeCanvas();

  // 비디오를 캔버스에 'cover'로 그리기(가로세로비 유지)
  function drawCover(video, ctx, w, h){
    const vw = video.videoWidth || 0, vh = video.videoHeight || 0;
    if (!vw || !vh) return;
    const scale = Math.max(w / vw, h / vh);
    const dw = vw * scale, dh = vh * scale;
    const dx = (w - dw) / 2, dy = (h - dh) / 2;
    ctx.drawImage(video, dx, dy, dw, dh);
  }

  // 스트림 붙이기
  async function attachStream(){
    return new Promise((resolve)=>{
      if (streamVideo.canPlayType('appli
