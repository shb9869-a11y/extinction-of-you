<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,interactive-widget=resizes-content">
  <title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

  <!-- 픽셀 게임 폰트 -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SLEEP">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --appH: 100svh;
      --frame: clamp(16px, 4vmin, 40px);
      --ui-gap: 8px;

      --fs-body: clamp(12px, 2.2vmin, 16px);
      --fs-strong: clamp(14px, 2.8vmin, 20px);
      --fs-small: clamp(11px, 1.8vmin, 14px);
      --fs-name: clamp(14px,2.8vmin,20px);

      --pad-btn-y: clamp(6px, 1.1vmin, 10px);
      --pad-btn-x: clamp(10px, 1.8vmin, 20px);

      --safe-t: env(safe-area-inset-top, 0px);
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-l: env(safe-area-inset-left, 0px);
      --safe-r: env(safe-area-inset-right, 0px);

      --accent: #d0d0d0;
    }

    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
      touch-action:manipulation;
    }

    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
      color:var(--accent);
    }

    *{
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
      -webkit-tap-highlight-color: transparent;
      box-sizing:border-box;
    }
    input, textarea{
      -webkit-user-select:text;
      user-select:text;
    }

    .fade{opacity:0; transition:opacity 800ms ease;}
    .fade.show{opacity:1;}

    #view{
      position:fixed;
      left:0;
      top:0;
      width:100vw;
      height:100vh;
      display:block;
      z-index:0;
      filter:grayscale(1);
      background:#000;
    }

    .frameBox{
      position:fixed;
      left:calc(var(--frame) + var(--safe-l));
      top:calc(var(--frame) + var(--safe-t));
      right:calc(var(--frame) + var(--safe-r));
      bottom:calc(var(--frame) + var(--safe-b));
      border:2px solid rgba(208,208,208,.75);
      pointer-events:none;
      z-index:10;
    }

    .uiBtn{
      background:transparent;
      color:var(--accent);
      border:none;
      font-size:var(--fs-strong);
      padding:var(--pad-btn-y) var(--pad-btn-x);
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      white-space:nowrap;
      cursor:pointer;
    }
    .uiBtn.small{
      font-size:var(--fs-small);
      padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6);
    }
    .uiBtn.flat{
      border:none;
      background:transparent;
      text-decoration:none;
    }
    .uiBtn[disabled]{
      opacity:.3;
      pointer-events:none;
    }

    .controls{
      position:fixed;
      right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
      bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
      z-index:40;
      display:flex;
      gap:6px;
      align-items:center;
      opacity:0;
      transition:opacity 600ms ease;
    }
    .controls.show{opacity:1;}

    .readout{
      min-width:48px;
      text-align:center;
      opacity:.9;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      font-size:var(--fs-small);
      color:var(--accent);
    }

    .btn-capture{
      position:fixed;
      left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
      bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
      z-index:40;
      opacity:0;
      transition:opacity 600ms ease;
    }
    .btn-capture.show{opacity:1;}

    .sleep-status-text{
      position:fixed;
      left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
      bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b) + 36px);
      z-index:41;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      font-size:var(--fs-small);
      color:#ffd54f;
      text-shadow:0 0 4px rgba(0,0,0,0.8);
    }

    .skip-btn{
      position:fixed;
      left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
      top:calc(var(--frame) + var(--ui-gap) + var(--safe-t));
      z-index:50;
      display:none;
    }

    #runTimer{
      position:fixed;
      right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
      top:calc(var(--frame) + var(--ui-gap) + var(--safe-t));
      z-index:50;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      font-size:var(--fs-strong);
      color:var(--accent);
      opacity:.95;
      pointer-events:none;
      user-select:none;
      display:none;
    }

    .credits{
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      letter-spacing:.08em;
      font-size:clamp(9px,1.4vmin,11px);
      margin:0;
      color:var(--accent);
    }

    #rotateOverlay{
      position:fixed;
      inset:0;
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:#000;
      color:var(--accent);
      padding:40px;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    }

    /* Gate */
    #overlay{
      position:fixed;
      inset:0;
      z-index:300;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
      color:var(--accent);
      background:rgba(0,0,0,.85);
    }
    #overlayContent{
      max-width:min(92vw, 72ch);
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      line-height:1.7;
      text-align:center;
    }
    .gateLine{
      display:inline-block;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      font-size:var(--fs-small);
      border:none;
      background:transparent;
      color:var(--accent);
      cursor:pointer;
      padding:6px 10px;
      width:100%;
      line-height:1.6;
    }
    .gateHint{
      opacity:.7;
      margin-top:6px;
      font-size:clamp(9px,1.6vmin,11px);
    }

    /* Name */
    #nameOverlay{
      position:fixed;
      inset:0;
      z-index:260;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.5);
      color:var(--accent);
    }
    #nameCard{
      width:min(92vw,600px);
      text-align:center;
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      padding:24px 20px 20px;
      background:rgba(0,0,0,0.9);
      box-shadow:0 10px 24px rgba(0,0,0,0.8);
    }
    #nameCard h2{
      margin:0 0 12px 0;
      letter-spacing:.12em;
      font-size:var(--fs-name);
      font-weight:400;
      text-shadow:0 0 12px rgba(0,0,0,.9);
      color:var(--accent);
    }
    #nick{
      width:100%;
      padding:14px 14px;
      background:rgba(0,0,0,.88);
      border:1px solid #777;
      color:var(--accent);
      font-size:var(--fs-name);
      outline:none;
      box-shadow:0 0 12px rgba(0,0,0,.8);
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    }
    #nick::placeholder{
      color:rgba(208,208,208,0.25);
    }
    #nameRow{
      display:flex;
      gap:10px;
      margin-top:16px;
      justify-content:center;
    }

    /* Preset saver */
    #preset{
      position:fixed;
      inset:0;
      z-index:250;
      background:#000;
      display:none;
      cursor:pointer;
    }
    #presetCanvas{
      position:absolute;
      left:0;top:0;width:100%;height:100%;
    }

    /* Welcome */
    #overlayWelcome{
      position:fixed;
      inset:0;
      z-index:220;
      display:none;
      place-items:center;
      color:var(--accent);
      background:rgba(0,0,0,.55);
    }
    #welcomeCard{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:100%;
      max-width:min(92vw, 820px);
      margin:0 auto;
      text-align:center;
      padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;
      gap:18px;
    }
    #welcomeCard .title{
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      font-size:clamp(28px, 8vmin, 72px);
      font-weight:400;
      letter-spacing:.12em;
      line-height:1.15;
      margin:0;
      text-transform:uppercase;
      color:var(--accent);
      white-space:nowrap;
    }

    /* INTRO big title & text */
    #introBig{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index:210;
    }
    #introBigText{
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      letter-spacing:.16em;
      font-size:clamp(32px, 12vmin, 96px);
      text-transform:uppercase;
    }

    #introDialogue{
      position:fixed;
      right:calc(var(--frame) + var(--safe-r) + 12px);
      bottom:calc(var(--frame) + var(--safe-b) + 12px);
      max-width:min(420px, 60vw);
      padding:12px 14px 10px;
      border:1px solid rgba(208,208,208,0.9);
      background:#000;
      font-family:"Courier New",ui-monospace,monospace;
      font-size:clamp(11px,2.1vmin,15px);
      line-height:1.7;
      color:var(--accent);
      display:none;
      z-index:900;
    }
    #introText{
      margin-bottom:8px;
      text-align:left;
      white-space:pre-line;
    }

    /* NOTICE popup */
    #noticePopup{
      position:fixed;
      inset:0;
      z-index:400;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.75);
    }
    #noticeCard{
      width:min(92vw, 640px);
      background:#0b0b0b;
      color:var(--accent);
      border:1px solid #333;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      font-family:"Courier New",ui-monospace,monospace;
      line-height:1.7;
    }
    #noticeCard h3{
      margin:0 0 6px 0;
      letter-spacing:.06em;
      font-weight:700;
      font-size:clamp(15px,3vmin,20px);
      color:var(--accent);
    }

    /* CHAPTER overlay (중앙 문장) */
    #chapterOverlay{
      position:fixed;
      inset:0;
      z-index:350;
      display:none;
      align-items:center;
      justify-content:center;
      background:transparent;
      color:var(--accent);
      padding:24px;
      pointer-events:none;
      text-align:center;
    }
    #chapterBox{
      max-width:min(900px, 92vw);
      font-family:"Courier New",ui-monospace,monospace;
      line-height:1.8;
      font-size:clamp(11px,2.0vmin,15px);
      white-space:pre-line;
    }

    /* ENDING */
    #endOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:#000;
      color:var(--accent);
      z-index:500;
      text-align:center;
    }
    #endInner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
    }
    .sleepLine{
      font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
      letter-spacing:.16em;
      font-size:clamp(32px, 12vmin, 160px);
      text-transform:uppercase;
      white-space:nowrap;
      text-shadow:0 0 8px rgba(0,0,0,.85);
      margin:6px 0;
      padding:8px 16px;
    }
    #endReturn{
      font-family:"Courier New",ui-monospace,monospace;
      font-size:clamp(11px,2.0vmin,15px);
      max-width:72ch;
      line-height:1.7;
    }

    /* 캡쳐 플래시 */
    #flashLayer{
      position:fixed;
      inset:0;
      background:#fff;
      opacity:0;
      pointer-events:none;
      z-index:45;
      transition:opacity 300ms ease;
    }
  </style>
</head>
<body>
  <!-- 카메라 캔버스 -->
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <!-- 플래시 -->
  <div id="flashLayer"></div>

  <!-- 카메라 컨트롤 -->
  <div class="controls" id="controls">
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>
  <button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>

  <!-- 업로드 상태 -->
  <div id="sleepPhotoStatus" class="sleep-status-text"></div>

  <!-- 공통 SKIP / RETURN -->
  <button id="skipBtn"   class="uiBtn small skip-btn" type="button">SKIP</button>
  <button id="returnBtn" class="uiBtn small skip-btn" type="button" style="display:none;">RETURN</button>

  <!-- 타이머 -->
  <div id="runTimer" aria-live="polite">05:00</div>

  <!-- 회전 안내 -->
  <div id="rotateOverlay" aria-live="polite">
    <div>
      <b>Landscape mode required</b><br/>
      Please rotate your device to landscape.<br/>
      If the screen doesn’t rotate, unlock orientation.
    </div>
  </div>

  <!-- Permission Gate -->
  <div id="overlay" class="fade show">
    <div id="overlayContent">
      <div class="credits">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="gateLine" type="button">
        Tap anywhere to allow Camera, Microphone &amp; Motion sensors
      </button>
      <div class="gateHint">After allowing, you'll move to the name screen.</div>
    </div>
  </div>

  <!-- Name -->
  <div id="nameOverlay" class="fade">
    <div id="nameCard">
      <h2>TELL ME YOUR NAME</h2>
      <input id="nick" type="text" maxlength="24" placeholder="" autocomplete="off" />
      <div id="nameRow">
        <button id="nameSubmit" class="uiBtn flat" type="button">GO</button>
      </div>
    </div>
  </div>

  <!-- Preset saver -->
  <div id="preset" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <!-- Welcome -->
  <div id="overlayWelcome" class="fade">
    <div id="welcomeCard">
      <div class="credits">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div class="title">SLEEEEEEEEP,</div>
      <div class="title">SLEEEEEEEEP,</div>
      <div class="title">SLEEEEEEEEP,</div>
      <div class="title">SLEEEEEEEEP,</div>
      <button id="goIntro" class="uiBtn flat" type="button">PRESS HERE TO SLEEP</button>
    </div>
  </div>

  <!-- INTRODUCTION -->
  <div id="introBig" class="fade">
    <div id="introBigText">INTRODUCTION</div>
  </div>

  <div id="introDialogue">
    <div id="introText"></div>
    <button id="introNext" class="uiBtn small" type="button">NEXT</button>
  </div>

  <!-- NOTICE (FIRST SLEEP 설명) -->
  <div id="noticePopup" class="fade" role="dialog" aria-modal="true">
    <div id="noticeCard">
      <h3>NOTICE</h3>
      <p>※ “THE FIRST SLEEP”은 눈으로 인식하던 타자를 귀로 인식해 나가는 챕터입니다.</p>
      <p>※ 당신은 내면 세계의 탐험가로써 화면 아래 CAPTURE와 +, - 버튼을 눌러 흔적들을 포착합니다.</p>
      <p>※ 각 SLEEP은 5분 동안 유지됩니다.</p>
      <p>※ 확인하셨다면 아래 ‘OK’를 눌러주세요.</p>
      <div style="text-align:right;margin-top:10px;">
        <button id="noticeOk" class="uiBtn flat" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- CHAPTER TEXT -->
  <div id="chapterOverlay" class="fade">
    <div id="chapterBox"></div>
  </div>

  <!-- ENDING -->
  <div id="endOverlay" class="fade">
    <div id="endInner">
      <div id="endSilence" class="sleepLine"></div>
      <div id="endTheEnd" class="sleepLine"></div>
      <div id="endReturn"></div>
    </div>
  </div>

  <script>
    (() => {
      // ===== 업로드 서버 주소 (전시 공간에서 바뀌면 여기만 수정) =====
      const SLEEP_UPLOAD_SERVER = 'https://172.16.71.122:4443';

      // ===== 상태 =====
      let stage = 'gate';
      let displayName = '_____';

      // ===== DOM =====
      const view      = document.getElementById('view');
      const controls  = document.getElementById('controls');
      const zoomIn    = document.getElementById('zoomIn');
      const zoomOut   = document.getElementById('zoomOut');
      const zoomVal   = document.getElementById('zoomVal');
      const captureBtn= document.getElementById('captureBtn');
      const flashLayer= document.getElementById('flashLayer');
      const statusEl  = document.getElementById('sleepPhotoStatus');

      const rotateOverlay = document.getElementById('rotateOverlay');

      const overlay   = document.getElementById('overlay');
      const permBtn   = document.getElementById('permGateBtn');

      const nameOverlay = document.getElementById('nameOverlay');
      const nickInput   = document.getElementById('nick');
      const nameSubmit  = document.getElementById('nameSubmit');

      const preset       = document.getElementById('preset');
      const presetCanvas = document.getElementById('presetCanvas');

      const welcome  = document.getElementById('overlayWelcome');
      const goIntro  = document.getElementById('goIntro');

      const introBig      = document.getElementById('introBig');
      const introDialogue = document.getElementById('introDialogue');
      const introTextEl   = document.getElementById('introText');
      const introNextBtn  = document.getElementById('introNext');

      const noticePopup = document.getElementById('noticePopup');
      const noticeOk    = document.getElementById('noticeOk');

      const chapterOverlay = document.getElementById('chapterOverlay');
      const chapterBox     = document.getElementById('chapterBox');

      const skipBtn   = document.getElementById('skipBtn');
      const returnBtn = document.getElementById('returnBtn');
      const runTimer  = document.getElementById('runTimer');

      const endOverlay = document.getElementById('endOverlay');
      const endSilence = document.getElementById('endSilence');
      const endTheEnd  = document.getElementById('endTheEnd');
      const endReturn  = document.getElementById('endReturn');

      // ===== 캔버스/카메라 =====
      const vctx = view.getContext('2d', { alpha:false });
      let camStream = null;
      let camVideo  = null;
      let camReady  = false;
      let animRunning = false;
      let ZOOM = 1.0;

      function setAppH(){
        document.documentElement.style.setProperty('--appH', window.innerHeight + 'px');
      }
      setAppH();
      window.addEventListener('resize', setAppH, {passive:true});

      function resizeView(){
        view.width  = window.innerWidth;
        view.height = window.innerHeight;
      }
      resizeView();
      window.addEventListener('resize', resizeView, {passive:true});

      function updateRotateOverlay(){
        const vv = window.visualViewport;
        const w = vv ? vv.width : window.innerWidth;
        const h = vv ? vv.height: window.innerHeight;
        rotateOverlay.style.display = (h > w) ? 'flex' : 'none';
      }
      ['load','resize','orientationchange','pageshow'].forEach(ev=>{
        window.addEventListener(ev, updateRotateOverlay, {passive:true});
      });
      updateRotateOverlay();

      function updateZoomLabel(){
        zoomVal.textContent = ZOOM.toFixed(1) + '×';
      }
      updateZoomLabel();

      zoomIn.addEventListener('click', ()=>{
        ZOOM = Math.min(3.0, ZOOM + 0.1);
        updateZoomLabel();
      });
      zoomOut.addEventListener('click', ()=>{
        ZOOM = 1.0;
        updateZoomLabel();
      });

      async function startCamera(){
        if(camStream) return;
        try{
          camStream = await navigator.mediaDevices.getUserMedia({
            video:{
              facingMode:{ideal:'environment'},
              width:{min:1280,ideal:1920},
              height:{min:720, ideal:1080}
            },
            audio:false
          });
          camVideo = document.createElement('video');
          camVideo.srcObject = camStream;
          camVideo.playsInline = true;
          await camVideo.play();
          camReady = true;
          if(!animRunning){
            animRunning = true;
            requestAnimationFrame(renderLoop);
          }
        }catch(e){
          console.error('camera error', e);
        }
      }

      function stopCamera(){
        if(camStream){
          camStream.getTracks().forEach(t=>t.stop());
          camStream = null;
        }
        camReady = false;
      }

      function renderLoop(){
        if(!animRunning){
          return;
        }
        const w = view.width;
        const h = view.height;

        vctx.fillStyle = '#000';
        vctx.fillRect(0,0,w,h);

        if(camReady && camVideo && camVideo.videoWidth){
          const vw = camVideo.videoWidth;
          const vh = camVideo.videoHeight;

          const scale = Math.max(w/vw, h/vh) * ZOOM;
          const dw = vw * scale;
          const dh = vh * scale;
          const dx = (w - dw)/2;
          const dy = (h - dh)/2;

          vctx.drawImage(camVideo, dx, dy, dw, dh);
        }

        requestAnimationFrame(renderLoop);
      }

      // ===== 업로드 =====
      function setStatus(msg){
        statusEl.textContent = msg || '';
      }

      async function uploadSnapshotCanvas(canvas){
        try{
          setStatus('서버로 업로드 중입니다...');
          const blob = await new Promise(resolve=>{
            canvas.toBlob(b => resolve(b), 'image/jpeg', 0.9);
          });
          if(!blob){
            setStatus('캡쳐 이미지 생성 실패');
            return;
          }
          const formData = new FormData();
          formData.append('image', blob, `sleep_capture_${Date.now()}.jpg`);

          const base = (SLEEP_UPLOAD_SERVER && SLEEP_UPLOAD_SERVER.trim())
            ? SLEEP_UPLOAD_SERVER.trim()
            : '';
          const res = await fetch(base + '/upload', {
            method:'POST',
            body:formData
          });
          if(!res.ok){
            setStatus('업로드 실패: ' + res.status);
            return;
          }
          await res.json().catch(()=>({}));
          setStatus('업로드 완료! (잠시 후 화면에 반영됩니다)');
        }catch(e){
          console.error(e);
          setStatus('업로드 중 오류가 발생했습니다');
        }finally{
          setTimeout(()=>setStatus(''), 5000);
        }
      }

      function flash(){
        flashLayer.style.opacity = '1';
        requestAnimationFrame(()=>{
          flashLayer.style.opacity = '0';
        });
      }

      captureBtn.addEventListener('click', async ()=>{
        if(!camReady) return;
        const temp = document.createElement('canvas');
        temp.width  = view.width;
        temp.height = view.height;
        const tctx = temp.getContext('2d');
        tctx.drawImage(view, 0, 0);
        flash();
        await uploadSnapshotCanvas(temp);
      });

      // ===== TTS =====
      let ttsReady = 'speechSynthesis' in window;
      let ttsVoice = null;

      function selectKoreanVoice(voices){
        if(!voices || !voices.length) return null;
        const ko = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ko'));
        if(ko.length) return ko[0];
        return voices[0];
      }

      function initTts(){
        if(!ttsReady) return;
        const voices = window.speechSynthesis.getVoices() || [];
        if(!voices.length){
          setTimeout(initTts, 400);
          return;
        }
        ttsVoice = selectKoreanVoice(voices);
      }
      if(ttsReady){
        initTts();
        window.speechSynthesis.onvoiceschanged = initTts;
      }

      function speakText(text){
        if(!ttsReady || !text) return;
        try{
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          if(ttsVoice) u.voice = ttsVoice;
          u.lang = (ttsVoice && ttsVoice.lang) ? ttsVoice.lang : 'ko-KR';

          const ua = navigator.userAgent || '';
          const isAndroid = /Android|SM-|Samsung/i.test(ua);
          const isIOS     = /iPhone|iPad|iPod/i.test(ua);

          let pitch = 1.0;
          let rate  = 0.9;
          if(isIOS){
            pitch = 1.0;
            rate  = 0.95;
          }else if(isAndroid){
            pitch = 0.95;
            rate  = 0.95;
          }
          u.pitch  = pitch;
          u.rate   = rate;
          u.volume = 1.0;

          window.speechSynthesis.speak(u);
        }catch(e){}
      }

      // ===== Gate: 첫 탭에서 권한 요청 & 이름 화면 이동 =====
      async function immediateGestureStart(ev){
        ev && ev.preventDefault && ev.preventDefault();

        try{
          const s = await navigator.mediaDevices.getUserMedia({
            video:true,
            audio:true
          });
          s.getTracks().forEach(t=>t.stop());
        }catch(e){
          console.warn('permission error', e);
        }

        overlay.classList.remove('show');
        overlay.style.display = 'none';

        showPreset();
        showName();
        stage = 'name';
        setTimeout(()=>nickInput.focus(), 50);
      }

      ['click','touchstart','pointerdown'].forEach(type=>{
        permBtn.addEventListener(type, immediateGestureStart, {passive:false});
        overlay.addEventListener(type, immediateGestureStart, {passive:false});
      });

      // ===== Name =====
      async function acceptName(){
        const v = (nickInput.value || '').trim();
        if(v.length > 0) displayName = v;
        nameOverlay.classList.remove('show');
        nameOverlay.style.display = 'none';
        stage = 'preset';
        skipBtn.style.display = 'block';
      }

      nameSubmit.addEventListener('click', acceptName);
      nickInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') acceptName();
      });

      function showName(){
        nameOverlay.style.display = 'flex';
        requestAnimationFrame(()=> nameOverlay.classList.add('show'));
      }

      // ===== Preset saver(SLEEEEEEEP) =====
      let saverObjs = [];
      let saverLastTime = 0;
      const saverLetters = ['S','L','E','E','E','E','E','E','E','E','P'];

      function initSaver(){
        const w = preset.clientWidth || window.innerWidth;
        const h = preset.clientHeight || window.innerHeight;
        saverObjs = [];
        for(let i=0;i<20;i++){
          saverObjs.push({
            ch: saverLetters[i % saverLetters.length],
            x: Math.random()*w,
            y: Math.random()*h,
            vx:(Math.random()*0.2+0.08)*(Math.random()<0.5?-1:1),
            vy:(Math.random()*0.2+0.08)*(Math.random()<0.5?-1:1),
            size:(Math.floor(Math.random()*40)+80)
          });
        }
        saverLastTime = performance.now();
        requestAnimationFrame(saverLoop);
      }

      function saverLoop(now){
        if(preset.style.display === 'none') return;
        const dt = (now - saverLastTime)/1000;
        saverLastTime = now;

        const w = presetCanvas.width  = preset.clientWidth  || window.innerWidth;
        const h = presetCanvas.height = preset.clientHeight || window.innerHeight;
        const ctx = presetCanvas.getContext('2d');
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,w,h);
        ctx.fillStyle = '#d0d0d0';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        saverObjs.forEach(o=>{
          o.x += o.vx * 60 * dt;
          o.y += o.vy * 60 * dt;
          if(o.x < 0 || o.x > w) o.vx *= -1;
          if(o.y < 0 || o.y > h) o.vy *= -1;

          const wobble = Math.sin(now/400 + o.x*0.01 + o.y*0.01) * 4;
          ctx.font = `${o.size}px "Press Start 2P","Courier New",monospace`;
          ctx.fillText(o.ch, o.x, o.y + wobble);
        });

        requestAnimationFrame(saverLoop);
      }

      function showPreset(){
        if(preset.style.display === 'block') return;
        preset.style.display = 'block';
        requestAnimationFrame(()=> preset.classList.add('show'));
        initSaver();
        startCamera(); // 프리셋 단계에서 카메라 이미 켜두기
      }

      preset.addEventListener('click', ()=>{
        if(stage === 'preset'){
          // 프리셋 → 웰컴
          preset.classList.remove('show');
          preset.style.display = 'none';
          showWelcome();
          stage = 'welcome';
        }
      });

      // ===== Welcome → INTRO =====
      function showWelcome(){
        welcome.style.display = 'grid';
        requestAnimationFrame(()=>welcome.classList.add('show'));
      }

      goIntro.addEventListener('click', ()=>{
        welcome.classList.remove('show');
        welcome.style.display = 'none';
        showIntro();
      });

      const INTRO_LINES = [
        "당신은 지금 막 잠에 들려고 합니다.",
        "이 화면은, 당신의 내면으로 들어가는 작은 문입니다.",
        "곧 네 번의 수면 단계가 시작됩니다.",
        "각 수면은 5분 동안 유지되며,\n당신은 그 안에서 타자의 목소리와 흔적들을 포착하게 됩니다."
      ];
      let introIndex = 0;

      function showIntro(){
        introIndex = 0;
        introBig.style.display = 'flex';
        introDialogue.style.display = 'block';
        requestAnimationFrame(()=>{
          introBig.classList.add('show');
        });
        showIntroLine();
      }

      function showIntroLine(){
        const line = INTRO_LINES[introIndex] || "";
        introTextEl.textContent = line;
        speakText(line);
      }

      introNextBtn.addEventListener('click', ()=>{
        introIndex++;
        if(introIndex >= INTRO_LINES.length){
          // INTRO 종료 → NOTICE
          introDialogue.style.display = 'none';
          introBig.classList.remove('show');
          setTimeout(()=>{ introBig.style.display = 'none'; }, 800);
          showNotice();
        }else{
          showIntroLine();
        }
      });

      function showNotice(){
        noticePopup.style.display = 'flex';
        requestAnimationFrame(()=> noticePopup.classList.add('show'));
      }

      noticeOk.addEventListener('click', ()=>{
        noticePopup.classList.remove('show');
        setTimeout(()=> noticePopup.style.display='none', 800);
        startChapter(0);
      });

      // ===== CHAPTERS =====
      const CHAPTERS = [
        { id: 'THE FIRST SLEEP',  duration: 5*60 },
        { id: 'THE SECOND SLEEP', duration: 5*60 },
        { id: 'THE THIRD SLEEP',  duration: 5*60 },
        { id: 'THE FOURTH SLEEP', duration: 5*60 }
      ];

      const CHAPTER_TEXTS = [
        "FIRST SLEEP\n\n여기에 1장의 문장을\n자유롭게 채워 넣으세요.",
        "SECOND SLEEP\n\n여기는 2장의 장면입니다.",
        "THIRD SLEEP\n\n여기는 3장의 장면입니다.",
        "FOURTH SLEEP\n\n여기는 4장의 장면입니다."
      ];

      let currentChapter = -1;
      let timerId = null;
      let timerRemain = 0;

      function setTimerDisplay(sec){
        const m = Math.floor(sec/60);
        const s = sec % 60;
        runTimer.textContent =
          String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      }

      function clearTimer(){
        if(timerId){
          clearInterval(timerId);
          timerId = null;
        }
      }

      function startChapter(chIndex){
        clearTimer();
        currentChapter = chIndex;

        stage = 'chapter' + (chIndex+1);
        chapterBox.textContent = CHAPTER_TEXTS[chIndex] || '';
        chapterOverlay.style.display = 'flex';
        requestAnimationFrame(()=> chapterOverlay.classList.add('show'));

        controls.classList.add('show');
        captureBtn.classList.add('show');
        skipBtn.style.display = 'block';

        runTimer.style.display = 'block';
        timerRemain = CHAPTERS[chIndex].duration;
        setTimerDisplay(timerRemain);

        startCamera();

        timerId = setInterval(()=>{
          timerRemain--;
          if(timerRemain <= 0){
            clearTimer();
            nextChapterOrEnd();
          }else{
            setTimerDisplay(timerRemain);
          }
        }, 1000);
      }

      function nextChapterOrEnd(){
        chapterOverlay.classList.remove('show');
        setTimeout(()=>{ chapterOverlay.style.display = 'none'; }, 800);

        const nextIndex = currentChapter + 1;
        if(nextIndex < CHAPTERS.length){
          startChapter(nextIndex);
        }else{
          showEnding();
        }
      }

      function showEnding(){
        clearTimer();
        controls.classList.remove('show');
        captureBtn.classList.remove('show');
        runTimer.style.display = 'none';
        skipBtn.style.display = 'none';

        stopCamera();

        endSilence.textContent = 'SILENCE';
        endTheEnd.textContent  = '';
        endReturn.innerHTML = '';

        endOverlay.style.display = 'flex';
        requestAnimationFrame(()=> endOverlay.classList.add('show'));

        setTimeout(()=>{
          endSilence.textContent = '';
          endTheEnd.textContent  = 'THE END';
          endReturn.textContent  = 'RETURN 을 누르면 처음으로 돌아갑니다.';
          returnBtn.style.display = 'block';
        }, 4000);
        stage = 'ending';
      }

      // ===== SKIP & RETURN =====
      skipBtn.addEventListener('click', ()=>{
        if(stage.startsWith('chapter')){
          clearTimer();
          nextChapterOrEnd();
        }else if(stage === 'preset'){
          preset.click();
        }else if(stage === 'welcome'){
          goIntro.click();
        }else if(stage === 'name'){
          acceptName();
        }
      });

      returnBtn.addEventListener('click', ()=>{
        // 완전 리셋: 그냥 새로고침
        try{
          window.location.reload();
        }catch(e){
          // 혹시 안 되면 강제로 초기 상태만
          endOverlay.style.display='none';
          overlay.style.display='flex';
          overlay.classList.add('show');
          stage = 'gate';
        }
      });

      // 기본 컨텍스트 메뉴 방지
      document.addEventListener('contextmenu', e=>e.preventDefault());
      document.addEventListener('selectstart', e=>e.preventDefault());
    })();
  </script>
</body>
</html>