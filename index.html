<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh;
    --frame: clamp(16px, 4vmin, 40px);
    --ui-gap: 8px;

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);

    --pad-btn-y: clamp(6px, 1.1vmin, 10px);
    --pad-btn-x: clamp(10px, 1.8vmin, 20px);

    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  body{font-family:Impact,"Anton","Arial Black",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;}

  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  .frameBox{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    right:calc(var(--frame) + var(--safe-r));
    bottom:calc(var(--frame) + var(--safe-b));
    border:1px solid #000; pointer-events:none; z-index:50;
  }

  .uiBtn{background:#000;color:#fff;border:1px solid #444;font-size:var(--fs-strong);
    padding:var(--pad-btn-y) var(--pad-btn-x);font-family:"Courier New",ui-monospace,monospace;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}
  .uiBtn.flat{border:none;background:transparent;text-decoration:underline;text-underline-offset:3px}
  .uiBtn[disabled]{opacity:.35;pointer-events:none;filter:grayscale(1)}
  .hide{display:none !important;}

  .controls{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-family:"Courier New",ui-monospace,monospace;font-size:var(--fs-small);color:#ddd}
  .btn-capture{
    position:fixed;
    left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:150}

  #mapLauncher{
    position:fixed; right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}
  #docLauncher{
    position:fixed; left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:180;}

  #overlay{
    position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
    padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
    color:#fff;background:rgba(0,0,0,.85)
  }
  #overlayContent{max-width:min(92vw, 72ch);font-family:"Courier New",ui-monospace,monospace;line-height:1.7;text-align:center}
  .tip{opacity:.8;font-size:var(--fs-small)}

  #preset{position:fixed;inset:0;z-index:250;background:#000;display:none;cursor:pointer}
  #presetCanvas{position:absolute;left:0;top:0;width:100%;height:100%}

  #overlayWelcome{position:fixed;inset:0;z-index:220;display:none;align-items:center;justify-content:center;color:#fff;background:rgba(0,0,0,.55);padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;}
  #welcomeCard{ text-align:center; max-width:min(92vw, 700px); }

  #introOverlay{
    position:fixed; inset:0; z-index:230; display:none; align-items:center; justify-content:center;
    color:#fff; background:rgba(0,0,0,.75); padding:calc(20px + var(--safe-t)) 20px calc(20px + var(--safe-b)) 20px;
    font-family:"Courier New",ui-monospace,monospace;
  }
  #introBox{ width:min(92vw, 860px); }
  #introBox h2{margin:.2em 0 .6em 0; font-size:clamp(16px, 3.2vmin, 24px); letter-spacing:.1em; text-align:center;}
  #introBox p, #introBox li{font-size:var(--fs-body); line-height:1.8;}
  #introBox ol{padding-left:1.2em; margin:.4em 0 1em 0;}
  .count{margin-top:10px; text-align:center; font-size:var(--fs-strong);}

  #titleScreen{
    position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center;
    background:#000; color:#fff; text-align:center; padding:calc(var(--safe-t)) calc(var(--safe-r)) calc(var(--safe-b)) calc(var(--safe-l));
  }
  #titleText{font-weight:900; letter-spacing:.06em; line-height:1.05;
    font-size:clamp(24px, 10vmin, 96px);}

  #docOverlay{ position:fixed; inset:0; z-index:210; display:none; background:rgba(0,0,0,.8); color:#fff; font-family:"Courier New",ui-monospace,monospace; padding-bottom:var(--safe-b); padding-top:var(--safe-t);}
  #docUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(96vw,1100px); display:flex; flex-direction:column; gap:10px; }
  #docHeader{ display:flex; justify-content:space-between; align-items:center; }
  #docGrid{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; }
  .docBtn{ border:1px solid #444; background:#000; color:#fff; padding:12px; text-align:center; cursor:pointer; font-size:var(--fs-small) }
  .docPane{ border:1px solid #444; padding:12px; max-height:50vh; overflow:auto; background:#000; }

  #mapOverlay{ position:fixed; inset:0; z-index:210; display:none; background:rgba(0,0,0,.8); color:#fff; font-family:"Courier New",ui-monospace,monospace; }
  #mapUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; width:min(92vw, 820px); }
  #mapUI h3{ letter-spacing:.08em; }

  .fade-enter{opacity:0; transition:opacity .45s ease}
  .fade-enter.show{opacity:1}
  .fade-leave{opacity:1; transition:opacity .45s ease}
  .fade-leave.hide{opacity:0}
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <div class="controls">
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>
  <button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>

  <button id="docLauncher" class="uiBtn small">DOCUMENT</button>
  <button id="mapLauncher" class="uiBtn small">MAP</button>

  <div id="overlay">
    <div id="overlayContent">
      <div style="margin-bottom:10px">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <button id="permGateBtn" class="uiBtn">화면을 탭하여 카메라·동작(센서)·오디오를 허용해주세요</button>
      <div class="tip">승인 후 ‘SLEEEEE…’ 프리셋 화면이 뜹니다.</div>
    </div>
  </div>

  <div id="preset" title="Tap to continue">
    <canvas id="presetCanvas"></canvas>
  </div>

  <div id="overlayWelcome">
    <div id="welcomeCard">
      <div style="letter-spacing:.1em;margin-bottom:12px;">SHB, KHJ, JYS, KTK, KCW, KJS, JMJ, PHY</div>
      <div style="font-size:clamp(16px,3.6vmin,28px);font-weight:900;letter-spacing:.06em;line-height:1.1;margin-bottom:14px;">
        Welcome to<br>
        SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP,<br>
        SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP
      </div>
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="goIntro" class="uiBtn flat">PRESS HERE TO SLEEP</button>
        <!-- [UI RESTORE] 즉시 스킵 버튼 -->
        <button id="skipAll" class="uiBtn small">SKIP ▶</button>
      </div>
    </div>
  </div>

  <!-- INTRODUCTION (30초) -->
  <div id="introOverlay"><div id="introBox">
    <h2>INTRODUCTION</h2>

    <p>지금 이 화면을 보고 있는 당신,<br>
    주변의 소리에 천천히 귀를 기울이며 공간을 거닐기 시작합니다.<br>
    지금부터 당신은 약 30분 간, 짧은 단잠에 들게 됩니다.</p>

    <ol>
      <li>당신이 거닐고 있는 이곳의 세계관 설명입니다.</li>
      <li>우리는 언제나 타자와 함께 존재해왔습니다. 친구, 엄마, 누나, 아버지, 지나가는 저 사람과 같이 말이죠.</li>
      <li>그러나 어느 순간, ‘너’로 존재했던 그들은 ‘너’가 아닌 ‘그것’으로 전락하기 시작했습니다.</li>
      <li>이제는 그 어느곳에서도 ‘너’를 찾아볼 수는 없습니다.</li>
      <li>‘그것’으로 전락한 ‘너’들은 서서히 우리의 내면 속에서 희미해져 가고 있기 때문이죠.</li>
      <li>마치 꿈 속에서 분명 누군가를 만난 것 같은데, 그게 누구인지 떠오르지 않는 것처럼.</li>
      <li>네, 그렇습니다. 이곳은 바로, 그 ‘너’가 사라져버린, ‘너’를 제거해버린, 누군가의 내면 세계입니다.</li>
    </ol>

    <p>당신의 의식이 서서히 희미해져가는 지금, 두 번의 심호흡을 크게 한 후,</p>
    <p>이 내면의 미로를 거닐며, 천천히 눈을 감고,</p>
    <p>이 세상에서 사라져버린 ‘너’의 이야기에 귀를 기울입니다.</p>

    <div class="count">It will come in <span id="countNum">30</span> seconds.</div>
  </div></div>

  <div id="titleScreen"><div id="titleText"></div></div>

  <div id="docOverlay">
    <div id="docUI">
      <div id="docHeader">
        <div class="readout">DOCUMENTS</div>
        <div><button id="btnExitDoc" class="uiBtn small">EXIT</button></div>
      </div>
      <div id="docGrid"></div>
      <div id="docPane" class="docPane" style="display:none">
        <div class="docTitle" id="docTitle" style="font-size:var(--fs-strong);margin-bottom:8px;">Document</div>
        <div id="docBody">준비중입니다.</div>
      </div>
    </div>
  </div>

  <div id="mapOverlay">
    <div id="mapUI">
      <h3>MAP</h3>
      <p style="opacity:.85">지금은 준비 중입니다. (게임 모듈 비활성화)</p>
      <button id="btnExitMap" class="uiBtn small" style="margin-top:10px">EXIT</button>
    </div>
  </div>

<script>
(() => {
  (function injectManifest(){
    const manifest = {"name":"SLEEEEEP","short_name":"SLEEEEEP","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  function setAppH(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppH(); addEventListener('resize', setAppH, {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppH,50)); }

  const qs = s => document.querySelector(s);

  const overlay = qs('#overlay');
  const permBtn = qs('#permGateBtn');

  const preset = qs('#preset');
  const presetCanvas = qs('#presetCanvas');

  const welcome = qs('#overlayWelcome');
  const goIntroBtn = qs('#goIntro');
  const skipAllBtn = qs('#skipAll'); // [UI RESTORE]

  const intro = qs('#introOverlay');
  const countNum = qs('#countNum');

  const titleScreen = qs('#titleScreen');
  const titleText = qs('#titleText');

  const docBtn = qs('#docLauncher');
  const mapBtn = qs('#mapLauncher');
  const zoomIn = qs('#zoomIn');
  const zoomOut = qs('#zoomOut');
  const zoomVal = qs('#zoomVal');
  const captureBtn = qs('#captureBtn');

  const docOverlay = qs('#docOverlay');
  const btnExitDoc = qs('#btnExitDoc');
  const docGrid = qs('#docGrid');
  const docPane = qs('#docPane');
  const docTitle = qs('#docTitle');
  const docBody = qs('#docBody');

  const mapOverlay = qs('#mapOverlay');
  const btnExitMap = qs('#btnExitMap');

  const view = qs('#view');

  // [UI RESTORE] 전역 UI 상태 토글러
  let UI_HIDDEN = false;
  function showUI(){
    UI_HIDDEN = false;
    hideTopUI(false);
  }
  function hideUI(){
    UI_HIDDEN = true;
    hideTopUI(true);
  }
  function toggleUI(){
    UI_HIDDEN ? showUI() : hideUI();
  }
  // 비상 토글: U 키
  window.addEventListener('keydown', (e)=>{
    if ((e.key||'').toLowerCase()==='u'){ toggleUI(); }
  });

  let camStream=null, camVideo=null, vctx=null, proc=null, pctx=null, ZOOM=1.0;
  function updateZoomLabel(){ zoomVal.textContent = ZOOM.toFixed(1)+'×'; }
  updateZoomLabel();
  zoomIn.addEventListener('click', ()=>{ ZOOM=Math.min(3.0, ZOOM+0.05); updateZoomLabel(); }, {passive:true});
  zoomOut.addEventListener('click', ()=>{ ZOOM=Math.max(0.35, ZOOM-0.05); updateZoomLabel(); }, {passive:true});

  async function requestMotionPermissions(){
    const needsIOS = typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function';
    try{ if(needsIOS){ await DeviceOrientationEvent.requestPermission().catch(()=>{}); } }catch{}
  }

  async function gate(){
    try{
      await requestMotionPermissions();
      camStream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}}, audio:false
      });
    }catch(e){ console.warn('permission error:', e); }
    overlay.style.display='none';
    showPreset();
  }

  ['pointerdown','touchstart','click','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{ if(overlay.style.display!=='none') gate(); }, {once:true, capture:true, passive:true});
  });
  permBtn.addEventListener('click',(e)=>{ e.preventDefault(); gate(); },{passive:false});

  function drawPreset(){
    const dpr = window.devicePixelRatio||1;
    const w = preset.clientWidth, h = preset.clientHeight;
    presetCanvas.width = w*dpr; presetCanvas.height = h*dpr;
    const ctx = presetCanvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#fff';

    const base = Math.min(w,h);
    const colGutter = base*0.06;
    const colWidth = base*0.18;
    const columns = Math.max(3, Math.floor((w + colGutter)/(colWidth + colGutter)));
    const usableW = columns*colWidth + (columns-1)*colGutter;
    const left = (w-usableW)/2;

    const fontSize = colWidth*0.9;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font = `900 ${fontSize}px Impact, Anton, "Arial Black", system-ui, sans-serif`;

    for(let c=0;c<columns;c++){
      const x = left + c*(colWidth+colGutter) + colWidth/2;
      const isSide = (c===0 || c===columns-1);
      const step = fontSize*1.35;
      const startY = (h % step)/2;
      for(let y=startY; y<h; y+=step){
        const ch = isSide ? ( (Math.round(y/step)%6===0) ? 'S' : 'E') : 'E';
        ctx.fillText(ch, x, y);
      }
    }
  }
  function showPreset(){
    hideUI(); // 오버레이 동안 UI 숨김
    preset.style.display='block';
    drawPreset();
  }
  addEventListener('resize', ()=>{ if(preset.style.display==='block') drawPreset(); }, {passive:true});
  preset.addEventListener('click', ()=>{
    preset.style.display='none';
    startCamera();
    showWelcome();
  }, {passive:true});

  function showWelcome(){ welcome.style.display='flex'; }
  goIntroBtn.addEventListener('click', ()=>{
    welcome.style.display='none';
    showIntro();
  }, {passive:true});

  // [UI RESTORE] 스킵: 바로 UI 복원 + 타이틀 시퀀스 생략
  skipAllBtn.addEventListener('click', ()=>{
    welcome.style.display='none';
    titleScreen.style.display='none';
    intro.style.display='none';
    showUI(); // 즉시 복원
  }, {passive:true});

  function startCamera(){
    camVideo = document.createElement('video'); camVideo.autoplay=true; camVideo.playsInline=true; camVideo.muted=true;
    camVideo.srcObject = camStream;
    vctx = view.getContext('2d',{alpha:false});
    proc = document.createElement('canvas'); pctx = proc.getContext('2d',{willReadFrequently:true});
    resizeCam(); loopCam();
  }
  function resizeCam(){
    const dpr = window.devicePixelRatio||1;
    const w = window.innerWidth, h = window.innerHeight;
    view.width=w*dpr; view.height=h*dpr; vctx.setTransform(dpr,0,0,dpr,0,0);
    const scale = matchMedia('(orientation: landscape)').matches? 0.86 : 0.9;
    proc.width=Math.floor(w*scale); proc.height=Math.floor(h*scale);
  }
  addEventListener('resize', ()=>setTimeout(resizeCam,50), {passive:true});

  function loopCam(){
    requestAnimationFrame(loopCam);
    const W=view.width/(window.devicePixelRatio||1), H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;
    pctx.fillStyle='rgba(0,0,0,.14)'; pctx.fillRect(0,0,PW,PH);
    if(camVideo.readyState>=2){
      const vw=camVideo.videoWidth||0, vh=camVideo.videoHeight||0;
      if(vw&&vh){
        const cover=Math.max(PW/vw, PH/vh)*ZOOM;
        const dw=vw*cover, dh=vh*cover, dx=(PW-dw)/2, dy=(PH-dh)/2;
        pctx.globalAlpha=.7; pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1;
        const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;
        for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.drawImage(proc,0,0,W,H);
  }

  /* INTRO (30s) */
  function showIntro(){
    hideUI();
    intro.style.display='flex';
    let count=30;
    countNum.textContent = count;
    const t = setInterval(()=>{
      count--;
      if(count>=0) countNum.textContent = count;
      if(count<=0){
        clearInterval(t);
        intro.style.display='none';
        runChapters();
      }
    },1000);
  }

  const chapters = [
    'INTRODUCTION',
    'THE FIRST SLEEP',
    'THE SECOND SLEEP',
    'THE THIRD SLEEP',
    'THE FOURTH SLEEP',
    'SILENCE'
  ];
  async function runChapters(){
    for(const label of chapters){ await showTitle(label, 1500); }
    showUI(); // [UI RESTORE] 챕터 종료 후 UI 복원
  }
  function showTitle(text, hold=1500){
    return new Promise(res=>{
      titleText.textContent = text;
      titleScreen.style.display='flex';
      titleScreen.className='fade-enter show';
      setTimeout(()=>{ titleScreen.className='fade-leave'; requestAnimationFrame(()=>{ titleScreen.classList.add('hide'); });
        setTimeout(()=>{ titleScreen.style.display='none'; titleScreen.className=''; res(); },450);
      }, hold);
    });
  }

  function hideTopUI(hide){
    // 버튼 군
    docBtn.classList.toggle('hide', hide);
    mapBtn.classList.toggle('hide', hide);
    qs('.controls').classList.toggle('hide', hide);
    captureBtn.classList.toggle('hide', hide);
    // 프레임 박스는 항상 표시(연출 요소)
    qs('.frameBox').classList.toggle('hide', false);
  }

  // CAPTURE
  captureBtn.addEventListener('click', ()=>{
    try{
      const a=document.createElement('a');
      a.download=`sleep_capture_${Date.now()}.png`;
      a.href=view.toDataURL('image/png'); a.click();
    }catch(e){}
  }, {passive:true});

  // DOC
  function openDoc(){ docOverlay.style.display='block'; }
  function closeDoc(){ docOverlay.style.display='none'; showUI(); } // [UI RESTORE]
  docBtn.addEventListener('click', openDoc, {passive:true});
  btnExitDoc.addEventListener('click', closeDoc, {passive:true});
  (function buildDocGrid(){
    docGrid.innerHTML='';
    for(let i=1;i<=8;i++){
      const b=document.createElement('button'); b.className='docBtn'; b.textContent=`Document ${i}`;
      b.onclick=()=>{ docTitle.textContent=`Document ${i}`; docBody.innerHTML='준비중입니다.'; docPane.style.display='block'; };
      docGrid.appendChild(b);
    }
  })();

  // MAP
  function openMap(){ mapOverlay.style.display='block'; }
  function closeMap(){ mapOverlay.style.display='none'; showUI(); } // [UI RESTORE]
  mapBtn.addEventListener('click', openMap, {passive:true});
  btnExitMap.addEventListener('click', closeMap, {passive:true});

  // 초기 상태
  overlay.style.display='flex';
})();
</script>
</body>
</html>
