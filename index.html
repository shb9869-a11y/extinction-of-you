<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEP</title>

<!-- 픽셀 게임 폰트 -->
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEEEP">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --frame: clamp(16px, 4vmin, 40px);
    --accent: #d0d0d0;
    --fs-small: clamp(11px, 1.8vmin, 14px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);

    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }
  html,body{
    width:100%;
    height:100%;
    background:#000;
    overflow:hidden;
    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans KR",sans-serif;
  }
  body{
    color:var(--accent);
  }

  #app{
    position:fixed;
    inset:0;
    background:#000;
  }

  .frameBox{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    right:calc(var(--frame) + var(--safe-r));
    bottom:calc(var(--frame) + var(--safe-b));
    border:2px solid rgba(208,208,208,0.7);
    pointer-events:none;
    z-index:5;
  }

  .screen{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10;
  }
  .screen.show{
    display:flex;
  }

  .uiBtn{
    border:none;
    background:transparent;
    color:var(--accent);
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    font-size:var(--fs-small);
    padding:8px 14px;
    cursor:pointer;
    text-transform:uppercase;
  }

  #nameScreenInner{
    width:min(90vw, 500px);
    padding:20px 18px 22px;
    background:#000;
    border:1px solid #444;
    box-shadow:0 8px 30px rgba(0,0,0,0.9);
    text-align:center;
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  }
  #nameScreenInner h1{
    font-size:clamp(18px, 3.2vmin, 26px);
    margin-bottom:16px;
    letter-spacing:.12em;
  }
  #nameInput{
    width:100%;
    padding:10px 10px;
    border:1px solid #777;
    background:#000;
    color:var(--accent);
    outline:none;
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    font-size:clamp(12px,2.3vmin,18px);
    margin-bottom:16px;
  }
  #nameInput::placeholder{
    color:rgba(208,208,208,0.25);
  }

  /* INTRO */
  #introInner{
    width:min(90vw, 640px);
    padding:18px 18px 18px;
    background:#000;
    border:1px solid #555;
    box-shadow:0 8px 30px rgba(0,0,0,0.9);
    font-family:"Courier New",ui-monospace,monospace;
  }
  #introText{
    min-height:100px;
    font-size:14px;
    line-height:1.7;
    white-space:pre-line;
    margin-bottom:12px;
  }
  #introFooter{
    text-align:right;
  }

  /* TITLE OVERLAY */
  #titleOverlayInner{
    text-align:center;
    padding:24px;
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  }
  .sleepLine{
    display:block;
    margin:8px 0;
    font-size:clamp(32px, 8vmin, 72px);
    letter-spacing:.16em;
    text-transform:uppercase;
  }
  #titleSubtitle{
    margin-top:10px;
    font-size:clamp(18px,3.2vmin,30px);
    letter-spacing:.16em;
    text-transform:uppercase;
  }

  /* SCENE(1~4) + 토끼 */
  #sceneScreen{
    flex-direction:column;
  }
  #rabbitCanvas{
    flex:1;
    width:100%;
    height:100%;
    background:#000;
  }
  #sceneLabel{
    position:fixed;
    left:50%;
    bottom:calc(var(--frame) + var(--safe-b) + 8px);
    transform:translateX(-50%);
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    font-size:var(--fs-small);
    letter-spacing:.12em;
    text-transform:uppercase;
    z-index:12;
  }

  /* SILENCE / THE END */
  #silenceEndInner{
    text-align:center;
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
  }
  #silenceText, #endText{
    font-size:clamp(32px, 10vmin, 80px);
    letter-spacing:.16em;
    text-transform:uppercase;
    margin:8px 0;
  }

  /* SKIP + TIMER */
  #skipBtn{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    z-index:20;
    display:none;
  }
  #timerBox{
    position:fixed;
    right:calc(var(--frame) + var(--safe-r));
    top:calc(var(--frame) + var(--safe-t));
    z-index:20;
    font-family:"Press Start 2P","Courier New",ui-monospace,monospace;
    font-size:var(--fs-strong);
  }
</style>
</head>
<body>
<div id="app">
  <div class="frameBox" aria-hidden="true"></div>

  <!-- 이름 입력 화면 -->
  <div id="nameScreen" class="screen show">
    <div id="nameScreenInner">
      <h1>TELL ME YOUR NAME</h1>
      <input id="nameInput" type="text" maxlength="24" placeholder="" autocomplete="off">
      <button id="nameOkBtn" class="uiBtn" type="button">GO</button>
    </div>
  </div>

  <!-- 인트로 문장 화면 -->
  <div id="introScreen" class="screen">
    <div id="introInner">
      <div id="introText"></div>
      <div id="introFooter">
        <button id="introNextBtn" class="uiBtn" type="button">NEXT</button>
      </div>
    </div>
  </div>

  <!-- SLEEEEEEEEP 타이틀 화면 -->
  <div id="titleOverlay" class="screen">
    <div id="titleOverlayInner">
      <div id="titleSleepLines"></div>
      <div id="titleSubtitle"></div>
    </div>
  </div>

  <!-- 1~4 장면 화면 (토끼 + 타이머) -->
  <div id="sceneScreen" class="screen">
    <canvas id="rabbitCanvas"></canvas>
    <div id="sceneLabel"></div>
  </div>

  <!-- SILENCE / THE END 화면 -->
  <div id="silenceEndScreen" class="screen">
    <div id="silenceEndInner">
      <div id="silenceText"></div>
      <div id="endText"></div>
    </div>
  </div>

  <!-- SKIP 버튼 & 타이머 -->
  <button id="skipBtn" class="uiBtn" type="button">SKIP</button>
  <div id="timerBox">05:00</div>
</div>

<script>
(function(){
  const $ = s => document.querySelector(s);

  const nameScreen   = $('#nameScreen');
  const nameInput    = $('#nameInput');
  const nameOkBtn    = $('#nameOkBtn');

  const introScreen  = $('#introScreen');
  const introTextEl  = $('#introText');
  const introNextBtn = $('#introNextBtn');

  const titleOverlay   = $('#titleOverlay');
  const titleSleepWrap = $('#titleSleepLines');
  const titleSubtitle  = $('#titleSubtitle');

  const sceneScreen  = $('#sceneScreen');
  const rabbitCanvas = $('#rabbitCanvas');
  const sceneLabel   = $('#sceneLabel');

  const silenceEndScreen = $('#silenceEndScreen');
  const silenceText      = $('#silenceText');
  const endText          = $('#endText');

  const skipBtn   = $('#skipBtn');
  const timerBox  = $('#timerBox');

  let displayName = '_____';
  let introIndex  = 0;

  const INTRO_LINES = [
    '멘트를 입력하세요',
    '멘트를 입력하세요',
    '멘트를 입력하세요'
  ];

  /* 장면 구조:
     INTRO -> (TITLE1) -> FIRST
            -> (TITLE2) -> SECOND
            -> (TITLE3) -> THIRD
            -> (TITLE4) -> FOURTH
            -> SILENCE
            -> THE END
  */

  let currentStage = 'NAME';
  let timerId = null;
  let timerRemain = 0;
  let timerCallback = null;

  function showScreen(el){
    [nameScreen,introScreen,titleOverlay,sceneScreen,silenceEndScreen]
      .forEach(s=>s.classList.remove('show'));
    el.classList.add('show');
  }

  function setTimerVisible(on){
    timerBox.style.display = on ? 'block' : 'none';
  }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return m.toString().padStart(2,'0') + ':' + s.toString().padStart(2,'0');
  }

  function startTimer(seconds, onDone){
    if(timerId) clearInterval(timerId);
    timerRemain = seconds;
    timerCallback = onDone;
    setTimerVisible(true);
    timerBox.textContent = formatTime(timerRemain);
    timerId = setInterval(()=>{
      timerRemain = Math.max(0, timerRemain-1);
      timerBox.textContent = formatTime(timerRemain);
      if(timerRemain <= 0){
        clearInterval(timerId);
        timerId = null;
        setTimerVisible(false);
        const cb = timerCallback;
        timerCallback = null;
        cb && cb();
      }
    }, 1000);
  }

  function cancelTimerAndGoNext(){
    if(timerId){
      clearInterval(timerId);
      timerId = null;
    }
    setTimerVisible(false);
    if(timerCallback){
      const cb = timerCallback;
      timerCallback = null;
      cb();
    }
  }

  skipBtn.addEventListener('click', ()=>{
    cancelTimerAndGoNext();
  });

  /* 이름 화면 */
  function goName(){
    currentStage = 'NAME';
    showScreen(nameScreen);
    skipBtn.style.display = 'none';
    setTimerVisible(false);
    setTimeout(()=>nameInput.focus(), 100);
  }

  function acceptName(){
    const v = (nameInput.value || '').trim();
    if(v) displayName = v;
    goIntro();
  }

  nameOkBtn.addEventListener('click', acceptName);
  nameInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter') acceptName();
  });

  /* 인트로 화면 */
  function goIntro(){
    currentStage = 'INTRO';
    introIndex = 0;
    showScreen(introScreen);
    skipBtn.style.display = 'none';
    setTimerVisible(false);
    typeIntroLine(introIndex);
  }

  function getIntroText(i){
    return (INTRO_LINES[i] || '').replace(/_____/g, displayName);
  }

  async function typeTextInto(el, text, speed=25){
    el.textContent = '';
    for(let i=0;i<text.length;i++){
      el.textContent += text[i];
      await new Promise(r=>setTimeout(r, speed));
    }
  }

  function typeIntroLine(i){
    const txt = getIntroText(i);
    typeTextInto(introTextEl, txt, 25);
  }

  introNextBtn.addEventListener('click', ()=>{
    introIndex++;
    if(introIndex >= INTRO_LINES.length){
      // INTRO 끝 -> 1번째 타이틀
      showTitleSleep(1, 'THE FIRST SLEEP', ()=>startScene('FIRST'));
    }else{
      typeIntroLine(introIndex);
    }
  });

  /* SLEEEEEEEEP 타이틀 공통 */
  async function showTitleSleep(count, subtitle, done){
    currentStage = 'TITLE';
    showScreen(titleOverlay);
    skipBtn.style.display = 'none';
    setTimerVisible(false);
    titleSleepWrap.innerHTML = '';
    titleSubtitle.textContent = '';

    const word = 'SLEEEEEEEEP,';

    // SLEEEEEEEEP 줄 수만큼 만들기
    const lines = [];
    for(let i=0;i<count;i++){
      const div = document.createElement('div');
      div.className = 'sleepLine';
      div.textContent = '';
      titleSleepWrap.appendChild(div);
      lines.push(div);
    }

    // 한 줄씩 타이핑
    for(let li=0; li<lines.length; li++){
      const el = lines[li];
      for(let i=0;i<word.length;i++){
        el.textContent += word[i];
        await new Promise(r=>setTimeout(r, 40));
      }
      await new Promise(r=>setTimeout(r, 200));
    }

    // 서브 타이틀 표시
    await new Promise(r=>setTimeout(r, 500));
    titleSubtitle.textContent = subtitle;
    await new Promise(r=>setTimeout(r, 1800));

    // 다음 장면으로
    done && done();
  }

  /* 장면 전환 로직 */

  function startScene(stage){
    currentStage = stage;
    if(stage === 'FIRST' || stage === 'SECOND' || stage === 'THIRD' || stage === 'FOURTH'){
      showScreen(sceneScreen);
      sceneLabel.textContent = stage === 'FIRST'  ? 'THE FIRST SLEEP'
                            : stage === 'SECOND' ? 'THE SECOND SLEEP'
                            : stage === 'THIRD'  ? 'THE THIRD SLEEP'
                            : 'THE FOURTH SLEEP';
      skipBtn.style.display = 'block';
      setTimerVisible(true);
      startTimer(5*60, ()=>goNextFrom(stage));   // 5분 타이머
    }else if(stage === 'SILENCE'){
      showScreen(silenceEndScreen);
      silenceText.textContent = 'SILENCE';
      endText.textContent = '';
      skipBtn.style.display = 'block';
      setTimerVisible(true);
      startTimer(5*60, ()=>goNextFrom('SILENCE')); // 5분 후 THE END
    }else if(stage === 'END'){
      showScreen(silenceEndScreen);
      silenceText.textContent = '';
      endText.textContent = 'THE END';
      skipBtn.style.display = 'none';
      setTimerVisible(false);
    }
  }

  function goNextFrom(stage){
    if(stage === 'FIRST'){
      showTitleSleep(2, 'THE SECOND SLEEP', ()=>startScene('SECOND'));
    }else if(stage === 'SECOND'){
      showTitleSleep(3, 'THE THIRD SLEEP', ()=>startScene('THIRD'));
    }else if(stage === 'THIRD'){
      showTitleSleep(4, 'THE FOURTH SLEEP', ()=>startScene('FOURTH'));
    }else if(stage === 'FOURTH'){
      // 네 번째 수면 끝 -> SILENCE
      startScene('SILENCE');
    }else if(stage === 'SILENCE'){
      // SILENCE 끝 -> THE END
      startScene('END');
    }
  }

  /* 토끼 애니메이션 */

  const sprite = [
    "....XX......",
    "...XXXX.....",
    "..XXXXXX....",
    "..XX..XX....",
    "..XXXXXX....",
    ".XXXXXXXX...",
    ".XX.XX.XX...",
    ".XXXXXXXX...",
    ".XXXXXXXX...",
    ".XXXXXXXX...",
    "..XXXXXX....",
    "...XXXX.....",
    "...XXXX.....",
    "...XXXX.....",
    "..XX..XX....",
    ".XX....XX..."
  ];

  let rcctx = null;
  let rabbitX = 0;
  let rabbitDir = 1;
  let lastTime = null;

  function resizeRabbitCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const rect = rabbitCanvas.getBoundingClientRect();
    rabbitCanvas.width  = rect.width * dpr;
    rabbitCanvas.height = rect.height * dpr;
    rcctx = rabbitCanvas.getContext('2d');
    rcctx.setTransform(dpr,0,0,dpr,0,0);
  }

  window.addEventListener('resize', resizeRabbitCanvas);

  function drawRabbit(){
    if(!rcctx) return;
    const W = rabbitCanvas.clientWidth;
    const H = rabbitCanvas.clientHeight;
    rcctx.clearRect(0,0,W,H);

    // 바닥 라인
    const groundY = H*0.65;
    rcctx.strokeStyle = 'rgba(80,80,80,0.7)';
    rcctx.lineWidth = 2;
    rcctx.beginPath();
    rcctx.moveTo(W*0.1, groundY);
    rcctx.lineTo(W*0.9, groundY);
    rcctx.stroke();

    // 토끼 크기 & 위치
    const cols = sprite[0].length;
    const rows = sprite.length;
    const cell = Math.max(2, Math.floor(Math.min(W,H)*0.015));
    const width  = cols * cell;
    const height = rows * cell;

    const x = rabbitX;
    const y = groundY - 4;

    rcctx.save();
    rcctx.translate(x, y);
    if(rabbitDir < 0){
      rcctx.scale(-1,1);
    }
    rcctx.translate(-width/2, -height);

    // 테두리
    rcctx.fillStyle = '#000000';
    for(let j=0;j<rows;j++){
      for(let i=0;i<cols;i++){
        if(sprite[j][i] === 'X'){
          const px = i*cell;
          const py = j*cell;
          rcctx.fillRect(px-1,py,cell,cell);
          rcctx.fillRect(px+1,py,cell,cell);
          rcctx.fillRect(px,py-1,cell,cell);
          rcctx.fillRect(px,py+1,cell,cell);
        }
      }
    }

    // 몸
    rcctx.fillStyle = '#d0d0d0';
    for(let j=0;j<rows;j++){
      for(let i=0;i<cols;i++){
        if(sprite[j][i] === 'X'){
          const px = i*cell;
          const py = j*cell;
          rcctx.fillRect(px,py,cell,cell);
        }
      }
    }

    rcctx.restore();
  }

  function loop(time){
    if(!lastTime) lastTime = time;
    const dt = (time - lastTime) / 1000;
    lastTime = time;

    if(currentStage === 'FIRST' || currentStage === 'SECOND' ||
       currentStage === 'THIRD' || currentStage === 'FOURTH'){
      const W = rabbitCanvas.clientWidth;
      const left  = W*0.2;
      const right = W*0.8;
      const speed = W * 0.15; // px/s
      rabbitX += rabbitDir * speed * dt;
      if(rabbitX < left){
        rabbitX = left;
        rabbitDir = 1;
      }else if(rabbitX > right){
        rabbitX = right;
        rabbitDir = -1;
      }
      drawRabbit();
    }else{
      // 장면이 아니면 화면만 비워둔다
      if(rcctx){
        rcctx.clearRect(0,0,rabbitCanvas.clientWidth,rabbitCanvas.clientHeight);
      }
    }

    requestAnimationFrame(loop);
  }

  // 초기화
  goName();
  resizeRabbitCanvas();
  const startRect = rabbitCanvas.getBoundingClientRect();
  rabbitX = startRect.width * 0.5;
  lastTime = null;
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>