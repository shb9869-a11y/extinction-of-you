<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Camera (B/W + Trails) + Cloudflare Stream Overlay</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    /* 카메라를 그리는 캔버스 (흑백 + 잔상) */
    #camCanvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
      background: #000;
    }
    /* 클라우드플레어 라이브 스트림을 위 레이어로 겹치기 */
    #cfStream {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      pointer-events: none;          /* 화면 클릭 방해 X */
      mix-blend-mode: screen;        /* 겹침 느낌 (필요에 따라 multiply/overlay 등으로 변경 가능) */
      opacity: 0.70;                 /* 투명도: 0~1 */
    }
    /* iOS에서 주소창으로 인한 레이아웃 흔들림 방지 */
    @supports (height: 100svh) {
      #camCanvas, #cfStream { height: 100svh; }
    }
  </style>
</head>
<body>
  <!-- 카메라 처리용 캔버스 -->
  <canvas id="camCanvas"></canvas>

  <!-- Cloudflare Stream (HLS/LL-HLS) 오버레이 -->
  <video id="cfStream" autoplay playsinline muted></video>

  <!-- HLS.js (사파리 외 브라우저용) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
  // ====== 설정값 ======
  // Cloudflare Stream HLS Manifest URL (사용자가 준 주소)
  const HLS_URL = "https://customer-e1rhmg8edq32stcl.cloudflarestream.com/0561f69cdb850354620ce2f93cbb05ce/manifest/video.m3u8?protocol=llhlsbeta";

  // 카메라 설정: 후면 카메라 우선 (기기에 따라 자동 대체)
  const CAM_CONSTRAINTS = { video: { facingMode: { ideal: "environment" } }, audio: false };

  // 잔상/딜레이 느낌(트레일) 세기
  // fade: 이전 프레임이 사라지는 속도(0.0 = 잔상 오래 남음, 1.0 = 바로 사라짐)
  // drawAlpha: 새 프레임을 덧그릴 때의 투명도(0.1~0.5 정도 추천)
  const TRAIL = {
    fade: 0.10,        // 화면 어둡게 덮어 지우는 정도 (0.05~0.2)
    drawAlpha: 0.25    // 현재 프레임 그릴 때 투명도 (0.15~0.35)
  };

  // 흑백 필터(표준 CSS 캔버스 필터 사용)
  const CAM_FILTER = "grayscale(100%) contrast(110%)";

  // ====== 카메라 시작 ======
  const canvas = document.getElementById('camCanvas');
  const ctx = canvas.getContext('2d', { alpha: false }); // 배경검정 + 성능
  const camVideo = document.createElement('video');
  camVideo.playsInline = true;
  camVideo.muted = true;
  camVideo.autoplay = true;

  // 리사이즈 핸들러
  function fitCanvasToScreen() {
    const w = window.innerWidth || document.documentElement.clientWidth;
    const h = window.innerHeight || document.documentElement.clientHeight;
    canvas.width = w;
    canvas.height = h;
  }
  window.addEventListener('resize', fitCanvasToScreen, { passive: true });
  fitCanvasToScreen();

  // 메인 루프(흑백 + 잔상)
  function drawLoop() {
    const W = canvas.width, H = canvas.height;
    // 이전 프레임을 서서히 지우기(잔상 효과)
    if (TRAIL.fade > 0) {
      ctx.globalCompositeOperation = "source-over";
      ctx.globalAlpha = TRAIL.fade;
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, W, H);
    }

    // 현재 카메라 프레임 그리기 (흑백 + 약한 투명도)
    if (camVideo.readyState >= 2) {
      ctx.filter = CAM_FILTER;
      ctx.globalAlpha = TRAIL.drawAlpha;
      // 화면 꽉 채우기
      const vw = camVideo.videoWidth, vh = camVideo.videoHeight;
      if (vw && vh) {
        // object-fit: cover 효과로 채우기
        const canvasRatio = W / H;
        const videoRatio = vw / vh;
        let dw = W, dh = H, dx = 0, dy = 0;
        if (videoRatio > canvasRatio) {
          // 비디오가 더 넓음 -> 높이에 맞추고 좌우 크롭
          dh = H;
          dw = H * videoRatio;
          dx = (W - dw) / 2;
        } else {
          // 비디오가 더 높음 -> 너비에 맞추고 상하 크롭
          dw = W;
          dh = W / videoRatio;
          dy = (H - dh) / 2;
        }
        ctx.drawImage(camVideo, dx, dy, dw, dh);
      }
    }

    // 다음 프레임
    requestAnimationFrame(drawLoop);
  }

  // 카메라 시작
  navigator.mediaDevices.getUserMedia(CAM_CONSTRAINTS)
    .then(stream => {
      camVideo.srcObject = stream;
      camVideo.onloadedmetadata = () => {
        camVideo.play().catch(()=>{});
        drawLoop();
      };
    })
    .catch(err => {
      console.error("카메라 접근 실패:", err);
      // 실패 시에도 루프는 돌려서 화면이 검게만 보이게 유지
      drawLoop();
    });

  // ====== Cloudflare Stream 오버레이 붙이기 ======
  const streamEl = document.getElementById('cfStream');
  // iOS 사파리 등 HLS 네이티브 지원 브라우저
  if (streamEl.canPlayType('application/vnd.apple.mpegURL')) {
    streamEl.src = HLS_URL;
  } else if (window.Hls && window.Hls.isSupported()) {
    const hls = new Hls({ lowLatencyMode: true });
    hls.loadSource(HLS_URL);
    hls.attachMedia(streamEl);
  } else {
    // 폴백: 직접 붙여보기 (일부 브라우저는 미지원)
    streamEl.src = HLS_URL;
  }
  // 자동재생을 위해 muted 유지. 라이브를 소리까지 듣고 싶으면 아래 주석 해제 후 사용자 제스처로 play 필요
  // streamEl.muted = false;
  // document.body.addEventListener('click', ()=> streamEl.play().catch(()=>{}), { once:true });

  </script>
</body>
</html>
