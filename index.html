<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Your Apocalypse – Cam + Audio + Haptic</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #view{width:100%;height:100%;display:block;position:fixed;left:0;top:0;z-index:0}
  #overlay{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
           background:rgba(0,0,0,.85);font-family:"Courier New",monospace;color:#fff}
  .uiBtn{background:#000;color:#fff;border:1px solid #fff;
         font-size:18px;padding:10px 20px;font-family:"Courier New",monospace;}
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div id="overlay"><button id="startBtn" class="uiBtn">PRESS HERE TO SLEEP</button></div>
  <div id="goodnight" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      font-family:'Courier New',monospace;font-size:20px;color:#fff;background:#000;padding:10px 20px;">
    GOOD NIGHT
  </div>

<script>
(async ()=>{
  /* ========= 카메라 ========= */
  const view=document.getElementById('view');
  const vctx=view.getContext('2d',{alpha:false});
  const cam=document.createElement('video'); cam.autoplay=true; cam.playsInline=true; cam.muted=true;
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    cam.srcObject=s; await cam.play();
  }catch(e){ console.warn("카메라 실패", e); }
  function drawLoop(){
    requestAnimationFrame(drawLoop);
    if(cam.readyState>=2){
      vctx.drawImage(cam,0,0,view.width,view.height);
    }
  }
  function resize(){view.width=innerWidth; view.height=innerHeight;}
  resize(); addEventListener('resize',resize);
  drawLoop();

  /* ========= 오디오 + 햅틱 ========= */
  let audioCtx, masterGain, analyser;

  async function initAudio(){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain(); masterGain.gain.value=1.0;
    masterGain.connect(audioCtx.destination);

    // 마이크 입력
    const micStream=await navigator.mediaDevices.getUserMedia({audio:true, video:false});
    const micSrc=audioCtx.createMediaStreamSource(micStream);

    analyser=audioCtx.createAnalyser();
    analyser.fftSize=512;

    micSrc.connect(analyser);
    analyser.connect(masterGain);

    // 햅틱 루프 시작
    startHaptics(analyser);
  }

  function startHaptics(analyser){
    if(!navigator.vibrate) {
      console.log("이 기기는 Vibrate API를 지원하지 않음");
      return;
    }
    const buf=new Uint8Array(analyser.fftSize);
    let vibrating=false;

    function loop(){
      requestAnimationFrame(loop);
      analyser.getByteTimeDomainData(buf);
      let sum=0;
      for(let i=0;i<buf.length;i++){
        const v=(buf[i]-128)/128;
        sum+=v*v;
      }
      const rms=Math.sqrt(sum/buf.length);

      if(rms>0.05){ 
        // 소리가 클 때 → 계속 진동 유지
        if(!vibrating){
          navigator.vibrate([100,50]); // 100ms 진동, 50ms 간격 반복
          vibrating=true;
        }
      } else {
        // 소리가 작아지면 진동 끔
        if(vibrating){
          navigator.vibrate(0);
          vibrating=false;
        }
      }
    }
    loop();
  }

  /* ========= UI ========= */
  const overlay=document.getElementById('overlay');
  const startBtn=document.getElementById('startBtn');
  const goodnight=document.getElementById('goodnight');

  startBtn.addEventListener('click', async ()=>{
    await initAudio();
    overlay.style.display='none';
    // 10초 후 굿나잇 표시 예시
    setTimeout(()=>{
      goodnight.style.display='block';
    },10000);
  });
})();
</script>
</body>
</html>
