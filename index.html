<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera â€“ BW + Afterimage (Separated)</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #view{width:100%;height:100%;display:block}
  #hint{
    position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
    background:rgba(0,0,0,.7);color:#fff;padding:10px 16px;border-radius:10px;
    font:14px/1.4 system-ui,-apple-system,sans-serif;z-index:40;
    max-width:90%;text-align:center;
  }
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div id="hint">ğŸ“± iOS ì‚¬íŒŒë¦¬ì—ì„œ <b>ê³µìœ  ë²„íŠ¼ â†’ í™ˆ í™”ë©´ì— ì¶”ê°€</b>ë¡œ ì‹¤í–‰í•˜ë©´ ì£¼ì†Œì°½ ì—†ëŠ” ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ì“¸ ìˆ˜ ìˆì–´ìš”.</div>

<script>
(async ()=>{
  const view=document.getElementById('view');
  const vctx=view.getContext('2d',{alpha:false});
  const hint=document.getElementById('hint');

  // âœ… ì•±ëª¨ë“œ ê°ì§€ â†’ ì•ˆë‚´ ìˆ¨ê¹€
  const isStandalone = window.navigator.standalone === true 
                    || window.matchMedia('(display-mode: standalone)').matches;
  if(isStandalone){ hint.style.display="none"; }

  const PROC_SCALE=0.5;
  const TRAIL_ALPHA=0.08;   // trail ê°•ë„ (0.02~0.1 ì‚¬ì´ì—ì„œ ì¡°ì ˆ)
  const FRAME_MARGIN=40, FRAME_COLOR="#fff", FRAME_WIDTH=0.5;

  const camVideo=document.createElement('video');
  camVideo.autoplay=true; camVideo.playsInline=true; camVideo.muted=true;

  // í‘ë°± ë²„í¼
  const gray=document.createElement('canvas');
  const gctx=gray.getContext('2d',{willReadFrequently:true});

  // trail ë²„í¼
  const trail=document.createElement('canvas');
  const tctx=trail.getContext('2d');

  function resizeAll(){
    const dpr=window.devicePixelRatio||1;
    const w=window.innerWidth,h=window.innerHeight;
    view.width=w*dpr; view.height=h*dpr;
    vctx.setTransform(dpr,0,0,dpr,0,0);
    gray.width=Math.floor(w*PROC_SCALE);
    gray.height=Math.floor(h*PROC_SCALE);
    trail.width=gray.width;
    trail.height=gray.height;
  }
  resizeAll();
  addEventListener('resize',()=>setTimeout(resizeAll,50));

  async function attachCamera(){
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    camVideo.srcObject=s; await camVideo.play();
  }

  function loop(){
    requestAnimationFrame(loop);
    const W=view.width/(window.devicePixelRatio||1);
    const H=view.height/(window.devicePixelRatio||1);

    const GW=gray.width, GH=gray.height;

    // 1. ì¹´ë©”ë¼ â†’ gray (í‘ë°± ë³€í™˜)
    if(camVideo.readyState>=2){
      gctx.drawImage(camVideo,0,0,GW,GH);
      const frame=gctx.getImageData(0,0,GW,GH);
      const d=frame.data;
      for(let i=0;i<d.length;i+=4){
        const grayVal=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;
        d[i]=d[i+1]=d[i+2]=grayVal;
      }
      gctx.putImageData(frame,0,0);
    }

    // 2. trail ëˆ„ì 
    tctx.globalCompositeOperation="source-over";
    tctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`; // ì”ìƒ ì§€ìš°ê¸°
    tctx.fillRect(0,0,trail.width,trail.height);

    tctx.globalCompositeOperation="lighter"; // ì´ì „ í”„ë ˆì„ê³¼ ê²¹ì¹˜ë©° ê¼¬ë¦¬ ë‚¨ê¹€
    tctx.drawImage(gray,0,0);

    tctx.globalCompositeOperation="source-over";

    // 3. trail â†’ main ì—…ìŠ¤ì¼€ì¼
    vctx.drawImage(trail,0,0,W,H);

    // 4. í”„ë ˆì„
    vctx.strokeStyle=FRAME_COLOR; vctx.lineWidth=FRAME_WIDTH;
    vctx.strokeRect(FRAME_MARGIN,FRAME_MARGIN,W-2*FRAME_MARGIN,H-2*FRAME_MARGIN);
  }

  await attachCamera();
  loop();
})();
</script>
</body>
</html>
