<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>SLEEEEEEEEEEEEEEEP</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SLEEEP">
<meta name="theme-color" content="#000000">

<style>
html,body{
  margin:0;padding:0;
  width:100%;height:100%;
  background:#000;color:#fff;
  font-family: ui-monospace, "Courier New", monospace;
  touch-action: none;
}

/* === 첫 권한 게이트 === */
#overlay{
  position:fixed; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:#000; color:#fff;
  z-index:9999; opacity:1;
  transition:opacity .3s;
}
#overlayContent{
  text-align:center;
  padding:20px;
  line-height:1.6;
  font-size:clamp(14px,3.2vmin,22px);
}
#overlay button{
  margin-top:16px;
  padding:8px 18px;
  border:1px solid #fff;
  background:transparent; color:#fff;
  font-family:inherit;
}

/* 실패 안내 */
#overlayContent .warn{
  opacity:.85; margin-top:10px; color:#ffdf7a;
  font-family:"Courier New", ui-monospace, monospace;
}

/* === 이름 입력 화면 === */
#nameOverlay{
  position:fixed; inset:0;
  display:none; align-items:center; justify-content:center;
  background:#000; color:#fff;
  z-index:9000; opacity:0;
  transition:opacity .4s;
}
#nameBox{
  display:flex; flex-direction:column; align-items:center;
}
#nickInput{
  background:transparent; border:1px solid #fff;
  padding:8px 12px; color:#fff; font-family:inherit;
  margin-top:14px; width:180px; text-align:center;
}
#goBtn{
  margin-top:16px; padding:6px 16px;
  border:1px solid #fff; background:transparent; color:#fff;
}

/* 이후 게임 화면 등은 아래 네가 붙이면 됨 */
</style>
</head>

<body>

<!-- 첫 화면 게이트 -->
<div id="overlay">
  <div id="overlayContent">
    화면을 탭하여 시작하세요<br>
    (카메라/마이크/모션 권한이 필요합니다)
    <br><br>
    <button id="permBtn">시작 / 권한 요청</button>
  </div>
</div>

<!-- 이름 입력 -->
<div id="nameOverlay">
  <div id="nameBox">
    <div>당신의 이름은?</div>
    <input id="nickInput" autocomplete="off" maxlength="20"/>
    <button id="goBtn">GO</button>
  </div>
</div>

<!-- ===========================
     여기에 네 "실제 화면" / 게임 / UI 붙이기
     예: <canvas id="game"></canvas> 등
     =========================== -->
<div id="gameArea" style="display:none;">
  <!-- --- 여기에 기존 UI/게임 화면 --- -->
</div>

<script>
// ==========================================
//  기존 오디오 엔진, ambient, 카메라 관련 코드가 있다면
//  아래 함수들 안에 그대로 넣으면 됨.
// ==========================================

let audioCtx;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
}

function playWoongClick(){
  // 필요 없다면 삭제해도 됨
}

const Ambient = {
  start(v1=1.0, v2=1.0){
    // ambient 사운드 시작 코드 여기
  }
};

// 화면 페이드 헬퍼
function fadeHide(el, dur=300){
  el.style.transition=`opacity ${dur}ms`;
  el.style.opacity=0;
  setTimeout(()=>{ el.style.display="none"; }, dur);
}
function fadeShow(el, dur=400){
  el.style.display="flex";
  el.style.transition=`opacity ${dur}ms`;
  requestAnimationFrame(()=> el.style.opacity=1 );
}

// 권한
async function requestMotionPerm(){
  try{
    if(typeof DeviceOrientationEvent!=='undefined' &&
       typeof DeviceOrientationEvent.requestPermission === 'function'){
      const s = await DeviceOrientationEvent.requestPermission().catch(()=> 'denied');
      return s === 'granted';
    }
  }catch(_){}
  return true;
}

async function requestUserMediaPair(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'environment'},
      audio:{echoCancellation:true, noiseSuppression:true, autoGainControl:false}
    });
    s.getTracks().forEach(t=>t.stop());
    return true;
  }catch(e){
    return false;
  }
}

function withTimeout(p,ms){
  let to;const t=new Promise(r=>to=setTimeout(()=>r('__timeout__'),ms));
  return Promise.race([p,t]).then(v=>{clearTimeout(to);return v;});
}

// =====================================================
// **핵심: 첫 탭 / 재시도 안전 게이트**
// =====================================================
let bootstrapped=false;
let lastPermFail=false;
const overlayEl=document.getElementById("overlay");
const permBtn=document.getElementById("permBtn");
const nameOverlay=document.getElementById("nameOverlay");
const nickInput=document.getElementById("nickInput");
const goBtn=document.getElementById("goBtn");
const gameArea=document.getElementById("gameArea");

async function immediateGestureStart(e){
  if(e && e.preventDefault) e.preventDefault();
  if(bootstrapped && !lastPermFail) return;

  bootstrapped=true;
  lastPermFail=false;

  ensureAudio();
  try{ if(audioCtx.state==='suspended') await audioCtx.resume(); }catch(_){}
  playWoongClick();

  const motionOK=await requestMotionPerm();
  const mediaOK=await withTimeout(requestUserMediaPair(),3000);

  if(motionOK && mediaOK===true){
    fadeHide(overlayEl,300);
    Ambient.start();
    fadeShow(nameOverlay,400);
    setTimeout(()=>nickInput.focus(),80);
    return;
  }

  // 실패 → 재무장
  lastPermFail=true;
  bootstrapped=false;
  overlayEl.style.display="flex";
  overlayEl.style.opacity="1";
  const oc=document.getElementById("overlayContent");
  if(oc && !oc.querySelector('.warn')){
    const w=document.createElement('div');
    w.className='warn';
    w.textContent="권한 창을 닫으셨거나 지연되었습니다. 화면을 다시 탭하면 재시도합니다.";
    oc.appendChild(w);
  }
}

// 이벤트 바인딩 (절대 passive 금지)
['click','pointerdown','touchstart','touchend','keydown'].forEach(ev=>{
  const h=(e)=>{
    if(ev==='keydown' && !['Enter',' '].includes(e.key))return;
    immediateGestureStart(e);
  };
  overlayEl.addEventListener(ev,h,{passive:false});
  permBtn.addEventListener(ev,h,{passive:false});
});

['pointerdown','touchstart','touchend','click','keydown'].forEach(type=>{
  const h=(e)=>{
    if(type==='keydown' && !['Enter',' '].includes(e.key))return;
    if(overlayEl.style.display!=='none') immediateGestureStart(e);
  };
  document.addEventListener(type,h,{capture:true,passive:false});
  document.body.addEventListener(type,h,{capture:true,passive:false});
  window.addEventListener(type,h,{capture:true,passive:false});
});

window.addEventListener('pageshow',e=>{ if(e.persisted){ bootstrapped=false; }});
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ bootstrapped=false; }});

// 이름 입력 후 → 게임 화면으로
goBtn.addEventListener('click', ()=>{
  fadeHide(nameOverlay,300);
  gameArea.style.display="block";
  // --- 여기에 이름 전달 / 게임 시작 함수 실행 ---
});
</script>
</body>
</html>
