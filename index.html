<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resolume + Camera Overlay</title>
  <style>
    html,body { margin:0; height:100%; background:#000; color:#fff; font-family:sans-serif; }
    .layer { position:fixed; inset:0; width:100%; height:100%; object-fit:cover; }
    #cam { filter:grayscale(100%); z-index:1; }
    #fx { z-index:2; pointer-events:none; }
    #overlay { z-index:3; pointer-events:none; opacity:0.7; mix-blend-mode:screen; }
    .ui { position:fixed; bottom:0; left:0; right:0; z-index:10;
      background:rgba(0,0,0,0.6); padding:0.5rem; display:flex; gap:0.5rem; justify-content:center; }
    button,input[type="range"] { background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:0.4rem 0.7rem; }
  </style>
</head>
<body>
  <video id="cam" class="layer" autoplay playsinline muted></video>
  <canvas id="fx" class="layer"></canvas>
  <video id="overlay" class="layer" autoplay playsinline muted></video>

  <div class="ui">
    <button id="btnStart">카메라 시작</button>
    <button id="btnFlip">전/후면 전환</button>
    <button id="btnShot">캡처</button>
    <label>잔상 <input id="delayAmt" type="range" min="0" max="0.98" step="0.01" value="0.82"></label>
    <label>오버레이 투명 <input id="ovAlpha" type="range" min="0" max="1" step="0.01" value="0.7"></label>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // ✅ 네 Cloudflare HLS Manifest URL
    const STREAM_M3U8_URL = "https://customer-e1rhmg8edq32stcl.cloudflarestream.com/0561f69cdb850354620ce2f93cbb05ce/manifest/video.m3u8?protocol=llhlsbeta";

    let facingMode = 'environment';
    const camEl = document.getElementById('cam');
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d',{ willReadFrequently:true });
    const overlay = document.getElementById('overlay');
    let feedback = 0.82;

    function resizeCanvas(){ fx.width=innerWidth; fx.height=innerHeight; }
    addEventListener('resize', resizeCanvas);

    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode, width:{ideal:1920}, height:{ideal:1080} },
        audio:false
      });
      camEl.srcObject = stream;
      await camEl.play();
      resizeCanvas();
      animateFX();
      startOverlay();
    }

    function animateFX(){
      if(!camEl.videoWidth){ requestAnimationFrame(animateFX); return; }
      const vw=camEl.videoWidth, vh=camEl.videoHeight, cw=fx.width, ch=fx.height;
      const s=Math.max(cw/vw,ch/vh), dw=vw*s, dh=vh*s, dx=(cw-dw)/2, dy=(ch-dh)/2;

      ctx.fillStyle=`rgba(0,0,0,${1-(1-feedback)})`;
      ctx.fillRect(0,0,cw,ch);
      ctx.globalAlpha=(1-feedback);
      ctx.drawImage(camEl,dx,dy,dw,dh);
      ctx.globalAlpha=1;
      requestAnimationFrame(animateFX);
    }

    async function captureShot(){
      const blob = await new Promise(res=>fx.toBlob(res,'image/jpeg',0.92));
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`capture_${Date.now()}.jpg`;
      a.click(); URL.revokeObjectURL(url);
    }

    function startOverlay(){
      if(!STREAM_M3U8_URL) return;
      if(overlay.canPlayType('application/vnd.apple.mpegurl')){
        overlay.src=STREAM_M3U8_URL; overlay.play();
      }else if(Hls.isSupported()){
        const hls=new Hls({ lowLatencyMode:true });
        hls.loadSource(STREAM_M3U8_URL);
        hls.attachMedia(overlay);
      }else{
        overlay.src=STREAM_M3U8_URL; overlay.play();
      }
    }

    document.getElementById('btnStart').onclick = startCamera;
    document.getElementById('btnFlip').onclick = ()=>{ facingMode=(facingMode==='user')?'environment':'user'; startCamera(); };
    document.getElementById('btnShot').onclick = captureShot;
    document.getElementById('delayAmt').oninput = e=>{ feedback=parseFloat(e.target.value); };
    document.getElementById('ovAlpha').oninput = e=>{ overlay.style.opacity=e.target.value; };
  </script>
</body>
</html>
