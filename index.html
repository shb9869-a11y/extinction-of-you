<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera â€“ Fullscreen Stable</title>

<!-- iOS PWA / í’€ìŠ¤í¬ë¦° -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Camera Trail">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="app.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root { color-scheme: dark; }
  html,body{ margin:0; height:100%; background:#000; overflow:hidden; }
  /* íŒ¨ë”©/ë§ˆì§„ ì—†ì´ í™”ë©´ = ìº”ë²„ìŠ¤ 1:1 ëŒ€ì‘ */
  #app{
    position:fixed; inset:0; width:100vw; height:100svh;
    background:#000; touch-action:none; overscroll-behavior:none;
  }
  #view{ width:100%; height:100%; display:block; }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:12px 18px; border:0; border-radius:999px; z-index:20;
    font:700 16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff; background:#12a150; display:none;
  }
  #a2hs{
    position:fixed; inset:auto 12px 12px 12px; z-index:30;
    padding:12px; border-radius:12px; background:rgba(0,0,0,.7); color:#fff;
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:none;
  }
  #a2hs b{ font-weight:800; }
</style>
</head>
<body>
  <div id="app">
    <canvas id="view"></canvas>
    <button id="start">ì¹´ë©”ë¼ ì‹œì‘</button>
    <div id="a2hs">
      <b>ì£¼ì†Œì°½ ì™„ì „ ì œê±°</b>í•˜ë ¤ë©´ iOS ì‚¬íŒŒë¦¬ â†’ <b>ê³µìœ </b> â†’ <b>í™ˆ í™”ë©´ì— ì¶”ê°€</b> í›„ ì‹¤í–‰í•˜ì„¸ìš”.
    </div>
  </div>

<script>
(async ()=>{
  const isStandalone = matchMedia('(display-mode: standalone)').matches
                    || navigator.standalone === true;
  const a2hs = document.getElementById('a2hs');
  if (!isStandalone) a2hs.style.display = 'block';

  if ('serviceWorker' in navigator) {
    try { await navigator.serviceWorker.register('./service-worker.js'); } catch(e){}
  }

  const app  = document.getElementById('app');
  const view = document.getElementById('view');
  const vctx = view.getContext('2d', { alpha:false });
  const startBtn = document.getElementById('start');

  // ====== ì„¤ì • ======
  const PROC_SCALE   = 0.6;       // ë‚´ë¶€ ì²˜ë¦¬ í•´ìƒë„(0.4~0.8)
  const TRAIL_ALPHA  = 0.004;     // ì”ìƒ ê°•ë„(ë‚®ì„ìˆ˜ë¡ ì˜¤ë˜ ë‚¨ìŒ)
  const FRAME_MARGIN = 40;        // í”„ë ˆì„ ì—¬ë°±(px)
  const FRAME_COLOR  = "#ffffff"; // í°ìƒ‰
  const FRAME_WIDTH  = 0.5;       // ì–‡ì€ ì„ (px)

  // ====== ë¹„ë””ì˜¤/ì²˜ë¦¬ ìº”ë²„ìŠ¤ ======
  const camVideo = document.createElement('video');
  camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;

  const proc = document.createElement('canvas');
  const pctx = proc.getContext('2d', { alpha:false });

  // âœ… iOS PWAì—ì„œ ê°€ì¥ ì•ˆì •ì ì¸ ì‚¬ì´ì¦ˆ: window.innerWidth/innerHeight
  function resizeAll(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.max(1, Math.floor(window.innerWidth));
    const h = Math.max(1, Math.floor(window.innerHeight));

    // ë©”ì¸ ìº”ë²„ìŠ¤
    view.style.width = w+'px';
    view.style.height = h+'px';
    view.width  = Math.floor(w * dpr);
    view.height = Math.floor(h * dpr);
    vctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    // ì²˜ë¦¬ ìº”ë²„ìŠ¤
    proc.width  = Math.max(1, Math.floor(w * PROC_SCALE));
    proc.height = Math.max(1, Math.floor(h * PROC_SCALE));
  }

  // íšŒì „/ì£¼ì†Œì°½ ì• ë‹ˆë©”ì´ì…˜/í‚¤ë³´ë“œ ë“± ë‹¤ì–‘í•œ ì¼€ì´ìŠ¤ì—ì„œ ì¬ê³„ì‚°
  const reqResize = (delay=50)=>setTimeout(resizeAll, delay);
  addEventListener('resize', ()=>reqResize(50));
  addEventListener('orientationchange', ()=>reqResize(120));
  if (window.visualViewport){
    visualViewport.addEventListener('resize', ()=>reqResize(50));
  }
  resizeAll();

  async function attachCamera(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' }, width:{ideal:1920}, height:{ideal:1080} },
        audio:false
      });
      camVideo.srcObject = s; await camVideo.play();
    }catch(e){
      const s2 = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      camVideo.srcObject = s2; await camVideo.play();
    }
  }

  async function goFullscreen(){
    try{
      if (!document.fullscreenElement && app.requestFullscreen) await app.requestFullscreen();
      setTimeout(()=>scrollTo(0,1), 50); // êµ¬í˜• iOS ìµœì†Œí™” íŠ¸ë¦­
    }catch(e){}
  }

  let raf = 0;
  function loop(){
    raf = requestAnimationFrame(loop);

    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const W = view.width / dpr;
    const H = view.height / dpr;
    const PW = proc.width, PH = proc.height;

    // ğŸ” ì”ìƒ: í˜ì´ë“œë§Œ ì‚¬ìš©(ì™œê³¡ ì—†ìŒ)
    pctx.globalCompositeOperation = 'source-over';
    pctx.fillStyle = `rgba(0,0,0,${TRAIL_ALPHA})`;
    pctx.fillRect(0,0,PW,PH);

    // ğŸ¥ ì¹´ë©”ë¼ â†’ ì²˜ë¦¬ ìº”ë²„ìŠ¤ (ê·¸ë ˆì´ìŠ¤ì¼€ì¼ í•„í„°)
    if (camVideo.readyState >= 2){
      const vw = camVideo.videoWidth || 0, vh = camVideo.videoHeight || 0;
      if (vw && vh){
        const scale = Math.max(PW / vw, PH / vh); // cover
        const dw = vw * scale, dh = vh * scale;
        const dx = (PW - dw) / 2, dy = (PH - dh) / 2;

        // í¼í”½ì…€ ì—°ì‚° ì œê±°: ìº”ë²„ìŠ¤ í•„í„° ì‚¬ìš©
        pctx.filter = 'grayscale(100%)';
        pctx.drawImage(camVideo, dx, dy, dw, dh);
        pctx.filter = 'none';
      }
    }

    // ë©”ì¸ ìº”ë²„ìŠ¤ ì—…ìŠ¤ì¼€ì¼
    vctx.clearRect(0,0,W,H);
    vctx.drawImage(proc, 0, 0, W, H);

    // â—»ï¸ í”„ë ˆì„ (ì„¸ë¡œ/ê°€ë¡œ ë™ì¼ ì¢Œí‘œ ê¸°ì¤€)
    vctx.save();
    vctx.strokeStyle = FRAME_COLOR;
    vctx.lineWidth = FRAME_WIDTH;
    vctx.setLineDash([]);
    vctx.strokeRect(FRAME_MARGIN, FRAME_MARGIN, W-2*FRAME_MARGIN, H-2*FRAME_MARGIN);
    vctx.restore();
  }

  async function startAll(){
    try{
      await attachCamera();
      await goFullscreen();
      startBtn.style.display = 'none';
      if (!raf) loop();
    }catch(e){
      startBtn.style.display = 'inline-block';
    }
  }

  // ìë™ ì‹œë„ + ì œìŠ¤ì²˜ í›…
  startAll();
  const trig = async ()=>{ await startAll(); removeEventListener('pointerdown', trig, {once:true}); };
  addEventListener('pointerdown', trig, { once:true, passive:true });

  // ë³µê·€ ì‹œ ì¬ìƒ/ë¦¬ì‚¬ì´ì¦ˆ
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden){ camVideo.play().catch(()=>{}); reqResize(120); }
  });

  startBtn.addEventListener('click', startAll, { once:true });
})();
</script>
</body>
</html>
