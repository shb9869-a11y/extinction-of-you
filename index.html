<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera ‚Äì BW + Max Trail + Zoom</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Camera Trail">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="app.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root { color-scheme: dark; }
  html,body{ margin:0; height:100%; background:#000; overflow:hidden; }
  #app{ position:fixed; inset:0; width:100vw; height:100svh; background:#000; touch-action:none; overscroll-behavior:none; }
  #view{ width:100%; height:100%; display:block; }

  .controls{
    position:fixed; right:12px; bottom:12px; z-index:30;
    display:flex; gap:8px; align-items:center;
    background:rgba(0,0,0,.45); padding:8px; border-radius:12px;
    font:14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:#fff;
  }
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.25); color:#fff;
    background:rgba(255,255,255,.08); padding:8px 12px; border-radius:10px;
    font:700 14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  }
  .btn:active{ transform:translateY(1px); }
  .readout{ min-width:64px; text-align:center; opacity:.9; }
  #start{
    position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
    padding:12px 18px; border:0; border-radius:999px; z-index:40;
    font:700 16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    color:#fff; background:#12a150; display:none;
  }
</style>
</head>
<body>
  <div id="app">
    <canvas id="view"></canvas>
    <div class="controls" id="controls">
      <button class="btn" id="zoomOut">‚Äì</button>
      <div class="readout"><span id="zoomVal">1.2√ó</span></div>
      <button class="btn" id="zoomIn">+</button>
    </div>
    <button id="start">Ïπ¥Î©îÎùº ÏãúÏûë</button>
  </div>

<script>
(async ()=>{
  const app  = document.getElementById('app');
  const view = document.getElementById('view');
  const vctx = view.getContext('2d', { alpha:false });
  const startBtn = document.getElementById('start');

  const btnIn  = document.getElementById('zoomIn');
  const btnOut = document.getElementById('zoomOut');
  const zoomVal = document.getElementById('zoomVal');

  // üéõÔ∏è ÏÑ§Ï†ï
  const PROC_SCALE   = 0.6;        // ÎÇ¥Î∂Ä Ï≤òÎ¶¨ Ìï¥ÏÉÅÎèÑ
  const TRAIL_ALPHA  = 0.0005;     // ‚òÜ ÏµúÎåÄÎ°ú ÏûîÏÉÅ Ïò§Îûò ÎÇ®Ïùå
  const FRAME_MARGIN = 40;         
  const FRAME_COLOR  = "#ffffff";  
  const FRAME_WIDTH  = 0.5;        

  let ZOOM = 1.2;                  // ‚òÜ Í∏∞Î≥∏ ÌôïÎåÄ 1.2√ó
  const ZOOM_MIN = 0.5, ZOOM_MAX = 3.0, ZOOM_STEP = 0.1;

  const camVideo = document.createElement('video');
  camVideo.autoplay = true; camVideo.playsInline = true; camVideo.muted = true;

  const proc = document.createElement('canvas');
  const pctx = proc.getContext('2d', { alpha:false, willReadFrequently:true });

  function resizeAll(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.max(1, Math.floor(window.innerWidth));
    const h = Math.max(1, Math.floor(window.innerHeight));
    view.style.width = w+'px';
    view.style.height = h+'px';
    view.width  = Math.floor(w * dpr);
    view.height = Math.floor(h * dpr);
    vctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    proc.width  = Math.max(1, Math.floor(w * PROC_SCALE));
    proc.height = Math.max(1, Math.floor(h * PROC_SCALE));
  }
  const reqResize = (delay=50)=>setTimeout(resizeAll, delay);
  addEventListener('resize', ()=>reqResize(50), {passive:true});
  addEventListener('orientationchange', ()=>reqResize(120));
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>reqResize(50)); }
  resizeAll();

  async function attachCamera(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      camVideo.srcObject = s; await camVideo.play();
    }catch(e){
      const s2 = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      camVideo.srcObject = s2; await camVideo.play();
    }
  }

  // Ï§å Î≤ÑÌäº
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function updateZoomReadout(){ zoomVal.textContent = (Math.round(ZOOM*10)/10).toFixed(1)+'√ó'; }
  btnIn.addEventListener('click', ()=>{ ZOOM=clamp(ZOOM+ZOOM_STEP,ZOOM_MIN,ZOOM_MAX); updateZoomReadout(); });
  btnOut.addEventListener('click', ()=>{ ZOOM=clamp(ZOOM-ZOOM_STEP,ZOOM_MIN,ZOOM_MAX); updateZoomReadout(); });
  updateZoomReadout();

  let raf=0;
  function loop(){
    raf = requestAnimationFrame(loop);
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const W = view.width / dpr;
    const H = view.height / dpr;
    const PW = proc.width, PH = proc.height;

    // 1) ÏûîÏÉÅ ÌéòÏù¥Îìú
    pctx.fillStyle = `rgba(0,0,0,${TRAIL_ALPHA})`;
    pctx.fillRect(0,0,PW,PH);

    // 2) Ïπ¥Î©îÎùº ÌîÑÎ†àÏûÑ
    if (camVideo.readyState >= 2){
      const vw = camVideo.videoWidth||0, vh = camVideo.videoHeight||0;
      if (vw && vh){
        const baseScale = Math.max(PW/vw, PH/vh);
        const sc = baseScale * ZOOM;
        const dw = vw*sc, dh = vh*sc;
        const dx = (PW-dw)/2, dy = (PH-dh)/2;
        pctx.drawImage(camVideo, dx, dy, dw, dh);

        // 3) ÌùëÎ∞± Î≥ÄÌôò
        const frame = pctx.getImageData(0,0,PW,PH);
        const d = frame.data;
        for (let i=0;i<d.length;i+=4){
          const r=d[i], g=d[i+1], b=d[i+2];
          const gray=(0.299*r+0.587*g+0.114*b)|0;
          d[i]=d[i+1]=d[i+2]=gray;
        }
        pctx.putImageData(frame,0,0);
      }
    }

    // 4) Î©îÏù∏ Ï∫îÎ≤ÑÏä§
    vctx.clearRect(0,0,W,H);
    vctx.drawImage(proc,0,0,W,H);

    // 5) ÌîÑÎ†àÏûÑ
    vctx.save();
    vctx.strokeStyle = FRAME_COLOR;
    vctx.lineWidth = FRAME_WIDTH;
    vctx.strokeRect(FRAME_MARGIN,FRAME_MARGIN,W-2*FRAME_MARGIN,H-2*FRAME_MARGIN);
    vctx.restore();
  }

  async function startAll(){
    try{ await attachCamera(); startBtn.style.display='none'; if(!raf) loop(); }
    catch(e){ startBtn.style.display='inline-block'; }
  }

  startBtn.addEventListener('click', startAll, {once:true});
  startAll();

  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden){ camVideo.play().catch(()=>{}); reqResize(120); }
  });
})();
</script>
</body>
</html>
