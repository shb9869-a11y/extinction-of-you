<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Dialogue into Silence</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dialogue into Silence">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --appH: 100svh; /* JS에서 window.innerHeight로 갱신 */
    --frame: clamp(16px, 4vmin, 40px);
    --ui-gap: 8px;

    --fs-body: clamp(12px, 2.2vmin, 16px);
    --fs-strong: clamp(14px, 2.8vmin, 20px);
    --fs-small: clamp(11px, 1.8vmin, 14px);

    --pad-btn-y: clamp(6px, 1.1vmin, 10px);
    --pad-btn-x: clamp(10px, 1.8vmin, 20px);

    --safe-t: env(safe-area-inset-top, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
  }

  html,body{margin:0;height:var(--appH);background:#000;overflow:hidden;touch-action:manipulation}
  #view{position:fixed;left:0;top:0;width:100%;height:var(--appH);display:block;z-index:0}

  .frameBox{
    position:fixed;
    left:calc(var(--frame) + var(--safe-l));
    top:calc(var(--frame) + var(--safe-t));
    right:calc(var(--frame) + var(--safe-r));
    bottom:calc(var(--frame) + var(--safe-b));
    border:1px solid #000;pointer-events:none;z-index:50
  }

  .uiBtn{background:#000;color:#fff;border:1px solid #000;font-size:var(--fs-strong);
    padding:var(--pad-btn-y) var(--pad-btn-x);font-family:"Courier New",monospace;white-space:nowrap;cursor:pointer;user-select:none}
  .uiBtn.small{font-size:var(--fs-small);padding:calc(var(--pad-btn-y)*0.6) calc(var(--pad-btn-x)*0.6)}
  .uiBtn[disabled]{opacity:.35;pointer-events:none;filter:grayscale(1)}

  .controls{
    position:fixed;
    right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:100;display:flex;gap:6px;align-items:center}
  .readout{min-width:48px;text-align:center;opacity:.9;font-family:"Courier New",monospace;font-size:var(--fs-small)}
  .btn-capture{
    position:fixed;
    left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    bottom:calc(var(--frame) + var(--ui-gap) + var(--safe-b));
    z-index:150}

  #mapLauncher{
    position:fixed; right:calc(var(--frame) + var(--ui-gap) + var(--safe-r));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:280;}
  #docLauncher{
    position:fixed; left:calc(var(--frame) + var(--ui-gap) + var(--safe-l));
    top:calc(var(--frame) + var(--ui-gap) + var(--safe-t)); z-index:280;}

  /* 오버레이 */
  #overlay{
    position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
    padding:calc(20px + var(--safe-t)) calc(20px + var(--safe-r)) calc(20px + var(--safe-b)) calc(20px + var(--safe-l));
    font-family:"Courier New",monospace;color:#fff;background:rgba(0,0,0,.72)
  }
  #overlayContent{
    pointer-events:auto;line-height:1.7;font-size:var(--fs-body);
    max-width:min(92vw, 72ch);
    max-height:calc(var(--appH) - (var(--frame)*2) - var(--safe-t) - var(--safe-b));
    overflow:auto; -webkit-overflow-scrolling:touch; text-align:left
  }
  .fade{opacity:1;transition:opacity .45s ease}
  .fade.hidden{opacity:0}

  /* 컷인(침묵) — 배경 투명 유지 */
  #cutin{ position:fixed; inset:0; z-index:260; display:none; align-items:center; justify-content:center; background:transparent; color:#fff; font-family:"Courier New",monospace; text-align:center; padding-bottom:var(--safe-b); padding-top:var(--safe-t);}
  #cutin.show{display:flex; opacity:1; transition:opacity .45s ease}
  #cutin.fadeout{opacity:0}
  #cutinText{font-size:clamp(24px, 8vmin, 64px); letter-spacing:.12em; line-height:1.2; padding:0 .2em}

  /* INTRO/라벨/글자박스 UI */
  .introHeader{ text-align:center; font-size:clamp(14px,2.4vmin,18px); letter-spacing:.12em; margin-bottom:10px; color:#fff; opacity:.9; }
  .introCard{ margin:0 auto; max-width:min(86vw, 980px); background:transparent; border:none; padding:6px 8px; }
  .introLine{ margin:8px 0; }
  .introChar{ display:inline-block; background:#000; color:#fff; padding:2px 5px; margin:2px 1px; box-shadow:0 0 0 1px #333 inset; }

  /* ====== GAME ====== */
  #gameOverlay{ position:fixed; inset:0; z-index:300; display:none; background:rgba(0,0,0,.8);
    font-family:"Courier New",monospace; color:#fff; padding-bottom:var(--safe-b); padding-top:var(--safe-t);}
  #gameUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    display:flex; flex-direction:column; align-items:center; gap:10px; width:min(96vw, 1100px); }
  #gameHeader{ width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px; }
  #gameCanvas{ width:100%; height:min(60vh, calc(var(--appH)*0.6)); background:#000; image-rendering: pixelated; border:1px solid #444 }
  #gameBtns{ display:flex; gap:6px; align-items:center }
  #mapGrid{ display:grid; grid-template-columns:repeat(6,minmax(0,1fr)); gap:6px; width:100%; }
  .stageBtn{ border:1px solid #444; background:#000; color:#fff; padding:8px 0; text-align:center; cursor:pointer; font-size:var(--fs-small) }
  .stageBtn.done{ border-color:#0f0; color:#0f0 }
  .stageBtn.active{ border-color:#fff }
  #hud{ display:flex; gap:12px; align-items:center; opacity:.85; font-size:var(--fs-small) }

  /* 모바일 DPAD */
  #dpad{ position:absolute; left:calc(var(--frame) + var(--safe-l)); bottom:calc(var(--frame) + 64px + var(--safe-b)); z-index:320;
    display:grid; grid-template-columns:repeat(3,48px); grid-template-rows:repeat(3,48px); gap:6px; }
  .dkey{ width:48px; height:48px; border:1px solid #444; display:flex; align-items:center; justify-content:center; color:#fff; background:#000; opacity:.7; user-select:none; }
  .dkey:active{ opacity:1 }

  /* ====== DOCUMENT ====== */
  #docOverlay{ position:fixed; inset:0; z-index:310; display:none; background:rgba(0,0,0,.8);
    font-family:"Courier New",monospace; color:#fff; padding-bottom:var(--safe-b); padding-top:var(--safe-t);}
  #docUI{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(96vw,1100px); display:flex; flex-direction:column; gap:10px; }
  #docHeader{ display:flex; justify-content:space-between; align-items:center; }
  #docGrid{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; }
  .docBtn{ border:1px solid #444; background:#000; color:#fff; padding:12px; text-align:center; cursor:pointer; font-size:var(--fs-small) }
  .docPane{ border:1px solid #444; padding:12px; max-height:50vh; overflow:auto; background:#000; }
  .docTitle{ font-size:var(--fs-strong); margin-bottom:8px; }
</style>
</head>
<body>
  <canvas id="view"></canvas>
  <div class="frameBox" aria-hidden="true"></div>

  <!-- 기본 컨트롤 -->
  <div class="controls">
    <button class="uiBtn small" id="zoomOut">–</button>
    <div class="readout"><span id="zoomVal">1.0×</span></div>
    <button class="uiBtn small" id="zoomIn">+</button>
  </div>
  <button id="captureBtn" class="uiBtn small btn-capture">CAPTURE</button>

  <!-- 상단 런처 -->
  <button id="docLauncher" class="uiBtn small">DOCUMENT</button>
  <button id="mapLauncher" class="uiBtn small">MAP</button>

  <!-- 메인 오버레이 -->
  <div id="overlay" class="fade" style="display:flex">
    <div id="overlayContent" class="fade" style="text-align:center">
      <button id="permGateBtn" class="uiBtn" style="width:min(80vw,420px)">
        화면을 탭하여 카메라·동작(센서)·오디오를 허용해주세요
      </button>
      <div class="tip">권한 허용 후 WELCOME 화면이 나타납니다.</div>
    </div>
  </div>

  <!-- 컷인/굿나잇 -->
  <div id="goodnight" style="display:none">GOOD NIGHT, HAVE A NICE DREAM</div>
  <div id="cutin"><div id="cutinText"></div></div>

  <!-- ====== GAME OVERLAY ====== -->
  <div id="gameOverlay">
    <div id="gameUI">
      <div id="gameHeader">
        <div id="hud">
          <span>STAGE: <span id="hudStage">1</span>/12</span>
          <span>DEATHS: <span id="hudDeaths">0</span></span>
          <span>TIME: <span id="hudTime">0.0</span>s</span>
        </div>
        <div id="gameBtns">
          <button id="btnMap" class="uiBtn small">MAP</button>
          <button id="btnExitGame" class="uiBtn small">EXIT</button>
        </div>
      </div>
      <canvas id="gameCanvas" width="640" height="400"></canvas>
      <div id="mapGrid"></div>
    </div>
    <div id="dpad">
      <div></div><div class="dkey" data-dy="-1">↑</div><div></div>
      <div class="dkey" data-dx="-1">←</div><div class="dkey" data-dy="1">↓</div><div class="dkey" data-dx="1">→</div>
      <div></div><div></div><div></div>
    </div>
  </div>

  <!-- ====== DOCUMENT OVERLAY ====== -->
  <div id="docOverlay">
    <div id="docUI">
      <div id="docHeader">
        <div class="readout">DOCUMENTS</div>
        <div><button id="btnExitDoc" class="uiBtn small">EXIT</button></div>
      </div>
      <div id="docGrid"></div>
      <div id="docPane" class="docPane" style="display:none">
        <div class="docTitle" id="docTitle">Document</div>
        <div id="docBody">준비중입니다.</div>
      </div>
    </div>
  </div>

<script>
(async ()=>{
  /* ===== 동적 manifest (홈화면 제목) ===== */
  (function injectManifest(){
    const manifest = {"name":"Dialogue into Silence","short_name":"Dialogue into Silence","display":"standalone","start_url":"./","background_color":"#000","theme_color":"#000","icons":[]};
    const url = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  /* ===== 실제 가시 높이 적용 ===== */
  function setAppHeight(){ document.documentElement.style.setProperty('--appH', window.innerHeight + 'px'); }
  setAppHeight();
  addEventListener('resize', setAppHeight, {passive:true});
  addEventListener('orientationchange', ()=>setTimeout(setAppHeight, 120), {passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(setAppHeight, 50)); }

  /* ========= 유틸 ========= */
  const qs=(s)=>document.querySelector(s);
  const qsa=(s)=>Array.from(document.querySelectorAll(s));
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const WANT_MIC=true;
  const IS_ANDROID=/Android|Linux/i.test(navigator.userAgent)&&!/like Android/i.test(navigator.userAgent);

  /* ========= 오디오 ========= */
  let audioCtx=null, mixBus, sfxBus, reverbNode, wetBus, dryBus, master, panNode, micGain;
  function makeImpulse(ctx,seconds=2,decay=3){const rate=ctx.sampleRate,len=(rate*seconds)|0,buf=ctx.createBuffer(2,len,rate);
    for(let ch=0;ch<2;ch++){const d=buf.getChannelData(ch);for(let i=0;i<len;i++){const t=i/len;d[i]=(Math.random()*2-1)*Math.pow(1-t,decay);}}return buf;}
  function initAudio(){ if(audioCtx) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    mixBus=audioCtx.createGain(); sfxBus=audioCtx.createGain(); wetBus=audioCtx.createGain(); dryBus=audioCtx.createGain(); master=audioCtx.createGain();
    sfxBus.gain.value=0.8; dryBus.gain.value=0.55; wetBus.gain.value=0.55;
    reverbNode=audioCtx.createConvolver(); reverbNode.buffer=makeImpulse(audioCtx);
    panNode=audioCtx.createStereoPanner(); micGain=audioCtx.createGain(); micGain.gain.value=1.0;
    mixBus.connect(dryBus); mixBus.connect(reverbNode); reverbNode.connect(wetBus);
    dryBus.connect(master); wetBus.connect(master); master.connect(audioCtx.destination); sfxBus.connect(mixBus);
  }
  function resumeAudio(){ try{ initAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); }catch{} }
  function playSfx(freq=180,dur=0.16){ try{ resumeAudio(); const t=audioCtx.currentTime; const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='square'; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.6,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.connect(g).connect(sfxBus); o.start(t); o.stop(t+dur+0.02);}catch{} }
  const sfxClick=()=>playSfx(170,0.14), sfxAppear=()=>playSfx(140,0.22), sfxConfirm=()=>playSfx(200,0.18);

  // 마이크
  let micStream=null;
  async function startMic(){ if(micStream) return;
    try{ micStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false,channelCount:1,sampleRate:48000},video:false});
      resumeAudio(); const source=audioCtx.createMediaStreamSource(micStream); const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=80;
      source.connect(hp).connect(micGain).connect(panNode).connect(mixBus);
    }catch(e){ console.warn('Mic denied/failed',e); }
  }

  /* ========= 센서 → 패닝 ========= */
  let lastMotion={x:0,y:0};
  function updateAudioFromSensors(ori,mot){ const gamma=(ori&&typeof ori.gamma==='number')?ori.gamma:(mot?(mot.x*9):0);
    const beta=(ori&&typeof ori.beta==='number')?ori.beta:(mot?(mot.y*9):0);
    const pan=clamp(gamma/45,-1,1), vol=clamp(0.35+Math.abs(beta)/90*1.25,0.35,1.6);
    try{ panNode?.pan?.setTargetAtTime(pan,audioCtx.currentTime,0.03); micGain?.gain?.setTargetAtTime(vol,audioCtx.currentTime,0.03);}catch{} }
  async function requestMotionPermissions(){
    const needsIOS=typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function';
    try{
      if(needsIOS){
        const r1=await DeviceOrientationEvent.requestPermission(); let r2='granted';
        if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){ r2=await DeviceMotionEvent.requestPermission(); }
        if(r1!=='granted'||r2!=='granted') return false;
      }
    }catch{}
    addEventListener('deviceorientation', (e)=>{ updateAudioFromSensors(e,lastMotion); }, {passive:true});
    addEventListener('devicemotion', (e)=>{ const g=e.accelerationIncludingGravity||{}; lastMotion.x=+g.x||0; lastMotion.y=+g.y||0; updateAudioFromSensors(null,lastMotion); }, {passive:true});
    return true;
  }

  /* ========= 카메라 ========= */
  const view=qs('#view'); const vctx=view.getContext('2d',{alpha:false});
  const PROC_SCALE=0.9, TRAIL_ALPHA=0.12, GLOBAL_ALPHA=0.7;
  let ZOOM=1.0, ZOOM_MIN=0.35, ZOOM_MAX=3.0, ZOOM_STEP=0.05;
  const zoomVal=qs('#zoomVal'); const updateZoom=()=>zoomVal.textContent=ZOOM.toFixed(1)+'×';
  qs('#zoomIn').addEventListener('click', ()=>{ZOOM=clamp(ZOOM+ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom();sfxClick();});
  qs('#zoomOut').addEventListener('click', ()=>{ZOOM=clamp(ZOOM-ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom();sfxClick();});
  updateZoom();

  const camVideo=document.createElement('video'); camVideo.autoplay=true; camVideo.playsInline=true; camVideo.muted=true;
  const proc=document.createElement('canvas'); const pctx=proc.getContext('2d',{willReadFrequently:true});
  let camStream=null;

  async function attachCamera(){
    try{
      if(camStream) return;
      camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:false});
      camVideo.srcObject=camStream; await camVideo.play().catch(()=>{});
    }catch(e){ console.warn('camera failed', e); }
  }

  function resizeAll(){
    const dpr=window.devicePixelRatio||1;
    const w=window.innerWidth, h=window.innerHeight;
    view.width=w*dpr; view.height=h*dpr; vctx.setTransform(dpr,0,0,dpr,0,0);
    const scale=(matchMedia('(orientation: landscape)').matches)? PROC_SCALE*0.9 : PROC_SCALE;
    proc.width=Math.floor(w*scale); proc.height=Math.floor(h*scale);
  }
  resizeAll();
  addEventListener('resize',()=>setTimeout(resizeAll,50),{passive:true});
  addEventListener('orientationchange',()=>setTimeout(resizeAll,120),{passive:true});
  if (window.visualViewport){ visualViewport.addEventListener('resize', ()=>setTimeout(resizeAll,50)); }

  function loop(){
    requestAnimationFrame(loop);
    const dpr=window.devicePixelRatio||1;
    const W=view.width/dpr,H=view.height/dpr,PW=proc.width,PH=proc.height;
    pctx.globalCompositeOperation="source-over";
    pctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`; pctx.fillRect(0,0,PW,PH);
    if(camVideo.readyState>=2){
      const vw=camVideo.videoWidth,vh=camVideo.videoHeight;
      if(vw&&vh){
        // 화면을 꽉 채우는 cover (여백 없음, 필요시 일부 크롭)
        const cover=Math.max(PW/vw, PH/vh), sc=cover*ZOOM;
        const dw=vw*sc,dh=vh*sc,dx=(PW-dw)/2,dy=(PH-dh)/2;
        pctx.globalAlpha=GLOBAL_ALPHA; pctx.drawImage(camVideo,dx,dy,dw,dh);
        pctx.globalAlpha=1.0;
        const frame=pctx.getImageData(0,0,PW,PH),d=frame.data;
        for(let i=0;i<d.length;i+=4){const g=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0; d[i]=d[i+1]=d[i+2]=g;}
        pctx.putImageData(frame,0,0);
      }
    }
    vctx.drawImage(proc,0,0,W,H);
  }
  loop();

  /* ========= UI/시퀀스 ========= */
  const overlayEl=qs('#overlay'), overlayContentEl=qs('#overlayContent');
  const goodnight=qs('#goodnight'), cutin=qs('#cutin'), cutinText=qs('#cutinText');
  const permGateBtn=qs('#permGateBtn');

  const lockTargets=[qs('#mapLauncher'),qs('#docLauncher'),qs('#captureBtn'),qs('#zoomIn'),qs('#zoomOut')];
  const setGlobalUIEnabled=(on)=>lockTargets.forEach(b=>b&&(b.disabled=!on));

  const setOverlayDim=(on)=>overlayEl.style.background=on?'rgba(0,0,0,.72)':'transparent';
  const setOverlayClickable=(on)=>overlayEl.style.pointerEvents=on?'auto':'none';

  const spanChars=(t)=>[...t].map(ch=>`<span class="introChar">${ch===' ' ? '&nbsp;' : ch.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`).join('');
  const introParagraphHTML=(lines)=>lines.map(s=>`<div class="introLine">${spanChars(s)}</div>`).join('');

  function show(html,next){
    overlayEl.style.display='flex'; overlayEl.classList.remove('hidden'); overlayContentEl.classList.add('hidden');
    setOverlayDim(true); setOverlayClickable(true);
    setTimeout(()=>{ overlayContentEl.innerHTML=html; overlayContentEl.classList.remove('hidden'); next&&next(); },120);
  }
  function hide(next){ overlayEl.classList.add('hidden'); setTimeout(()=>{ overlayEl.style.display='none'; next&&next(); },420); }

  function showWelcome(){
    show(`
      <div class="introCard">
        <div class="introHeader">SHB,KCW,KJS,JMJ,KHJ,JYS</div>
        <div class="introLine">${spanChars('Welcome to Dialogue into Silence')}</div>
        <div style="text-align:center;margin-top:12px">
          <button id="welcomeGo" class="uiBtn">PRESS HERE TO SLEEP</button>
        </div>
      </div>
    `, ()=>{
      setGlobalUIEnabled(false);
      qs('#welcomeGo').addEventListener('click', ()=>{ sfxConfirm(); mountPressToSleep(); }, {passive:true});
    });
  }

  function showGoodNight(next){ goodnight.textContent='GOOD NIGHT, HAVE A NICE DREAM'; goodnight.style.display='block'; sfxAppear(); setTimeout(()=>{ goodnight.style.display='none'; next&&next(); },1600); }
  function showCutInLabel(label,holdMs=1600,after){ cutinText.textContent=label; cutin.classList.remove('fadeout'); cutin.classList.add('show'); sfxAppear(); setTimeout(()=>{ cutin.classList.add('fadeout'); setTimeout(()=>{ cutin.classList.remove('show','fadeout'); cutin.style.display='none'; after&&after(); },300); },holdMs); }

  function showNarrativeSequence(done){
    const narrative=[ '자욱한 안개가 너를 맞이했다. 거대한 비석을 너는 마주했다. 거대한 비석들의 웅얼거림을 너는 들을 수 있었다.',
      '어디선가 잔잔한 종소리가 들려온다. 어디선가 께름칙한 울음소리가 들려온다. 어디선가 아이들의 웃음소리가 들려온다.',
      '너는 비석 사이를 거닐고 있다. 너를 스쳐 지나가며 웅얼거리는 소리에 귀를 기울인다.',
      '비석마다 다른 목소리가 담겨 있다. 어떤 것은 꿈을 이야기하고, 어떤 것은 기억을 읊고, 또 어떤 것은 아직 말하지 못한 언어로 중얼거린다.',
      '너는 발걸음을 늦춘다. 너는 생각한다. 이곳엔 분명 누군가가 존재하고 있었다.',
      '그리고, 지금도 여전히 그들의 호흡은 돌 틈에 스며 있고, 그들의 그림자는 안개 속에 머물며, 그들의 말하지 못한 시간은 너의 귀끝을 잡아당긴다.',
      '너는 발걸음을 멈춘다. 왜인지 이곳에 머물러야 한다는 느낌을 받는다.',
      '너는 그곳으로 발을 옮긴다. 그곳엔, 이곳에 존재했던 누군가의 ‘목소리’가 있다.',
      '너는 비석에 등을 기대고 앉는다. 그리고 서서히, 그것의 진동을 느낀다.' ];
    setOverlayDim(false); setOverlayClickable(false);
    overlayEl.style.display='flex'; overlayEl.classList.remove('hidden');
    let idx=0; (function next(){
      if(idx>=narrative.length){ hide(done); return; }
      overlayContentEl.classList.add('hidden');
      setTimeout(()=>{
        overlayContentEl.innerHTML=`<div class="introCard"><div class="introLine">${spanChars(narrative[idx++])}</div></div>`;
        overlayContentEl.classList.remove('hidden'); sfxAppear(); setTimeout(next,5000);
      },120);
    })();
  }

  function firstSilenceFlow(){
    showCutInLabel('THE FIRST SILENCE',1600,()=>{
      setGlobalUIEnabled(true);
      setTimeout(()=>{ showNarrativeSequence(()=>{}); },5000);
    });
  }

  function mountPressToSleep(){
    const introLines=[
      '이곳은 이미 ‘너’가 죽어버린, ‘그것’들의 세계다.',
      '곧 당신은 30분간의 잠에 들며, 무의식 속 여정을 시작한다.',
      '그 여정 속에서 당신은 사라져간 ‘너’를 마주하게 된다.',
      '이제 당신에게는 네 단계의 미션이 주어진다.',
      '당신은 미션에 따라 헤드폰으로 들려오는 ‘너’들의 목소리에 귀 기울이며, 휴대폰을 통해 잃어버린 ‘너’를 포착할 수 있다.'
    ];
    show(`<div class="introCard"><div class="introHeader">INTRODUCTION</div>${introParagraphHTML(introLines)}<div class="introLine" id="countdown">${spanChars('The door will close in ')}<span id="countNum" class="introChar">55</span>${spanChars(' seconds.')}</div></div>`, ()=>{
      setGlobalUIEnabled(false);
      let count=55; const numEl=qs('#countNum');
      const timer=setInterval(()=>{ count--; if(count>=0&&numEl) numEl.textContent=count;
        if(count<=0){ clearInterval(timer); hide(()=>{ setGlobalUIEnabled(true); showGoodNight(firstSilenceFlow); }); } },1000);
      sfxAppear();
    });
  }

  /* ===== 안드로이드 전체화면 + 방향 락 ===== */
  async function enterFullscreenIfPossible(desired='portrait'){
    try{
      const el=document.documentElement;
      if(!document.fullscreenElement && document.fullscreenEnabled && el.requestFullscreen){
        await el.requestFullscreen({navigationUI:'hide'}).catch(()=>{});
      }
      if(screen.orientation && screen.orientation.lock){
        const mode = desired === 'landscape' ? 'landscape' : 'portrait';
        screen.orientation.lock(mode).catch(()=>{});
      }
    }catch{}
  }

  /* ===== 퍼미션 게이트 ===== */
  let gateBusy=false, gateDone=false;
  async function runPermissionGate(){
    if(gateBusy||gateDone) return; gateBusy=true;
    try{
      sfxClick(); resumeAudio();
      await requestMotionPermissions();
      await attachCamera();
      if(WANT_MIC) await startMic();
      if(IS_ANDROID){
        const desired = matchMedia('(orientation: landscape)').matches ? 'landscape' : 'portrait';
        await enterFullscreenIfPossible(desired);
      }
      showWelcome(); gateDone=true;
    }catch(e){ console.warn('gate error',e); }
    finally{ gateBusy=false; }
  }

  // 세이프티넷: 첫 사용자 제스처면 무엇이든 게이트 실행 (중복 방지)
  ['pointerdown','touchstart','click','keydown'].forEach(evt=>{
    window.addEventListener(evt,()=>{ if(!gateDone){ runPermissionGate(); } }, {once:true, capture:true, passive:true});
  });

  // 버튼/배경에서도 정상 동작
  ['pointerdown','touchstart','click'].forEach(evt=>{
    qs('#permGateBtn').addEventListener(evt,(e)=>{ e.preventDefault(); runPermissionGate(); },{passive:false});
    overlayEl.addEventListener(evt,(e)=>{ if(!gateDone && e.target===overlayEl){ e.preventDefault(); runPermissionGate(); } },{passive:false});
  });

  // 가로로 돌리면 안드는 자동 재요청
  addEventListener('orientationchange', ()=>{
    if(IS_ANDROID && matchMedia('(orientation: landscape)').matches){
      setTimeout(()=>enterFullscreenIfPossible('landscape'), 150);
    }
  }, {passive:true});

  /* ===== GAME / DOC (필요 최소만 유지) ===== */
  const gameOverlay=qs('#gameOverlay'), gameCanvas=qs('#gameCanvas'), g=gameCanvas.getContext('2d');
  const mapLauncher=qs('#mapLauncher'), btnExitGame=qs('#btnExitGame'), btnMap=qs('#btnMap'), mapGrid=qs('#mapGrid');

  const RAW_STAGES=[`00000000000000000000
0S111000000111111110
01000101111000000110
01110101100011110110
01000101101010000110
01110101101011110110
01000100001010000110
01110111111011110110
01000000000010000110
01111111111111110E10
00000000000000000000`].map(s=>s.trim().split('\n')); // 데모 1스테이지만 유지 (필요시 확장)

  function parseStage(rows){const H=rows.length,W=rows[0].length,grid=[];let start={x:1,y:1},exit={x:W-2,y:H-2};
    for(let y=0;y<H;y++){const row=[];for(let x=0;x<W;x++){const ch=rows[y][x];if(ch==='S'){start={x,y};row.push(1);}else if(ch==='E'){exit={x,y};row.push(1);}else row.push(ch==='1'?1:0);}grid.push(row);}return {grid,W,H,start,exit};}
  const stageState=parseStage(RAW_STAGES[0]);
  const player={x:stageState.start.x,y:stageState.start.y,color:'#0ff'};
  function canMove(grid,x,y){return !(y<0||y>=grid.length||x<0||x>=grid[0].length)&&grid[y][x]===1;}
  function drawStage(grid,W,H,exitPos){const VIEW_W=gameCanvas.width,VIEW_H=gameCanvas.height;const g=gameCanvas.getContext('2d');g.clearRect(0,0,VIEW_W,VIEW_H);
    const sx=Math.floor(VIEW_W/W),sy=Math.floor(VIEW_H/H),t=Math.max(6,Math.min(sx,sy));const offX=Math.floor((VIEW_W-W*t)/2),offY=Math.floor((VIEW_H-H*t)/2);
    for(let y=0;y<H;y++){for(let x=0;x<W;x++){g.fillStyle=grid[y][x]===0?'#111':'#000';g.fillRect(offX+x*t,offY+y*t,t,t);}}
    g.fillStyle='#f33';g.fillRect(offX+exitPos.x*t,offY+exitPos.y*t,t,t);g.fillStyle=player.color;g.fillRect(offX+player.x*t,offY+player.y*t,t,t);}
  drawStage(stageState.grid,stageState.W,stageState.H,stageState.exit);

  function openGame(){gameOverlay.style.display='block';}
  function closeGame(){gameOverlay.style.display='none';}
  mapLauncher.addEventListener('click', openGame, {passive:true});
  btnExitGame.addEventListener('click', closeGame, {passive:true});
  btnMap?.addEventListener('click', ()=>{}, {passive:true});

  /* ===== DOC ===== */
  const docOverlay=qs('#docOverlay'), docGrid=qs('#docGrid'), docPane=qs('#docPane'), docTitle=qs('#docTitle'), docBody=qs('#docBody');
  const docLauncher=qs('#docLauncher'), btnExitDoc=qs('#btnExitDoc');
  function openDoc(){docOverlay.style.display='block';} function closeDoc(){docOverlay.style.display='none';}
  docLauncher.addEventListener('click', openDoc, {passive:true}); btnExitDoc.addEventListener('click', closeDoc, {passive:true});
  function buildDocGrid(){docGrid.innerHTML=''; for(let i=1;i<=8;i++){const b=document.createElement('button'); b.className='docBtn'; b.textContent=`Document ${i}`; b.onclick=()=>{ docTitle.textContent=`Document ${i}`; docBody.innerHTML='준비중입니다.'; docPane.style.display='block';}; docGrid.appendChild(b);} } buildDocGrid();

  /* ===== 초기 표시 ===== */
  overlayEl.style.display='flex';
})();
</script>
</body>
</html>
