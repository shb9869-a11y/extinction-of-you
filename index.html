<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>Camera â€“ BW + Afterimage</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Camera Trail">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="app.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #view{width:100%;height:100%;display:block}
  .controls{
    position:fixed;right:12px;bottom:12px;z-index:30;
    display:flex;gap:8px;align-items:center;
    background:rgba(0,0,0,.45);padding:8px;border-radius:12px;
    font:14px/1 system-ui,-apple-system,sans-serif;color:#fff
  }
  .btn{border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);
       color:#fff;padding:6px 10px;border-radius:8px;font-weight:700}
  .readout{min-width:64px;text-align:center;opacity:.9}
  #hint{
    position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
    background:rgba(0,0,0,.7);color:#fff;padding:10px 16px;border-radius:10px;
    font:14px/1.4 system-ui,-apple-system,sans-serif;z-index:40;
    max-width:90%;text-align:center;
  }
</style>
</head>
<body>
  <canvas id="view"></canvas>

  <div class="controls">
    <button class="btn" id="zoomOut">â€“</button>
    <div class="readout"><span id="zoomVal">1.2Ã—</span></div>
    <button class="btn" id="zoomIn">+</button>
  </div>

  <!-- ì•ˆë‚´ë¬¸ -->
  <div id="hint">ğŸ“± iOS ì‚¬íŒŒë¦¬ì—ì„œ <b>ê³µìœ  ë²„íŠ¼ â†’ í™ˆ í™”ë©´ì— ì¶”ê°€</b>ë¡œ ì‹¤í–‰í•˜ë©´ ì£¼ì†Œì°½ ì—†ëŠ” ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ì“¸ ìˆ˜ ìˆì–´ìš”.</div>

<script>
(async ()=>{
  const hint = document.getElementById('hint');

  // âœ… ì•±ëª¨ë“œ(í™ˆí™”ë©´ ì‹¤í–‰) ê°ì§€í•´ì„œ ì•ˆë‚´ë¬¸ ìˆ¨ê¸°ê¸°
  const isStandalone = window.navigator.standalone === true 
                    || window.matchMedia('(display-mode: standalone)').matches;
  if (isStandalone) {
    hint.style.display = 'none';
  }

  const view=document.getElementById('view');
  const vctx=view.getContext('2d',{alpha:false});
  const zoomVal=document.getElementById('zoomVal');
  const btnIn=document.getElementById('zoomIn');
  const btnOut=document.getElementById('zoomOut');

  const PROC_SCALE=0.6;
  const TRAIL_ALPHA=0.0005;   // ì”ì˜ ìµœëŒ€ë¡œ ì˜¤ë˜ ë‚¨ìŒ
  const FRAME_MARGIN=40, FRAME_COLOR="#fff", FRAME_WIDTH=0.5;

  let ZOOM=1.2;
  const ZOOM_MIN=0.5, ZOOM_MAX=3.0, ZOOM_STEP=0.1;

  const camVideo=document.createElement('video');
  camVideo.autoplay=true; camVideo.playsInline=true; camVideo.muted=true;

  const proc=document.createElement('canvas');
  const pctx=proc.getContext('2d',{alpha:false,willReadFrequently:true});

  function resizeAll(){
    const dpr=window.devicePixelRatio||1;
    const w=window.innerWidth, h=window.innerHeight;
    view.width=w*dpr; view.height=h*dpr;
    vctx.setTransform(dpr,0,0,dpr,0,0);
    proc.width=Math.floor(w*PROC_SCALE);
    proc.height=Math.floor(h*PROC_SCALE);
  }
  resizeAll();
  addEventListener('resize',()=>setTimeout(resizeAll,50));
  addEventListener('orientationchange',()=>setTimeout(resizeAll,120));

  async function attachCamera(){
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    camVideo.srcObject=s; await camVideo.play();
  }

  function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
  function updateZoom(){zoomVal.textContent=ZOOM.toFixed(1)+'Ã—'}
  btnIn.onclick=()=>{ZOOM=clamp(ZOOM+ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom()};
  btnOut.onclick=()=>{ZOOM=clamp(ZOOM-ZOOM_STEP,ZOOM_MIN,ZOOM_MAX);updateZoom()};
  updateZoom();

  function loop(){
    requestAnimationFrame(loop);
    const W=view.width/(window.devicePixelRatio||1);
    const H=view.height/(window.devicePixelRatio||1);
    const PW=proc.width, PH=proc.height;

    pctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`;
    pctx.fillRect(0,0,PW,PH);

    if(camVideo.readyState>=2){
      const vw=camVideo.videoWidth, vh=camVideo.videoHeight;
      if(vw && vh){
        const base=Math.max(PW/vw, PH/vh);
        const sc=base*ZOOM;
        const dw=vw*sc, dh=vh*sc;
        const dx=(PW-dw)/2, dy=(PH-dh)/2;
        pctx.drawImage(camVideo,dx,dy,dw,dh);

        const frame=pctx.getImageData(0,0,PW,PH);
        const d=frame.data;
        for(let i=0;i<d.length;i+=4){
          const gray=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2])|0;
          d[i]=d[i+1]=d[i+2]=gray;
        }
        pctx.putImageData(frame,0,0);
      }
    }

    vctx.drawImage(proc,0,0,W,H);

    vctx.strokeStyle=FRAME_COLOR; vctx.lineWidth=FRAME_WIDTH;
    vctx.strokeRect(FRAME_MARGIN,FRAME_MARGIN,W-2*FRAME_MARGIN,H-2*FRAME_MARGIN);
  }

  await attachCamera();
  loop();
})();
</script>
</body>
</html>
